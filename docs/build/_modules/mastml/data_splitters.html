

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mastml.data_splitters &mdash; MAterials Simulation Toolkit for Machine Learning (MAST-ML) 2.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> MAterials Simulation Toolkit for Machine Learning (MAST-ML)
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../00_acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../0_4_majorchanges.html">MAST-ML version 3.x</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../0_4_majorchanges.html#new-changes-to-mast-ml">New changes to MAST-ML</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../0_installation.html">Installing MAST-ML</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../0_1_hardware_data_requirements.html">Hardware and Data Requirements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../0_1_hardware_data_requirements.html#hardware">Hardware</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../0_1_hardware_data_requirements.html#data">Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../0_1_terminal_installation.html">Terminal installation (Linux or linux-like terminal environment e.g. Mac)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../0_1_terminal_installation.html#install-python3">Install Python3</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../0_1_terminal_installation.html#create-a-conda-environment-if-using-anaconda">Create a conda environment (if using Anaconda)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../0_1_terminal_installation.html#create-a-virtualenv-environment-if-not-using-anaconda">Create a virtualenv environment (if not using Anaconda)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../0_1_terminal_installation.html#install-the-mast-ml-package-via-pypi">Install the MAST-ML package via PyPi</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../0_1_terminal_installation.html#install-the-mast-ml-package-via-git">Install the MAST-ML package via Git</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../0_1_terminal_installation.html#set-up-juptyer-notebooks">Set up Juptyer notebooks</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../0_1_terminal_installation.html#imports-that-dont-work">Imports that don’t work</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../0_2_windows_installation.html">Windows installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../0_2_windows_installation.html#install-python3">Install Python3</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../0_2_windows_installation.html#create-a-conda-environment">Create a conda environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../0_2_windows_installation.html#set-up-the-spyder-ide-and-jupyter-notebooks">Set up the Spyder IDE and Jupyter notebooks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../0_2_windows_installation.html#install-the-mast-ml-package">Install the MAST-ML package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../0_2_windows_installation.html#imports-that-dont-work">Imports that don’t work</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../0_2_windows_installation.html#windows-10-install-step-by-step-guide-credit-joe-kern">Windows 10 install: step-by-step guide (credit Joe Kern)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../0_3_startup.html">Getting Started with MAST-ML</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../0_3_startup.html#installing-mast-ml">Installing MAST-ML</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../0_3_startup.html#performing-your-first-mast-ml-run">Performing your first MAST-ML run</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../0_5_tutorials.html">Overview of MAST-ML tutorials and examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../0_5_tutorials.html#mast-ml-tutorials">MAST-ML tutorials</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../1_data_cleaning.html">Code Documentation: Data Cleaning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_data_cleaning.html#module-mastml.data_cleaning">mastml.data_cleaning Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../1_data_cleaning.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_cleaning.DataCleaning.html">DataCleaning</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_cleaning.DataUtilities.html">DataUtilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_cleaning.PPCA.html">PPCA</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../1_data_cleaning.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../2_data_splitters.html">Code Documentation: Data Splitters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../2_data_splitters.html#module-mastml.data_splitters">mastml.data_splitters Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../2_data_splitters.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.BaseSplitter.html">BaseSplitter</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.Bootstrap.html">Bootstrap</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.JustEachGroup.html">JustEachGroup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.LeaveCloseCompositionsOut.html">LeaveCloseCompositionsOut</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.LeaveOutPercent.html">LeaveOutPercent</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.LeaveOutTwinCV.html">LeaveOutTwinCV</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.NoSplit.html">NoSplit</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.SklearnDataSplitter.html">SklearnDataSplitter</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../2_data_splitters.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../3_datasets.html">Code Documentation: Datasets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../3_datasets.html#module-mastml.datasets">mastml.datasets Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../3_datasets.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.datasets.FigshareDatasets.html">FigshareDatasets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.datasets.FoundryDatasets.html">FoundryDatasets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.datasets.LocalDatasets.html">LocalDatasets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.datasets.MatminerDatasets.html">MatminerDatasets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.datasets.SklearnDatasets.html">SklearnDatasets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../3_datasets.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../4_error_analysis.html">Code Documentation: Error Analysis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../4_error_analysis.html#module-mastml.error_analysis">mastml.error_analysis Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../4_error_analysis.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.error_analysis.CorrectionFactors.html">CorrectionFactors</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.error_analysis.ErrorUtils.html">ErrorUtils</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../4_error_analysis.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../5_feature_generators.html">Code Documentation: Feature Generators</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../5_feature_generators.html#module-mastml.feature_generators">mastml.feature_generators Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../5_feature_generators.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.BaseGenerator.html">BaseGenerator</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.DataframeUtilities.html">DataframeUtilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.ElementalFeatureGenerator.html">ElementalFeatureGenerator</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.MaterialsProjectFeatureGenerator.html">MaterialsProjectFeatureGenerator</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.MatminerFeatureGenerator.html">MatminerFeatureGenerator</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.OneHotElementEncoder.html">OneHotElementEncoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.OneHotGroupGenerator.html">OneHotGroupGenerator</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.PolynomialFeatureGenerator.html">PolynomialFeatureGenerator</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../5_feature_generators.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../6_feature_selectors.html">Code Documentation: Feature Selectors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../6_feature_selectors.html#module-mastml.feature_selectors">mastml.feature_selectors Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../6_feature_selectors.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_selectors.BaseSelector.html">BaseSelector</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_selectors.EnsembleModelFeatureSelector.html">EnsembleModelFeatureSelector</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_selectors.MASTMLFeatureSelector.html">MASTMLFeatureSelector</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_selectors.NoSelect.html">NoSelect</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_selectors.PearsonSelector.html">PearsonSelector</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_selectors.SklearnFeatureSelector.html">SklearnFeatureSelector</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../6_feature_selectors.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../7_hyper_opt.html">Code Documentation: Hyperparameter Optimization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../7_hyper_opt.html#module-mastml.hyper_opt">mastml.hyper_opt Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../7_hyper_opt.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.hyper_opt.BayesianSearch.html">BayesianSearch</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.hyper_opt.GridSearch.html">GridSearch</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.hyper_opt.HyperOptUtils.html">HyperOptUtils</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.hyper_opt.RandomizedSearch.html">RandomizedSearch</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../7_hyper_opt.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../8_learning_curve.html">Code Documentation: Learning Curve</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../8_learning_curve.html#module-mastml.learning_curve">mastml.learning_curve Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../8_learning_curve.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.learning_curve.LearningCurve.html">LearningCurve</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../8_learning_curve.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../9_mastml.html">Code Documentation: Mastml</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../9_mastml.html#module-mastml.mastml">mastml.mastml Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../9_mastml.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.mastml.Mastml.html">Mastml</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../9_mastml.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../10_metrics.html">Code Documentation: Metrics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../10_metrics.html#module-mastml.metrics">mastml.metrics Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../10_metrics.html#functions">Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.metrics.r2_score_adjusted.html">r2_score_adjusted</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.metrics.r2_score_fitted.html">r2_score_fitted</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.metrics.r2_score_noint.html">r2_score_noint</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.metrics.rmse_over_stdev.html">rmse_over_stdev</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.metrics.root_mean_squared_error.html">root_mean_squared_error</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../10_metrics.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.metrics.Metrics.html">Metrics</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../10_metrics.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../11_models.html">Code Documentation: Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../11_models.html#module-mastml.models">mastml.models Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../11_models.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.models.EnsembleModel.html">EnsembleModel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.models.SklearnModel.html">SklearnModel</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../11_models.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../12_plots.html">Code Documentation: Plots</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../12_plots.html#module-mastml.plots">mastml.plots Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../12_plots.html#functions">Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.check_dimensions.html">check_dimensions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.get_divisor.html">get_divisor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.make_axis_same.html">make_axis_same</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.make_fig_ax.html">make_fig_ax</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.make_fig_ax_square.html">make_fig_ax_square</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.make_plots.html">make_plots</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.nice_mean.html">nice_mean</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.nice_names.html">nice_names</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.nice_range.html">nice_range</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.nice_std.html">nice_std</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.plot_stats.html">plot_stats</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.recursive_max.html">recursive_max</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.recursive_max_and_min.html">recursive_max_and_min</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.recursive_min.html">recursive_min</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.reset_index.html">reset_index</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.round_down.html">round_down</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.round_up.html">round_up</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.rounder.html">rounder</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.stat_to_string.html">stat_to_string</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.trim_array.html">trim_array</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../12_plots.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.Error.html">Error</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.Histogram.html">Histogram</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.Line.html">Line</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.Scatter.html">Scatter</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../12_plots.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../13_preprocessing.html">Code Documentation: Preprocessing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../13_preprocessing.html#module-mastml.preprocessing">mastml.preprocessing Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../13_preprocessing.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.preprocessing.BasePreprocessor.html">BasePreprocessor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.preprocessing.MeanStdevScaler.html">MeanStdevScaler</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.preprocessing.NoPreprocessor.html">NoPreprocessor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.preprocessing.SklearnPreprocessor.html">SklearnPreprocessor</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../13_preprocessing.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MAterials Simulation Toolkit for Machine Learning (MAST-ML)</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>mastml.data_splitters</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mastml.data_splitters</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains a collection of methods to split data into different types of train/test sets. Data splitters</span>
<span class="sd">are the core component to evaluating model performance.</span>

<span class="sd">BaseSplitter:</span>
<span class="sd">    Base class that handles the core MAST-ML data splitting and model evaluation workflow. This class is responsible</span>
<span class="sd">    for looping over provided feature selectors, models, and data splits and training and evaluating the model for each</span>
<span class="sd">    split, then generating the necessary plots and performance statistics. All different splitter types inherit this</span>
<span class="sd">    base class.</span>

<span class="sd">SklearnDataSplitter:</span>
<span class="sd">    Wrapper class to enable MAST-ML workflow compatible use of any data splitter contained in scikit-learn, e.g. KFold,</span>
<span class="sd">    RepeatedKFold, LeaveOneGroupOut, etc.</span>

<span class="sd">NoSplit:</span>
<span class="sd">    Class that doesn&#39;t perform any data split. Equivalent to a &quot;full fit&quot; of the data where all data is used in training.</span>

<span class="sd">JustEachGroup:</span>
<span class="sd">    Class that splits data so each individual group is used as training with all other groups used as testing. Essentially</span>
<span class="sd">    the inverse of LeaveOneGroupOut, this class trains only on one group and predicts the rest, as opposed to training</span>
<span class="sd">    on all but one group and testing on the left-out group.</span>

<span class="sd">LeaveCloseCompositionsOut:</span>
<span class="sd">    Class to split data based on their compositional similiarity. A useful means to separate compositionally similar</span>
<span class="sd">    compounds into the training or testing set, so that similar materials are not contained in both sets.</span>

<span class="sd">LeaveOutPercent:</span>
<span class="sd">    Method to randomly split the data based on fraction of total data points, rather than a designated number of splits.</span>
<span class="sd">    Enables one to do higher than 50% leave out (this is highest leave out possible with KFold where k=2), so can do e.g.</span>
<span class="sd">    leave out 90% data.</span>

<span class="sd">LeaveOutTwinCV:</span>
<span class="sd">    Another method to help separate similar data from the training and testing set. This method makes use of a general</span>
<span class="sd">    distance metric on the provided features, and flags twins as those data points within some provided distance threshold</span>
<span class="sd">    in the feature space.</span>

<span class="sd">Bootstrap:</span>
<span class="sd">    Method to perform bootstrap resampling, i.e. random leave-out with replacement.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">minkowski</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">keras</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Keras is an optional dependency. To use keras, do pip install keras tensorflow&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">matminer.featurizers.composition</span> <span class="kn">import</span> <span class="n">ElementFraction</span>
    <span class="kn">from</span> <span class="nn">pymatgen</span> <span class="kn">import</span> <span class="n">Composition</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;matminer and pymatgen are optional dependencies. To use data splitter methods invoking these packages,&#39;</span>
          <span class="s1">&#39;do pip install matminer pymatgen&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">sklearn.model_selection</span> <span class="k">as</span> <span class="nn">ms</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">check_random_state</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>

<span class="kn">from</span> <span class="nn">mastml.plots</span> <span class="kn">import</span> <span class="n">make_plots</span>
<span class="kn">from</span> <span class="nn">mastml.feature_selectors</span> <span class="kn">import</span> <span class="n">NoSelect</span>
<span class="kn">from</span> <span class="nn">mastml.error_analysis</span> <span class="kn">import</span> <span class="n">ErrorUtils</span>
<span class="kn">from</span> <span class="nn">mastml.metrics</span> <span class="kn">import</span> <span class="n">Metrics</span>
<span class="kn">from</span> <span class="nn">mastml.preprocessing</span> <span class="kn">import</span> <span class="n">NoPreprocessor</span>


<div class="viewcode-block" id="BaseSplitter"><a class="viewcode-back" href="../../api/mastml.data_splitters.BaseSplitter.html#mastml.data_splitters.BaseSplitter">[docs]</a><span class="k">class</span> <span class="nc">BaseSplitter</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">BaseCrossValidator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class functioning as a base splitter with methods for organizing output and evaluating any mastml data splitter</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>

<span class="sd">    Methods:</span>
<span class="sd">        split_asframe: method to perform split into train indices and test indices, but return as dataframes</span>
<span class="sd">            Args:</span>
<span class="sd">                X: (pd.DataFrame), dataframe of X features</span>

<span class="sd">                y: (pd.Series), series of y target data</span>

<span class="sd">                groups: (pd.Series), series of group designations</span>

<span class="sd">            Returns:</span>
<span class="sd">                X_splits: (list), list of dataframes for X splits</span>

<span class="sd">                y_splits: (list), list of dataframes for y splits</span>

<span class="sd">        evaluate: main method to evaluate a sequence of models, selectors, and hyperparameter optimizers, build directories and perform analysis and output plots</span>
<span class="sd">            Args:</span>
<span class="sd">                X: (pd.DataFrame), dataframe of X features</span>

<span class="sd">                y: (pd.Series), series of y target data</span>

<span class="sd">                models: (list), list containing mastml.models instances</span>

<span class="sd">                preprocessor: (mastml.preprocessor), mastml.preprocessor object to normalize the training data in each split.</span>

<span class="sd">                groups: (pd.Series), series of group designations</span>

<span class="sd">                hyperopts: (list), list containing mastml.hyperopt instances. One for each provided model is needed.</span>

<span class="sd">                selectors: (list), list containing mastml.feature_selectors instances</span>

<span class="sd">                metrics: (list), list of metric names to evaluate true vs. pred data in each split</span>

<span class="sd">                plots: (list), list of names denoting which types of plots to make. Valid names are &#39;Scatter&#39;, &#39;Error&#39;, and &#39;Histogram&#39;</span>

<span class="sd">                savepath: (str), string containing main savepath to construct splits for saving output</span>

<span class="sd">                X_extra: (pd.DataFrame), dataframe of extra X data not used in model fitting</span>

<span class="sd">                leaveout_inds: (list), list of arrays containing indices of data to be held out and evaluated using best model from set of train/validation splits</span>

<span class="sd">                best_run_metric: (str), metric name to be used to decide which model performed best. Defaults to first listed metric in metrics.</span>

<span class="sd">                nested_CV: (bool), whether to perform nested cross-validation. The nesting is done using the same splitter object as self.splitter</span>

<span class="sd">                error_method: (str), the type of model error evaluation method to perform. Only applies to certain models. Valid names are &#39;stdev_weak_learners&#39; and &#39;jackknife_after_bootstrap&#39;</span>

<span class="sd">                remove_outlier_learners: (bool), whether to remove weak learners from ensemble models whose predictions are found to be outliers. Default False.</span>

<span class="sd">                recalibrate_errors: (bool), whether to perform the predicted error bar recalibration method of Palmer et al. Default False.</span>

<span class="sd">                verbosity: (int), the output plotting verbosity. Default is 1. Valid choices are 0, 1, 2, and 3.</span>

<span class="sd">            Returns:</span>
<span class="sd">                None</span>

<span class="sd">        _evaluate_split_sets: method to evaluate a set of train/test splits. At the end of the split set, the left-out data (if any) is evaluated using the best model from the train/test splits</span>
<span class="sd">            Args:</span>
<span class="sd">                X_splits: (list), list of dataframes for X splits</span>

<span class="sd">                y_splits: (list), list of dataframes for y splits</span>

<span class="sd">                train_inds: (list), list of arrays of indices denoting the training data</span>

<span class="sd">                test_inds: (list), list of arrays of indices denoting the testing data</span>

<span class="sd">                model: (mastml.models instance), an estimator for fitting data</span>

<span class="sd">                model_name: (str), class name of the model being evaluated</span>

<span class="sd">                selector: (mastml.selector), a feature selector to select features in each split</span>

<span class="sd">                preprocessor: (mastml.preprocessor), mastml.preprocessor object to normalize the training data in each split.</span>

<span class="sd">                X_extra: (pd.DataFrame), dataframe of extra X data not used in model fitting</span>

<span class="sd">                groups: (pd.Series), series of group designations</span>

<span class="sd">                splitdir: (str), string denoting the split path in the save directory</span>

<span class="sd">                hyperopt: (mastml.hyperopt), mastml.hyperopt instance to perform model hyperparameter optimization in each split</span>

<span class="sd">                metrics: (list), list of metric names to evaluate true vs. pred data in each split</span>

<span class="sd">                plots: (list), list of names denoting which types of plots to make. Valid names are &#39;Scatter&#39;, &#39;Error&#39;, and &#39;Histogram&#39;</span>

<span class="sd">                has_model_errors: (bool), whether the model used has error bars (uncertainty quantification)</span>

<span class="sd">                error_method: (str), the type of model error evaluation method to perform. Only applies to certain models. Valid names are &#39;stdev_weak_learners&#39; and &#39;jackknife_after_bootstrap&#39;</span>

<span class="sd">                remove_outlier_learners: (bool), whether to remove weak learners from ensemble models whose predictions are found to be outliers. Default False.</span>

<span class="sd">                recalibrate_errors: (bool), whether to perform the predicted error bar recalibration method of Palmer et al. Default False.</span>

<span class="sd">                verbosity: (int), the output plotting verbosity. Default is 1. Valid choices are 0, 1, 2, and 3.</span>

<span class="sd">            Returns:</span>
<span class="sd">                None</span>

<span class="sd">        _evaluate_split: method to evaluate a single data split, i.e. fit model, predict test data, and perform some plots and analysis</span>
<span class="sd">            Args:</span>
<span class="sd">                X_train: (pd.DataFrame), dataframe of X training features</span>

<span class="sd">                X_test: (pd.DataFrame), dataframe of X test features</span>

<span class="sd">                y_train: (pd.Series), series of y training features</span>

<span class="sd">                y_test: (pd.Series), series of y test features</span>

<span class="sd">                model: (mastml.models instance), an estimator for fitting data</span>

<span class="sd">                model_name: (str), class name of the model being evaluated</span>

<span class="sd">                preprocessor: (mastml.preprocessor), mastml.preprocessor object to normalize the training data in each split.</span>

<span class="sd">                selector: (mastml.selector), a feature selector to select features in each split</span>

<span class="sd">                hyperopt: (mastml.hyperopt), mastml.hyperopt instance to perform model hyperparameter optimization in each split</span>

<span class="sd">                metrics: (list), list of metric names to evaluate true vs. pred data in each split</span>

<span class="sd">                plots: (list), list of names denoting which types of plots to make. Valid names are &#39;Scatter&#39;, &#39;Error&#39;, and &#39;Histogram&#39;</span>

<span class="sd">                groups: (str), string denoting the test group, if applicable</span>

<span class="sd">                splitpath:(str), string denoting the split path in the save directory</span>

<span class="sd">                has_model_errors: (bool), whether the model used has error bars (uncertainty quantification)</span>

<span class="sd">                X_extra_train: (pd.DataFrame), dataframe of the extra X data of the training split (not used in fit)</span>

<span class="sd">                X_extra_test: (pd.DataFrame), dataframe of the extra X data of the testing split (not used in fit)</span>

<span class="sd">                error_method: (str), the type of model error evaluation method to perform. Only applies to certain models. Valid names are &#39;stdev_weak_learners&#39; and &#39;jackknife_after_bootstrap&#39;</span>

<span class="sd">                remove_outlier_learners: (bool), whether to remove weak learners from ensemble models whose predictions are found to be outliers. Default False.</span>

<span class="sd">                verbosity: (int), the output plotting verbosity. Default is 1. Valid choices are 0, 1, 2, and 3.</span>

<span class="sd">            Returns:</span>
<span class="sd">                None</span>

<span class="sd">        _setup_savedir: method to create a save directory based on model/selector/preprocessor names</span>
<span class="sd">            Args:</span>
<span class="sd">                model: (mastml.models instance), an estimator for fitting data</span>

<span class="sd">                preprocessor: (mastml.preprocessor), mastml.preprocessor object to normalize the training data in each split.</span>

<span class="sd">                selector: (mastml.selector), a feature selector to select features in each split</span>

<span class="sd">                savepath: (str), string denoting the save path of the file</span>

<span class="sd">        _save_split_data: method to save the X and y split data to excel files</span>
<span class="sd">            Args:</span>
<span class="sd">                df: (pd.DataFrame), dataframe of X or y data to save to file</span>

<span class="sd">                filename: (str), string denoting the filename, e.g. &#39;Xtest&#39;</span>

<span class="sd">                savepath: (str), string denoting the save path of the file</span>

<span class="sd">                columns: (list), list of dataframe column names, e.g. X feature names</span>

<span class="sd">            Returns:</span>
<span class="sd">                None</span>

<span class="sd">        _collect_data: method to collect all pd.Series (e.g. ytrain/ytest) data into single series over many splits (directories)</span>
<span class="sd">            Args:</span>
<span class="sd">                filename: (str), string denoting the filename, e.g. &#39;ytest&#39;</span>

<span class="sd">                savepath: (str), string denoting the save path of the file</span>

<span class="sd">            Returns:</span>
<span class="sd">                data: (list), list containing flattened array of all data of a given type over many splits, e.g. all ypred data</span>

<span class="sd">        _collect_df_data: method to collect all pd.DataFrame (e.g. Xtrain/Xtest) data into single dataframe over many splits (directories)</span>
<span class="sd">            Args:</span>
<span class="sd">                filename: (str), string denoting the filename, e.g. &#39;Xtest&#39;</span>

<span class="sd">                savepath: (str), string denoting the save path of the file</span>

<span class="sd">            Returns:</span>
<span class="sd">                data: (list), list containing flattened array of all data of a given type over many splits, e.g. all Xtest data</span>

<span class="sd">        _get_best_split: method to find the best performing model in a set of train/test splits</span>
<span class="sd">            Args:</span>
<span class="sd">                savepath: (str), string denoting the save path of the file</span>

<span class="sd">                preprocessor: (mastml.preprocessor), mastml.preprocessor object to normalize the training data in each split.</span>

<span class="sd">                best_run_metric: (str), name of the metric to use to find the best performing model</span>

<span class="sd">                model_name: (str), class name of model being evaluated</span>

<span class="sd">            Returns:</span>
<span class="sd">                best_split_dict: (dict), dictionary containing the path locations of the best model and corresponding preprocessor and selected feature list</span>

<span class="sd">        _get_average_recalibration_params: method to get the average and standard deviation of the recalibration factors in all train/test CV sets</span>
<span class="sd">            Args:</span>
<span class="sd">                savepath: (str), string denoting the save path of the file</span>

<span class="sd">                data_type: (str), string denoting the type of data to examine (e.g. test or leftout)</span>

<span class="sd">            Returns:</span>
<span class="sd">                recalibrate_avg_dict: (dict): dictionary of average recalibration parameters</span>

<span class="sd">                recalibrate_stdev_dict: (dict): dictionary of stdev of recalibration parameters</span>

<span class="sd">        _get_recalibration_params: method to get the recalibration factors for a single evaluation</span>
<span class="sd">            Args:</span>
<span class="sd">                savepath: (str), string denoting the save path of the file</span>

<span class="sd">                data_type: (str), string denoting the type of data to examine (e.g. test or leftout)</span>

<span class="sd">            Returns:</span>
<span class="sd">                recalibrate_dict: (dict): dictionary of recalibration parameters</span>

<span class="sd">        help: method to output key information on class use, e.g. methods and parameters</span>
<span class="sd">            Args:</span>
<span class="sd">                None</span>

<span class="sd">            Returns:</span>
<span class="sd">                None, but outputs help to screen</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BaseSplitter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

<div class="viewcode-block" id="BaseSplitter.split_asframe"><a class="viewcode-back" href="../../api/mastml.data_splitters.BaseSplitter.html#mastml.data_splitters.BaseSplitter.split_asframe">[docs]</a>    <span class="k">def</span> <span class="nf">split_asframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">split</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span>
        <span class="n">X_splits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">y_splits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">train_inds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">test_inds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">train</span><span class="p">,</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">split</span><span class="p">:</span>
            <span class="n">X_splits</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train</span><span class="p">],</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test</span><span class="p">]))</span>
            <span class="n">y_splits</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">test</span><span class="p">]))</span>
            <span class="n">train_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
            <span class="n">test_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X_splits</span><span class="p">,</span> <span class="n">y_splits</span><span class="p">,</span> <span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span></div>

<div class="viewcode-block" id="BaseSplitter.evaluate"><a class="viewcode-back" href="../../api/mastml.data_splitters.BaseSplitter.html#mastml.data_splitters.BaseSplitter.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">preprocessor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hyperopts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selectors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">plots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">X_extra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">leaveout_inds</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">list</span><span class="p">()),</span>
                 <span class="n">best_run_metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nested_CV</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">error_method</span><span class="o">=</span><span class="s1">&#39;stdev_weak_learners&#39;</span><span class="p">,</span> <span class="n">remove_outlier_learners</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">recalibrate_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">nested_CV</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;NoSplit&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: NoSplit does not support nested cross validation.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Get set of X_leaveout, y_leaveout for testing. Append them to user-specified X_leaveout tests</span>
                <span class="n">X_splits</span><span class="p">,</span> <span class="n">y_splits</span><span class="p">,</span> <span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_asframe</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span>
                <span class="n">leaveout_inds_orig</span> <span class="o">=</span> <span class="n">leaveout_inds</span>
                <span class="n">leaveout_inds</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">test_inds</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">leaveout_inds_orig</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">leaveout_inds_orig</span><span class="p">:</span>
                        <span class="n">leaveout_inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plots</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Scatter&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">models</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">selectors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">selectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">NoSelect</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">selectors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selectors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">selectors</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">preprocessor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">NoPreprocessor</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;root_mean_squared_error&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">best_run_metric</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">best_run_metric</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">hyperopts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hyperopts</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">models</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">savepath</span><span class="p">:</span>
            <span class="n">savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">splitdirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">hyperopt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">hyperopts</span><span class="p">):</span>

            <span class="c1"># See if the model used is amenable to uncertainty (error) analysis</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

            <span class="k">if</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RandomForestRegressor&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;GradientBoostingRegressor&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;GaussianProcessRegressor&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;BaggingRegressor&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;ExtraTreesRegressor&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;AdaBoostRegressor&#39;</span><span class="p">]:</span>
                <span class="n">has_model_errors</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">has_model_errors</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">recalibrate_errors</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: you have selected to recalibrate errors using a model that does not support &#39;</span>
                          <span class="s1">&#39;error estimation. Automatically changing to set recalibrate_errors = False&#39;</span><span class="p">)</span>
                    <span class="n">recalibrate_errors</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">selector</span> <span class="ow">in</span> <span class="n">selectors</span><span class="p">:</span>
                <span class="n">splitdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_savedir</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">selector</span><span class="o">=</span><span class="n">selector</span><span class="p">,</span> <span class="n">preprocessor</span><span class="o">=</span><span class="n">preprocessor</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">savepath</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">splitdirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splitdir</span><span class="p">)</span>

                <span class="n">split_outer_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">leaveout_inds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">leaveout_ind</span> <span class="ow">in</span> <span class="n">leaveout_inds</span><span class="p">:</span>
                        <span class="n">X_subsplit</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">leaveout_ind</span><span class="p">)]</span>
                        <span class="n">y_subsplit</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">leaveout_ind</span><span class="p">)]</span>
                        <span class="n">X_leaveout</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">leaveout_ind</span><span class="p">)]</span>
                        <span class="n">y_leaveout</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">y</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">leaveout_ind</span><span class="p">)]</span>

                        <span class="n">dataset_stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_subsplit</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">groups_subsplit</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">groups</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">leaveout_ind</span><span class="p">)]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">groups_subsplit</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">X_splits</span><span class="p">,</span> <span class="n">y_splits</span><span class="p">,</span> <span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_asframe</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_subsplit</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_subsplit</span><span class="p">,</span>
                                                                                       <span class="n">groups</span><span class="o">=</span><span class="n">groups_subsplit</span><span class="p">)</span>

                        <span class="c1"># make the individual split directory</span>
                        <span class="n">splitouterpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitdir</span><span class="p">,</span> <span class="s1">&#39;split_outer_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">split_outer_count</span><span class="p">))</span>
                        <span class="c1"># make the feature selector directory for this split directory</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">splitouterpath</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_split_sets</span><span class="p">(</span><span class="n">X_splits</span><span class="p">,</span>
                                                  <span class="n">y_splits</span><span class="p">,</span>
                                                  <span class="n">train_inds</span><span class="p">,</span>
                                                  <span class="n">test_inds</span><span class="p">,</span>
                                                  <span class="n">model</span><span class="p">,</span>
                                                  <span class="n">model_name</span><span class="p">,</span>
                                                  <span class="n">selector</span><span class="p">,</span>
                                                  <span class="n">preprocessor</span><span class="p">,</span>
                                                  <span class="n">X_extra</span><span class="p">,</span>
                                                  <span class="n">groups</span><span class="p">,</span>
                                                  <span class="n">splitouterpath</span><span class="p">,</span>
                                                  <span class="n">hyperopt</span><span class="p">,</span>
                                                  <span class="n">metrics</span><span class="p">,</span>
                                                  <span class="n">plots</span><span class="p">,</span>
                                                  <span class="n">has_model_errors</span><span class="p">,</span>
                                                  <span class="n">error_method</span><span class="p">,</span>
                                                  <span class="n">remove_outlier_learners</span><span class="p">,</span>
                                                  <span class="n">recalibrate_errors</span><span class="p">,</span>
                                                  <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>
                        <span class="n">split_outer_count</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="n">best_split_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_best_split</span><span class="p">(</span><span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span>
                                                               <span class="n">preprocessor</span><span class="o">=</span><span class="n">preprocessor</span><span class="p">,</span>
                                                               <span class="n">best_run_metric</span><span class="o">=</span><span class="n">best_run_metric</span><span class="p">,</span>
                                                               <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>
                        <span class="c1"># Copy the best model, selected features and preprocessor to this outer directory</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">best_split_dict</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">],</span> <span class="n">splitouterpath</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">best_split_dict</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">splitouterpath</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">best_split_dict</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">],</span> <span class="n">splitouterpath</span><span class="p">)</span>

                        <span class="c1"># Load in the best model, preprocessor and evaluate the left-out data stats</span>
                        <span class="n">best_model</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">best_split_dict</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">])</span>
                        <span class="n">preprocessor</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">best_split_dict</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">])</span>
                        <span class="n">X_train_bestmodel</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">best_split_dict</span><span class="p">[</span><span class="s1">&#39;X_train&#39;</span><span class="p">],</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">))</span> <span class="c1"># Need to preprocess the Xtrain data</span>

                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="s1">&#39;selected_features.txt&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">selected_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
                        <span class="n">X_leaveout</span> <span class="o">=</span> <span class="n">X_leaveout</span><span class="p">[</span><span class="n">selected_features</span><span class="p">]</span>
                        <span class="n">X_leaveout_preprocessed</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_leaveout</span><span class="p">)</span>
                        <span class="n">y_pred_leaveout</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_leaveout_preprocessed</span><span class="p">)</span>
                        <span class="n">y_pred_leaveout</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_pred_leaveout</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;y_pred_leaveout&#39;</span><span class="p">)</span>
                        <span class="n">stats_dict_leaveout</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">(</span><span class="n">metrics_list</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">y_leaveout</span><span class="p">,</span>
                                                                                     <span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred_leaveout</span><span class="p">)</span>
                        <span class="n">df_stats_leaveout</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span><span class="n">stats_dict_leaveout</span><span class="p">])</span>
                        <span class="n">df_stats_leaveout</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="s1">&#39;leaveout_stats_summary.xlsx&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                        <span class="c1"># At level of splitouterpath, do analysis over all splits (e.g. parity plot over all splits)</span>
                        <span class="n">y_test_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">)</span>
                        <span class="n">y_train_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">)</span>
                        <span class="n">y_pred_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">)</span>
                        <span class="n">y_pred_train_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">)</span>
                        <span class="n">residuals_test_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">)</span>
                        <span class="n">residuals_train_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">)</span>
                        <span class="n">X_train_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_df_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">)</span>
                        <span class="n">X_test_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_df_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">)</span>

                        <span class="c1"># Save the data gathered over all the splits</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">X_train_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X_train_all</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">X_test_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X_test_all</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_test_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_test&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_train_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_train&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_pred_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_pred&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_pred_train_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_pred_train&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">residuals_test_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;residuals&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">residuals_train_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;residuals&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">has_model_errors</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">model_errors_leaveout</span><span class="p">,</span> <span class="n">num_removed_learners_leaveout</span> <span class="o">=</span> <span class="n">ErrorUtils</span><span class="p">()</span><span class="o">.</span><span class="n">_get_model_errors</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">best_model</span><span class="p">,</span>
                                                                                    <span class="n">X</span><span class="o">=</span><span class="n">X_leaveout_preprocessed</span><span class="p">,</span>
                                                                                    <span class="n">X_train</span><span class="o">=</span><span class="n">X_train_bestmodel</span><span class="p">,</span>
                                                                                    <span class="n">X_test</span><span class="o">=</span><span class="n">X_leaveout_preprocessed</span><span class="p">,</span>
                                                                                   <span class="n">error_method</span><span class="o">=</span><span class="n">error_method</span><span class="p">,</span>
                                                                                    <span class="n">remove_outlier_learners</span><span class="o">=</span><span class="n">remove_outlier_learners</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">model_errors_leaveout</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;model_errors_leaveout&#39;</span><span class="p">,</span>
                                                  <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;model_errors&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">num_removed_learners_leaveout</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;num_removed_learners_leaveout&#39;</span><span class="p">,</span>
                                                  <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;num_removed_learners&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">model_errors_leaveout</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="c1"># Remake the leaveout y data series to reset the index</span>
                        <span class="n">y_leaveout</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_leaveout</span><span class="p">))</span>
                        <span class="n">y_pred_leaveout</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_pred_leaveout</span><span class="p">))</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">X_leaveout</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_leaveout&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X_leaveout</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_leaveout</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_leaveout&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_leaveout&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_pred_leaveout</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred_leaveout&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_pred_leaveout&#39;</span><span class="p">)</span>

                        <span class="n">residuals_leaveout</span> <span class="o">=</span> <span class="n">y_pred_leaveout</span><span class="o">-</span><span class="n">y_leaveout</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">residuals_leaveout</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_leaveout&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;residuals&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">recalibrate_errors</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">recalibrate_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_recalibration_params</span><span class="p">(</span><span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span>
                                                                              <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
                            <span class="n">model_errors_leaveout_cal</span> <span class="o">=</span> <span class="n">recalibrate_dict</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">model_errors_leaveout</span><span class="o">+</span><span class="n">recalibrate_dict</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">model_errors_leaveout_cal</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;model_errors_leaveout_calibrated&#39;</span><span class="p">,</span>
                                                  <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;model_errors&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">model_errors_leaveout_cal</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">make_plots</span><span class="p">(</span><span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">,</span>
                                       <span class="n">y_true</span><span class="o">=</span><span class="n">y_leaveout</span><span class="p">,</span>
                                       <span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred_leaveout</span><span class="p">,</span>
                                       <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span>
                                       <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;leaveout&#39;</span><span class="p">,</span>
                                       <span class="n">dataset_stdev</span><span class="o">=</span><span class="n">dataset_stdev</span><span class="p">,</span>
                                       <span class="n">has_model_errors</span><span class="o">=</span><span class="n">has_model_errors</span><span class="p">,</span>
                                       <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
                                       <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                       <span class="n">model_errors</span><span class="o">=</span><span class="n">model_errors_leaveout</span><span class="p">,</span>
                                       <span class="n">residuals</span><span class="o">=</span><span class="n">residuals_leaveout</span><span class="p">,</span>
                                       <span class="n">savepath</span><span class="o">=</span><span class="n">splitouterpath</span><span class="p">,</span>
                                       <span class="n">show_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                       <span class="n">recalibrate_errors</span><span class="o">=</span><span class="n">recalibrate_errors</span><span class="p">,</span>
                                       <span class="n">model_errors_cal</span><span class="o">=</span><span class="n">model_errors_leaveout_cal</span><span class="p">,</span>
                                       <span class="n">splits_summary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="c1"># At level of splitdir, collect and save all leaveout data</span>
                    <span class="n">y_leaveout_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_leaveout&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
                    <span class="n">y_pred_leaveout_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred_leaveout&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
                    <span class="n">residuals_leaveout_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_leaveout&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">residuals_leaveout_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_leaveout&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;residuals&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_leaveout_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_leaveout&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_leaveout&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_pred_leaveout_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred_leaveout&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_pred_leaveout&#39;</span><span class="p">)</span>

                    <span class="c1"># At level of splitodir, collect and save all train/test data</span>
                    <span class="n">y_test_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
                    <span class="n">y_train_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
                    <span class="n">y_pred_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
                    <span class="n">y_pred_train_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
                    <span class="n">residuals_test_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
                    <span class="n">residuals_train_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
                    <span class="n">X_train_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_df_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
                    <span class="n">X_test_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_df_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">X_train_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X_train_all</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">X_test_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X_test_all</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_test_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_test&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_train_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span>  <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_train&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_pred_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_pred&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_pred_train_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_pred_train&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">residuals_test_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;residuals&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">residuals_train_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;residuals&#39;</span><span class="p">)</span>

                    <span class="c1"># Remake the Series so that indices are sequential (needed for math)</span>
                    <span class="n">y_leaveout_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_leaveout_all</span><span class="p">))</span>
                    <span class="n">y_pred_leaveout_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_pred_leaveout_all</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">has_model_errors</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">model_errors_leaveout_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;model_errors_leaveout&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
                        <span class="n">num_removed_learners_leaveout_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;num_removed_learners_leaveout&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">model_errors_leaveout_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;model_errors_leaveout&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;model_errors&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">num_removed_learners_leaveout_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;num_removed_learners_leaveout&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;num_removed_learners&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">recalibrate_errors</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">model_errors_leaveout_all_calibrated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;model_errors_leaveout_calibrated&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">model_errors_leaveout_all_calibrated</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;model_errors_leaveout_calibrated&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;model_errors&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">model_errors_leaveout_all_calibrated</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">model_errors_leaveout_all</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">model_errors_leaveout_all_calibrated</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># Gather the recalibration dicts from each split set and save average and stdev of recalibrations</span>
                    <span class="k">if</span> <span class="n">has_model_errors</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">recalibrate_errors</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">recalibrate_avg_dict</span><span class="p">,</span> <span class="n">recalibrate_stdev_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_average_recalibration_params</span><span class="p">(</span><span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span>
                                                                                                              <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
                        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">recalibrate_avg_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitdir</span><span class="p">,</span> <span class="s1">&#39;recalibration_parameters_average_test.xlsx&#39;</span><span class="p">))</span>
                        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">recalibrate_stdev_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitdir</span><span class="p">,</span> <span class="s1">&#39;recalibration_parameters_stdev_test.xlsx&#39;</span><span class="p">))</span>

                    <span class="c1"># Make all leaveout data plots</span>
                    <span class="n">dataset_stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">make_plots</span><span class="p">(</span><span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">,</span>
                                   <span class="n">y_true</span><span class="o">=</span><span class="n">y_leaveout_all</span><span class="p">,</span>
                                   <span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred_leaveout_all</span><span class="p">,</span>
                                   <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span>
                                   <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;leaveout&#39;</span><span class="p">,</span>
                                   <span class="n">dataset_stdev</span><span class="o">=</span><span class="n">dataset_stdev</span><span class="p">,</span>
                                   <span class="n">has_model_errors</span><span class="o">=</span><span class="n">has_model_errors</span><span class="p">,</span>
                                   <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
                                   <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                   <span class="n">model_errors</span><span class="o">=</span><span class="n">model_errors_leaveout_all</span><span class="p">,</span>
                                   <span class="n">residuals</span><span class="o">=</span><span class="n">residuals_leaveout_all</span><span class="p">,</span>
                                   <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span>
                                   <span class="n">show_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">recalibrate_errors</span><span class="o">=</span><span class="n">recalibrate_errors</span><span class="p">,</span>
                                   <span class="n">model_errors_cal</span><span class="o">=</span><span class="n">model_errors_leaveout_all_calibrated</span><span class="p">,</span>
                                   <span class="n">splits_summary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">X_splits</span><span class="p">,</span> <span class="n">y_splits</span><span class="p">,</span> <span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_asframe</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_split_sets</span><span class="p">(</span><span class="n">X_splits</span><span class="p">,</span>
                                              <span class="n">y_splits</span><span class="p">,</span>
                                              <span class="n">train_inds</span><span class="p">,</span>
                                              <span class="n">test_inds</span><span class="p">,</span>
                                              <span class="n">model</span><span class="p">,</span>
                                              <span class="n">model_name</span><span class="p">,</span>
                                              <span class="n">selector</span><span class="p">,</span>
                                              <span class="n">preprocessor</span><span class="p">,</span>
                                              <span class="n">X_extra</span><span class="p">,</span>
                                              <span class="n">groups</span><span class="p">,</span>
                                              <span class="n">splitdir</span><span class="p">,</span>
                                              <span class="n">hyperopt</span><span class="p">,</span>
                                              <span class="n">metrics</span><span class="p">,</span>
                                              <span class="n">plots</span><span class="p">,</span>
                                              <span class="n">has_model_errors</span><span class="p">,</span>
                                              <span class="n">error_method</span><span class="p">,</span>
                                              <span class="n">remove_outlier_learners</span><span class="p">,</span>
                                              <span class="n">recalibrate_errors</span><span class="p">,</span>
                                              <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">)</span>

                    <span class="n">best_split_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_best_split</span><span class="p">(</span><span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span>
                                                           <span class="n">preprocessor</span><span class="o">=</span><span class="n">preprocessor</span><span class="p">,</span>
                                                           <span class="n">best_run_metric</span><span class="o">=</span><span class="n">best_run_metric</span><span class="p">,</span>
                                                           <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">)</span>
                    <span class="c1"># Copy the best model, selected features and preprocessor to this outer directory</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">best_split_dict</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">],</span> <span class="n">splitdir</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">best_split_dict</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">splitdir</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">best_split_dict</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">],</span> <span class="n">splitdir</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_evaluate_split_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_splits</span><span class="p">,</span> <span class="n">y_splits</span><span class="p">,</span> <span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span>
                             <span class="n">X_extra</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">splitdir</span><span class="p">,</span> <span class="n">hyperopt</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">plots</span><span class="p">,</span> <span class="n">has_model_errors</span><span class="p">,</span> <span class="n">error_method</span><span class="p">,</span>
                             <span class="n">remove_outlier_learners</span><span class="p">,</span> <span class="n">recalibrate_errors</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">):</span>
        <span class="n">split_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">Xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">train_ind</span><span class="p">,</span> <span class="n">test_ind</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X_splits</span><span class="p">,</span> <span class="n">y_splits</span><span class="p">,</span> <span class="n">train_inds</span><span class="p">,</span> <span class="n">test_inds</span><span class="p">):</span>
            <span class="n">model_orig</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">selector_orig</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span>
            <span class="n">preprocessor_orig</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">)</span>
            <span class="n">hyperopt_orig</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">hyperopt</span><span class="p">)</span>

            <span class="n">X_train</span> <span class="o">=</span> <span class="n">Xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">X_test</span> <span class="o">=</span> <span class="n">Xs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;y_train&#39;</span><span class="p">)</span>
            <span class="n">y_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;y_test&#39;</span><span class="p">)</span>  <span class="c1"># Make it so the y_test and y_pred have same indices so can be subtracted to get residual</span>

            <span class="k">if</span> <span class="n">X_extra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">X_extra_train</span> <span class="o">=</span> <span class="n">X_extra</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">train_ind</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">X_extra_test</span> <span class="o">=</span> <span class="n">X_extra</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">test_ind</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">X_extra_train</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">X_extra_test</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="n">test_ind</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">splitpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitdir</span><span class="p">,</span> <span class="s1">&#39;split_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">split_count</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">splitpath</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_split</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">model_orig</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">preprocessor_orig</span><span class="p">,</span> <span class="n">selector_orig</span><span class="p">,</span>
                                 <span class="n">hyperopt_orig</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">plots</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span>
                                 <span class="n">splitpath</span><span class="p">,</span> <span class="n">has_model_errors</span><span class="p">,</span> <span class="n">X_extra_train</span><span class="p">,</span> <span class="n">X_extra_test</span><span class="p">,</span> <span class="n">error_method</span><span class="p">,</span> <span class="n">remove_outlier_learners</span><span class="p">,</span>
                                 <span class="n">verbosity</span><span class="p">)</span>
            <span class="n">split_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># At level of splitdir, do analysis over all splits (e.g. parity plot over all splits)</span>
        <span class="n">y_test_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
        <span class="n">y_train_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
        <span class="n">y_pred_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
        <span class="n">y_pred_train_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
        <span class="n">residuals_test_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
        <span class="n">residuals_train_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
        <span class="n">X_train_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_df_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
        <span class="n">X_test_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_df_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>

        <span class="c1"># Save the data gathered over all the splits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">X_train_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X_train_all</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">X_test_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X_test_all</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_test_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_test&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_train_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_train&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_pred_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_pred&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_pred_train_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_pred_train&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_model_errors</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">model_errors_test_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;model_errors_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
            <span class="n">model_errors_train_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;model_errors_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
            <span class="n">num_removed_learners_test_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;num_removed_learners_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
            <span class="n">num_removed_learners_train_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_data</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;num_removed_learners_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">)</span>
            <span class="c1"># Save all the uncalibrated model errors data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">model_errors_test_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;model_errors_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;model_errors&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">model_errors_train_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;model_errors_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;model_errors&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">num_removed_learners_test_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;num_removed_learners_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;num_removed_learners&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">num_removed_learners_train_all</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;num_removed_learners_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;num_removed_learners&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_errors_test_all</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">model_errors_train_all</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">recalibrate_errors</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">model_errors_test_all_cal</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ErrorUtils</span><span class="p">()</span><span class="o">.</span><span class="n">_recalibrate_errors</span><span class="p">(</span><span class="n">model_errors</span><span class="o">=</span><span class="n">model_errors_test_all</span><span class="p">,</span> <span class="n">residuals</span><span class="o">=</span><span class="n">residuals_test_all</span><span class="p">)</span>

            <span class="c1"># Write the recalibration values to file</span>
            <span class="n">recal_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;slope (a)&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;intercept (b)&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">recal_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitdir</span><span class="p">,</span> <span class="s1">&#39;recalibration_parameters_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Write the calibrated model errors to file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">model_errors_test_all_cal</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;model_errors_test_calibrated&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;model_errors&#39;</span><span class="p">)</span>

            <span class="n">model_errors_train_all_cal</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ErrorUtils</span><span class="p">()</span><span class="o">.</span><span class="n">_recalibrate_errors</span><span class="p">(</span><span class="n">model_errors</span><span class="o">=</span><span class="n">model_errors_train_all</span><span class="p">,</span>
                                                                                <span class="n">residuals</span><span class="o">=</span><span class="n">residuals_train_all</span><span class="p">)</span>

            <span class="c1"># Write the recalibration values to file</span>
            <span class="n">recal_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;slope (a)&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;intercept (b)&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">recal_df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitdir</span><span class="p">,</span> <span class="s1">&#39;recalibration_parameters_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.xlsx&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Write the calibrated model errors to file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">model_errors_train_all_cal</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;model_errors_train_calibrated&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span>
                                  <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;model_errors&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_errors_test_all_cal</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">model_errors_train_all_cal</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Make all test data plots</span>
        <span class="n">dataset_stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train_all</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">make_plots</span><span class="p">(</span><span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">,</span>
                       <span class="n">y_true</span><span class="o">=</span><span class="n">y_test_all</span><span class="p">,</span>
                       <span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred_all</span><span class="p">,</span>
                       <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span>
                       <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
                       <span class="n">dataset_stdev</span><span class="o">=</span><span class="n">dataset_stdev</span><span class="p">,</span>
                       <span class="n">has_model_errors</span><span class="o">=</span><span class="n">has_model_errors</span><span class="p">,</span>
                       <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
                       <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                       <span class="n">model_errors</span><span class="o">=</span><span class="n">model_errors_test_all</span><span class="p">,</span>
                       <span class="n">residuals</span><span class="o">=</span><span class="n">residuals_test_all</span><span class="p">,</span>
                       <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span>
                       <span class="n">show_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">recalibrate_errors</span><span class="o">=</span><span class="n">recalibrate_errors</span><span class="p">,</span>
                       <span class="n">model_errors_cal</span><span class="o">=</span><span class="n">model_errors_test_all_cal</span><span class="p">,</span>
                       <span class="n">splits_summary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Make all train data plots</span>
        <span class="n">dataset_stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_train_all</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">make_plots</span><span class="p">(</span><span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">,</span>
                       <span class="n">y_true</span><span class="o">=</span><span class="n">y_train_all</span><span class="p">,</span>
                       <span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred_train_all</span><span class="p">,</span>
                       <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span>
                       <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span>
                       <span class="n">dataset_stdev</span><span class="o">=</span><span class="n">dataset_stdev</span><span class="p">,</span>
                       <span class="n">has_model_errors</span><span class="o">=</span><span class="n">has_model_errors</span><span class="p">,</span>
                       <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
                       <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                       <span class="n">model_errors</span><span class="o">=</span><span class="n">model_errors_train_all</span><span class="p">,</span>
                       <span class="n">residuals</span><span class="o">=</span><span class="n">residuals_train_all</span><span class="p">,</span>
                       <span class="n">savepath</span><span class="o">=</span><span class="n">splitdir</span><span class="p">,</span>
                       <span class="n">show_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">recalibrate_errors</span><span class="o">=</span><span class="n">recalibrate_errors</span><span class="p">,</span>
                       <span class="n">model_errors_cal</span><span class="o">=</span><span class="n">model_errors_train_all_cal</span><span class="p">,</span>
                       <span class="n">splits_summary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_evaluate_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">hyperopt</span><span class="p">,</span>
                        <span class="n">metrics</span><span class="p">,</span> <span class="n">plots</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">splitpath</span><span class="p">,</span> <span class="n">has_model_errors</span><span class="p">,</span> <span class="n">X_extra_train</span><span class="p">,</span> <span class="n">X_extra_test</span><span class="p">,</span>
                        <span class="n">error_method</span><span class="p">,</span> <span class="n">remove_outlier_learners</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">):</span>

        <span class="n">X_train_orig</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">X_test_orig</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="n">preprocessor1</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">)</span>
        <span class="n">preprocessor2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">preprocessor</span><span class="p">)</span>

        <span class="c1"># Preprocess the full split data</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">preprocessor1</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">)</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">preprocessor1</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

        <span class="c1"># run feature selector to get new Xtrain, Xtest</span>
        <span class="n">X_train</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">)</span>
        <span class="n">selected_features</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">selected_features</span>

        <span class="n">X_train</span> <span class="o">=</span> <span class="n">preprocessor2</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_train_orig</span><span class="p">[</span><span class="n">selected_features</span><span class="p">],</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;train_selected&#39;</span><span class="p">)</span>
        <span class="n">X_test</span> <span class="o">=</span> <span class="n">preprocessor2</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_orig</span><span class="p">[</span><span class="n">selected_features</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">X_train_orig</span><span class="p">[</span><span class="n">selected_features</span><span class="p">],</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">selected_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">X_test_orig</span><span class="p">[</span><span class="n">selected_features</span><span class="p">],</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">selected_features</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_train&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_test&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">X_extra_train</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">X_extra_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">X_extra_train</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_extra_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X_extra_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">X_extra_test</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;X_extra_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X_extra_test</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

        <span class="c1"># Here evaluate hyperopt instance, if provided, and get updated model instance</span>
        <span class="k">if</span> <span class="n">hyperopt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">hyperopt</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">y_pred_train</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>

        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;y_pred&#39;</span><span class="p">)</span>
        <span class="n">y_pred_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">y_pred_train</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;y_pred_train&#39;</span><span class="p">)</span>

        <span class="n">residuals_test</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">-</span><span class="n">y_test</span>
        <span class="n">residuals_train</span> <span class="o">=</span> <span class="n">y_pred_train</span><span class="o">-</span><span class="n">y_train</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_pred&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">y_pred_train</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;y_pred_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;y_pred_train&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">residuals_test</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;residuals&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">residuals_train</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;residuals_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;residuals&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_model_errors</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">model_errors_test</span><span class="p">,</span> <span class="n">num_removed_learners_test</span> <span class="o">=</span> <span class="n">ErrorUtils</span><span class="p">()</span><span class="o">.</span><span class="n">_get_model_errors</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                                                <span class="n">X</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span>
                                                                <span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span>
                                                                <span class="n">X_test</span><span class="o">=</span><span class="n">X_test</span><span class="p">,</span>
                                                               <span class="n">error_method</span><span class="o">=</span><span class="n">error_method</span><span class="p">,</span>
                                                               <span class="n">remove_outlier_learners</span><span class="o">=</span><span class="n">remove_outlier_learners</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">model_errors_test</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;model_errors_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;model_errors&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">num_removed_learners_test</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;num_removed_learners_test&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;num_removed_learners&#39;</span><span class="p">)</span>
            <span class="n">model_errors_train</span><span class="p">,</span> <span class="n">num_removed_learners_train</span> <span class="o">=</span> <span class="n">ErrorUtils</span><span class="p">()</span><span class="o">.</span><span class="n">_get_model_errors</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                                                                <span class="n">X</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span>
                                                                <span class="n">X_train</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span>
                                                                <span class="n">X_test</span><span class="o">=</span><span class="n">X_train</span><span class="p">,</span> <span class="c1">#predicting on train data so test/train is same</span>
                                                                <span class="n">error_method</span><span class="o">=</span><span class="n">error_method</span><span class="p">,</span>
                                                                <span class="n">remove_outlier_learners</span><span class="o">=</span><span class="n">remove_outlier_learners</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">model_errors_train</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;model_errors_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;model_errors&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_split_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">num_removed_learners_train</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;num_removed_learners_train&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;num_removed_learners&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_errors_test</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">model_errors_train</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Save summary stats data for this split</span>
        <span class="n">stats_dict</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">(</span><span class="n">metrics_list</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">)</span>
        <span class="n">df_stats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span><span class="n">stats_dict</span><span class="p">])</span>
        <span class="n">df_stats</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitpath</span><span class="p">,</span> <span class="s1">&#39;test_stats_summary.xlsx&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">stats_dict_train</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">(</span><span class="n">metrics_list</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred_train</span><span class="p">)</span>
        <span class="n">df_stats_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_records</span><span class="p">([</span><span class="n">stats_dict_train</span><span class="p">])</span>
        <span class="n">df_stats_train</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitpath</span><span class="p">,</span> <span class="s1">&#39;train_stats_summary.xlsx&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Make all test data plots</span>
        <span class="n">dataset_stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">make_plots</span><span class="p">(</span><span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">,</span>
                       <span class="n">y_true</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span>
                       <span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span>
                       <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span>
                       <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span>
                       <span class="n">dataset_stdev</span><span class="o">=</span><span class="n">dataset_stdev</span><span class="p">,</span>
                       <span class="n">has_model_errors</span><span class="o">=</span><span class="n">has_model_errors</span><span class="p">,</span>
                       <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
                       <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                       <span class="n">model_errors</span><span class="o">=</span><span class="n">model_errors_test</span><span class="p">,</span>
                       <span class="n">residuals</span><span class="o">=</span><span class="n">residuals_test</span><span class="p">,</span>
                       <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span>
                       <span class="n">show_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">recalibrate_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">splits_summary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Make all train data plots</span>
        <span class="n">dataset_stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">make_plots</span><span class="p">(</span><span class="n">plots</span><span class="o">=</span><span class="n">plots</span><span class="p">,</span>
                       <span class="n">y_true</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
                       <span class="n">y_pred</span><span class="o">=</span><span class="n">y_pred_train</span><span class="p">,</span>
                       <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span>
                       <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span>
                       <span class="n">dataset_stdev</span><span class="o">=</span><span class="n">dataset_stdev</span><span class="p">,</span>
                       <span class="n">has_model_errors</span><span class="o">=</span><span class="n">has_model_errors</span><span class="p">,</span>
                       <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span>
                       <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                       <span class="n">model_errors</span><span class="o">=</span><span class="n">model_errors_train</span><span class="p">,</span>
                       <span class="n">residuals</span><span class="o">=</span><span class="n">residuals_train</span><span class="p">,</span>
                       <span class="n">savepath</span><span class="o">=</span><span class="n">splitpath</span><span class="p">,</span>
                       <span class="n">show_figure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">recalibrate_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">splits_summary</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Write the test group to a text file,</span>
        <span class="k">if</span> <span class="n">groups</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitpath</span><span class="p">,</span> <span class="s1">&#39;test_group.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
        <span class="c1">#    with open(os.path.join(splitpath,&#39;train_groups.txt&#39;), &#39;w&#39;) as f:</span>
        <span class="c1">#        for group in train_groups:</span>
        <span class="c1">#            f.write(str(group)+&quot;\n&quot;)</span>

        <span class="c1"># Save the fitted model, will be needed for DLHub upload later on</span>
        <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitpath</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">))</span>

        <span class="c1"># If using a Keras model, need to clear the session so training multiple models doesn&#39;t slow training down</span>
        <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;KerasRegressor&#39;</span><span class="p">:</span>
            <span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;BaggingRegressor&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">base_estimator</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;KerasRegressor&#39;</span><span class="p">:</span>
                <span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_setup_savedir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span> <span class="n">savepath</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="n">dirname</span> <span class="o">=</span> <span class="n">model_name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">preprocessor</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">selector</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">day</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> \
            <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">hour</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">minute</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">second</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">savepath</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">splitdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">splitdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">splitdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">splitdir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">splitdir</span> <span class="o">=</span> <span class="n">splitdir</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># self.splitdir = splitdir</span>
        <span class="k">return</span> <span class="n">splitdir</span>

    <span class="k">def</span> <span class="nf">_save_split_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">series</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">columns</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_collect_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">savepath</span><span class="p">):</span>
        <span class="c1"># Note this is only meant for collecting y-data (single column)</span>
        <span class="n">dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">savepath</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;split&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="s1">&#39;.png&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="s1">&#39;.xlsx&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;residuals&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">col_name</span> <span class="o">=</span> <span class="s1">&#39;residuals&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;model_errors&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">col_name</span> <span class="o">=</span> <span class="s1">&#39;model_errors&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;num_removed_learners&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">col_name</span> <span class="o">=</span> <span class="s1">&#39;num_removed_learners&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">col_name</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">)[</span><span class="n">col_name</span><span class="p">]))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_collect_df_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">savepath</span><span class="p">):</span>
        <span class="n">dirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">savepath</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;split&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="s1">&#39;.png&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="s1">&#39;.xlsx&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_get_best_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span> <span class="n">best_run_metric</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>
        <span class="n">dirs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">savepath</span><span class="p">)</span>
        <span class="n">splitdirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span> <span class="k">if</span> <span class="s1">&#39;split_&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="s1">&#39;.png&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span>

        <span class="n">stats_files_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">splitdir</span> <span class="ow">in</span> <span class="n">splitdirs</span><span class="p">:</span>
            <span class="n">stats_files_dict</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">splitdir</span><span class="p">)]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">splitdir</span><span class="p">),</span> <span class="s1">&#39;test_stats_summary.xlsx&#39;</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Find best/worst splits based on RMSE value</span>
        <span class="c1">#TODO: this needs to be more general to work with other metrics</span>
        <span class="n">rmse_best</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">20</span>
        <span class="k">for</span> <span class="n">split</span><span class="p">,</span> <span class="n">stats_dict</span> <span class="ow">in</span> <span class="n">stats_files_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">stats_dict</span><span class="p">[</span><span class="n">best_run_metric</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">rmse_best</span><span class="p">:</span>
                <span class="n">best_split</span> <span class="o">=</span> <span class="n">split</span>
                <span class="n">rmse_best</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="n">best_run_metric</span><span class="p">]</span>

        <span class="c1"># Get the preprocessor, model, and features for the best split</span>
        <span class="n">best_split_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">preprocessor_name</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">preprocessor</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span>

        <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">best_split</span><span class="p">,</span> <span class="n">preprocessor_name</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: couldn&#39;t find preprocessor .pkl file in best split&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">best_split</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: couldn&#39;t find model .pkl file in best split&quot;</span><span class="p">)</span>
        <span class="n">best_split_dict</span><span class="p">[</span><span class="s1">&#39;preprocessor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">best_split</span><span class="p">,</span> <span class="n">preprocessor_name</span><span class="p">)</span>
        <span class="n">best_split_dict</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">best_split</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
        <span class="n">best_split_dict</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">best_split</span><span class="p">,</span> <span class="s1">&#39;selected_features.txt&#39;</span><span class="p">)</span>
        <span class="n">best_split_dict</span><span class="p">[</span><span class="s1">&#39;X_train&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">best_split</span><span class="p">,</span> <span class="s1">&#39;X_train.xlsx&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">best_split_dict</span>

    <span class="k">def</span> <span class="nf">_get_average_recalibration_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">data_type</span><span class="p">):</span>
        <span class="n">dirs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">savepath</span><span class="p">)</span>
        <span class="n">splitdirs</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dirs</span> <span class="k">if</span> <span class="s1">&#39;split_&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="s1">&#39;.png&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span>

        <span class="n">recalibrate_a_vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">recalibrate_b_vals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">splitdir</span> <span class="ow">in</span> <span class="n">splitdirs</span><span class="p">:</span>
            <span class="n">recalibrate_dict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">splitdir</span><span class="p">),</span>
                                                          <span class="s1">&#39;recalibration_parameters_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">recalibrate_a_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recalibrate_dict</span><span class="p">[</span><span class="s1">&#39;slope (a)&#39;</span><span class="p">])</span>
            <span class="n">recalibrate_b_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recalibrate_dict</span><span class="p">[</span><span class="s1">&#39;intercept (b)&#39;</span><span class="p">])</span>
        <span class="n">recalibrate_avg_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recalibrate_a_vals</span><span class="p">),</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">recalibrate_b_vals</span><span class="p">)}</span>
        <span class="n">recalibrate_stdev_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">recalibrate_a_vals</span><span class="p">),</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">recalibrate_b_vals</span><span class="p">)}</span>
        <span class="k">return</span> <span class="n">recalibrate_avg_dict</span><span class="p">,</span> <span class="n">recalibrate_stdev_dict</span>

    <span class="k">def</span> <span class="nf">_get_recalibration_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">data_type</span><span class="p">):</span>
        <span class="n">recalibrate_dict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="s1">&#39;recalibration_parameters_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;openpyxl&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">recalibrate_dict_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">recalibrate_dict_</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recalibrate_dict</span><span class="p">[</span><span class="s1">&#39;slope (a)&#39;</span><span class="p">]</span>
        <span class="n">recalibrate_dict_</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recalibrate_dict</span><span class="p">[</span><span class="s1">&#39;intercept (b)&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">recalibrate_dict_</span>

<div class="viewcode-block" id="BaseSplitter.help"><a class="viewcode-back" href="../../api/mastml.data_splitters.BaseSplitter.html#mastml.data_splitters.BaseSplitter.help">[docs]</a>    <span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Documentation for&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="p">)</span>
        <span class="n">pprint</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="p">))[</span><span class="s1">&#39;__doc__&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Class methods for,&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="p">)</span>
        <span class="n">pprint</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Class attributes for,&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="p">)</span>
        <span class="n">pprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="SklearnDataSplitter"><a class="viewcode-back" href="../../api/mastml.data_splitters.SklearnDataSplitter.html#mastml.data_splitters.SklearnDataSplitter">[docs]</a><span class="k">class</span> <span class="nc">SklearnDataSplitter</span><span class="p">(</span><span class="n">BaseSplitter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to wrap any scikit-learn based data splitter, e.g. KFold</span>

<span class="sd">    Args:</span>
<span class="sd">        splitter (str): string denoting the name of a sklearn.model_selection object, e.g. &#39;KFold&#39; will draw from sklearn.model_selection.KFold()</span>

<span class="sd">        kwargs : key word arguments for the sklearn.model_selection object, e.g. n_splits=5 for KFold()</span>

<span class="sd">    Methods:</span>
<span class="sd">        get_n_splits: method to calculate the number of splits to perform</span>
<span class="sd">            Args:</span>
<span class="sd">                None</span>

<span class="sd">            Returns:</span>
<span class="sd">                (int), number of train/test splits</span>

<span class="sd">        split: method to perform split into train indices and test indices</span>
<span class="sd">            Args:</span>
<span class="sd">                X: (numpy array), array of X features</span>

<span class="sd">            Returns:</span>
<span class="sd">                (numpy array), array of train and test indices</span>

<span class="sd">        _setup_savedir: method to create a savedir based on the provided model, splitter, selector names and datetime</span>
<span class="sd">            Args:</span>
<span class="sd">                model: (mastml.models.SklearnModel or other estimator object), an estimator, e.g. KernelRidge</span>

<span class="sd">                selector: (mastml.feature_selectors or other selector object), a selector, e.g. EnsembleModelFeatureSelector</span>

<span class="sd">                savepath: (str), string designating the savepath</span>

<span class="sd">            Returns:</span>
<span class="sd">                splitdir: (str), string containing the new subdirectory to save results to</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">splitter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SklearnDataSplitter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sklearn</span><span class="o">.</span><span class="n">model_selection</span><span class="p">,</span> <span class="n">splitter</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="SklearnDataSplitter.get_n_splits"><a class="viewcode-back" href="../../api/mastml.data_splitters.SklearnDataSplitter.html#mastml.data_splitters.SklearnDataSplitter.get_n_splits">[docs]</a>    <span class="k">def</span> <span class="nf">get_n_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">get_n_splits</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span></div>

<div class="viewcode-block" id="SklearnDataSplitter.split"><a class="viewcode-back" href="../../api/mastml.data_splitters.SklearnDataSplitter.html#mastml.data_splitters.SklearnDataSplitter.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_setup_savedir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span> <span class="n">savepath</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;BaggingRegressor&#39;</span><span class="p">:</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">model_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">base_estimator_</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span><span class="n">preprocessor</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="n">selector</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">model_name</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">preprocessor</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">selector</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">day</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> \
            <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">hour</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">minute</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">second</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">savepath</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">splitdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">splitdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">splitdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">splitdir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">splitdir</span></div>


<div class="viewcode-block" id="NoSplit"><a class="viewcode-back" href="../../api/mastml.data_splitters.NoSplit.html#mastml.data_splitters.NoSplit">[docs]</a><span class="k">class</span> <span class="nc">NoSplit</span><span class="p">(</span><span class="n">BaseSplitter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to just train the model on the training data and test it on that same data. Sometimes referred to as a &quot;Full fit&quot;</span>
<span class="sd">    or a &quot;Single fit&quot;, equivalent to just plotting y vs. x.</span>

<span class="sd">    Args:</span>
<span class="sd">        None (only object instance)</span>

<span class="sd">    Methods:</span>
<span class="sd">        get_n_splits: method to calculate the number of splits to perform</span>
<span class="sd">            Args:</span>
<span class="sd">                None</span>

<span class="sd">            Returns:</span>
<span class="sd">                (int), always 1 as only a single split is performed</span>

<span class="sd">        split: method to perform split into train indices and test indices</span>
<span class="sd">            Args:</span>
<span class="sd">                X: (numpy array), array of X features</span>

<span class="sd">            Returns:</span>
<span class="sd">                (numpy array), array of train and test indices (all data used as train and test for NoSplit)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NoSplit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="NoSplit.get_n_splits"><a class="viewcode-back" href="../../api/mastml.data_splitters.NoSplit.html#mastml.data_splitters.NoSplit.get_n_splits">[docs]</a>    <span class="k">def</span> <span class="nf">get_n_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="NoSplit.split"><a class="viewcode-back" href="../../api/mastml.data_splitters.NoSplit.html#mastml.data_splitters.NoSplit.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[[</span><span class="n">indices</span><span class="p">,</span> <span class="n">indices</span><span class="p">]]</span></div></div>


<div class="viewcode-block" id="JustEachGroup"><a class="viewcode-back" href="../../api/mastml.data_splitters.JustEachGroup.html#mastml.data_splitters.JustEachGroup">[docs]</a><span class="k">class</span> <span class="nc">JustEachGroup</span><span class="p">(</span><span class="n">BaseSplitter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to train the model on one group at a time and test it on the rest of the data</span>
<span class="sd">    This class wraps scikit-learn&#39;s LeavePGroupsOut with P set to n-1. More information is available at:</span>
<span class="sd">    http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.LeavePGroupsOut.html</span>

<span class="sd">    Args:</span>
<span class="sd">        None (only object instance)</span>

<span class="sd">    Methods:</span>
<span class="sd">        get_n_splits: method to calculate the number of splits to perform</span>
<span class="sd">            Args:</span>
<span class="sd">                groups: (numpy array), array of group labels</span>

<span class="sd">            Returns:</span>
<span class="sd">                (int), number of unique groups, indicating number of splits to perform</span>

<span class="sd">        split: method to perform split into train indices and test indices</span>
<span class="sd">            Args:</span>
<span class="sd">                X: (numpy array), array of X features</span>

<span class="sd">                y: (numpy array), array of y data</span>

<span class="sd">                groups: (numpy array), array of group labels</span>

<span class="sd">            Returns:</span>
<span class="sd">                (numpy array), array of train and test indices</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">JustEachGroup</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<div class="viewcode-block" id="JustEachGroup.get_n_splits"><a class="viewcode-back" href="../../api/mastml.data_splitters.JustEachGroup.html#mastml.data_splitters.JustEachGroup.get_n_splits">[docs]</a>    <span class="k">def</span> <span class="nf">get_n_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="JustEachGroup.split"><a class="viewcode-back" href="../../api/mastml.data_splitters.JustEachGroup.html#mastml.data_splitters.JustEachGroup.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>
        <span class="n">n_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_n_splits</span><span class="p">(</span><span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">)</span>
        <span class="n">lpgo</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">LeavePGroupsOut</span><span class="p">(</span><span class="n">n_groups</span><span class="o">=</span><span class="n">n_groups</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">trains_tests</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span> <span class="ow">in</span> <span class="n">lpgo</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>
            <span class="n">trains_tests</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">train_index</span><span class="p">,</span> <span class="n">test_index</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">trains_tests</span></div></div>


<div class="viewcode-block" id="LeaveCloseCompositionsOut"><a class="viewcode-back" href="../../api/mastml.data_splitters.LeaveCloseCompositionsOut.html#mastml.data_splitters.LeaveCloseCompositionsOut">[docs]</a><span class="k">class</span> <span class="nc">LeaveCloseCompositionsOut</span><span class="p">(</span><span class="n">BaseSplitter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Leave-P-out where you exclude materials with compositions close to those the test set</span>

<span class="sd">    Computes the distance between the element fraction vectors. For example, the :math:`L_2`</span>
<span class="sd">    distance between Al and Cu is :math:`\sqrt{2}` and the :math:`L_1` distance between Al</span>
<span class="sd">    and Al0.9Cu0.1 is 0.2.</span>

<span class="sd">    Consequently, this splitter requires a list of compositions as the input to `split` rather</span>
<span class="sd">    than the features.</span>

<span class="sd">    Args:</span>
<span class="sd">        composition_df (pd.DataFrame): dataframe containing the vector of material compositions to analyze</span>

<span class="sd">        dist_threshold (float): Entries must be farther than this distance to be included in the training set</span>

<span class="sd">        nn_kwargs (dict): Keyword arguments for the scikit-learn NearestNeighbor class used to find nearest points</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">composition_df</span><span class="p">,</span> <span class="n">dist_threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">nn_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LeaveCloseCompositionsOut</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">nn_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nn_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span> <span class="o">=</span> <span class="n">composition_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_threshold</span> <span class="o">=</span> <span class="n">dist_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nn_kwargs</span> <span class="o">=</span> <span class="n">nn_kwargs</span>

<div class="viewcode-block" id="LeaveCloseCompositionsOut.split"><a class="viewcode-back" href="../../api/mastml.data_splitters.LeaveCloseCompositionsOut.html#mastml.data_splitters.LeaveCloseCompositionsOut.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Generate the composition vectors</span>
        <span class="n">frac_computer</span> <span class="o">=</span> <span class="n">ElementFraction</span><span class="p">()</span>
        <span class="n">elem_fracs</span> <span class="o">=</span> <span class="n">frac_computer</span><span class="o">.</span><span class="n">featurize_many</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Composition</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]])),</span> <span class="n">pbar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Generate the nearest-neighbor lookup tool</span>
        <span class="n">neigh</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">nn_kwargs</span><span class="p">)</span>
        <span class="n">neigh</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">elem_fracs</span><span class="p">)</span>

        <span class="c1"># Generate a list of all entries</span>
        <span class="n">all_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Loop through each entry in X</span>
        <span class="n">trains_tests</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">elem_fracs</span><span class="p">):</span>

            <span class="c1"># Get all the entries within the threshold distance of the test point</span>
            <span class="n">too_close</span><span class="p">,</span> <span class="o">=</span> <span class="n">neigh</span><span class="o">.</span><span class="n">radius_neighbors</span><span class="p">([</span><span class="n">x</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_threshold</span><span class="p">,</span> <span class="n">return_distance</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Get the training set as &quot;not these points&quot;</span>
            <span class="n">train_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">all_inds</span><span class="p">,</span> <span class="n">too_close</span><span class="p">)</span>
            <span class="n">test_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">all_inds</span><span class="p">,</span> <span class="n">train_inds</span><span class="p">)</span>

            <span class="n">trains_tests</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">train_inds</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">test_inds</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">trains_tests</span></div>

<div class="viewcode-block" id="LeaveCloseCompositionsOut.get_n_splits"><a class="viewcode-back" href="../../api/mastml.data_splitters.LeaveCloseCompositionsOut.html#mastml.data_splitters.LeaveCloseCompositionsOut.get_n_splits">[docs]</a>    <span class="k">def</span> <span class="nf">get_n_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="LeaveOutPercent"><a class="viewcode-back" href="../../api/mastml.data_splitters.LeaveOutPercent.html#mastml.data_splitters.LeaveOutPercent">[docs]</a><span class="k">class</span> <span class="nc">LeaveOutPercent</span><span class="p">(</span><span class="n">BaseSplitter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to train the model using a certain percentage of data as training data</span>

<span class="sd">    Args:</span>
<span class="sd">        percent_leave_out (float): fraction of data to use in training (must be &gt; 0 and &lt; 1)</span>

<span class="sd">        n_repeats (int): number of repeated splits to perform (must be &gt;= 1)</span>

<span class="sd">    Methods:</span>
<span class="sd">        get_n_splits: method to return the number of splits to perform</span>
<span class="sd">            Args:</span>
<span class="sd">                groups: (numpy array), array of group labels</span>

<span class="sd">            Returns:</span>
<span class="sd">                (int), number of unique groups, indicating number of splits to perform</span>

<span class="sd">        split: method to perform split into train indices and test indices</span>
<span class="sd">            Args:</span>
<span class="sd">                X: (numpy array), array of X features</span>

<span class="sd">                y: (numpy array), array of y data</span>

<span class="sd">                groups: (numpy array), array of group labels</span>

<span class="sd">            Returns:</span>
<span class="sd">                (numpy array), array of train and test indices</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">percent_leave_out</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">n_repeats</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LeaveOutPercent</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">percent_leave_out</span> <span class="o">=</span> <span class="n">percent_leave_out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_repeats</span> <span class="o">=</span> <span class="n">n_repeats</span>

<div class="viewcode-block" id="LeaveOutPercent.get_n_splits"><a class="viewcode-back" href="../../api/mastml.data_splitters.LeaveOutPercent.html#mastml.data_splitters.LeaveOutPercent.get_n_splits">[docs]</a>    <span class="k">def</span> <span class="nf">get_n_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_repeats</span></div>

<div class="viewcode-block" id="LeaveOutPercent.split"><a class="viewcode-back" href="../../api/mastml.data_splitters.LeaveOutPercent.html#mastml.data_splitters.LeaveOutPercent.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">split</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_repeats</span><span class="p">):</span>
            <span class="n">trains</span><span class="p">,</span> <span class="n">tests</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">percent_leave_out</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">split</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">trains</span><span class="p">,</span> <span class="n">tests</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">split</span></div></div>


<div class="viewcode-block" id="LeaveOutTwinCV"><a class="viewcode-back" href="../../api/mastml.data_splitters.LeaveOutTwinCV.html#mastml.data_splitters.LeaveOutTwinCV">[docs]</a><span class="k">class</span> <span class="nc">LeaveOutTwinCV</span><span class="p">(</span><span class="n">BaseSplitter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to remove data twins from the test data.</span>

<span class="sd">    Args:</span>
<span class="sd">        threshold: (int), the threshold at which two data points are considered twins. Default 0.</span>

<span class="sd">        ord: (int), The order of the norm of the difference (see scipy.spatial.distance.minkowski). Default 2 (Euclidean Distance).</span>

<span class="sd">        auto_threshold: (boolean), true if threshold should be automatically increased until twins corresponding to the ceiling parameter are found. Default False.</span>
<span class="sd">        ceiling: (float), fraction of total data to find as twins. Default 0.</span>

<span class="sd">    Methods:</span>
<span class="sd">        get_n_splits: method to calculate the number of splits to perform across all splitters</span>
<span class="sd">            Args:</span>
<span class="sd">                X: (numpy array), array of X features</span>

<span class="sd">                y: (numpy array), array of y data</span>

<span class="sd">                groups: (numpy array), array of group labels</span>

<span class="sd">            Returns:</span>
<span class="sd">                (int), the number 1 always</span>

<span class="sd">        split: method to perform split into train indices and test indices</span>
<span class="sd">            Args:</span>
<span class="sd">                X: (numpy array), array of X features</span>

<span class="sd">                y: (numpy array), array of y data</span>

<span class="sd">                groups: (numpy array), array of group labels</span>

<span class="sd">            Returns:</span>
<span class="sd">                (numpy array), array of train and test indices</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auto_threshold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ceiling</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ord</span> <span class="o">=</span> <span class="nb">ord</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_threshold</span> <span class="o">=</span> <span class="n">auto_threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ceiling</span> <span class="o">=</span> <span class="n">ceiling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitdir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="se">\t\t</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="LeaveOutTwinCV.get_n_splits"><a class="viewcode-back" href="../../api/mastml.data_splitters.LeaveOutTwinCV.html#mastml.data_splitters.LeaveOutTwinCV.get_n_splits">[docs]</a>    <span class="k">def</span> <span class="nf">get_n_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># self.splitdir (if it exists at this point) must be None else the internal call will create a excel file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">save_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitdir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">splitdir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c1"># internal call</span>
        <span class="n">actual_splits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">splitdir</span> <span class="o">=</span> <span class="n">save_dir</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual_splits</span><span class="p">)</span></div>

<div class="viewcode-block" id="LeaveOutTwinCV.split"><a class="viewcode-back" href="../../api/mastml.data_splitters.LeaveOutTwinCV.html#mastml.data_splitters.LeaveOutTwinCV.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">X_noinput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">origIdx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">twinIdx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ceiling</span> <span class="o">*</span> <span class="n">l</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">autothreshold_num_twins</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>

        <span class="c1"># compute all twins</span>
        <span class="k">while</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">twinIdx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">):</span>
                        <span class="c1"># calculate distance</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">minkowski</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ord</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">twinIdx</span><span class="p">:</span>
                                <span class="n">twinIdx</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">twinIdx</span><span class="p">:</span>
                                <span class="n">twinIdx</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="c1"># update threshold if needed</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_threshold</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">autothreshold_num_twins</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">threshold</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">twinIdx</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">threshold</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="n">threshold</span> <span class="o">*=</span> <span class="mf">1.1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Thresholds / Number of Twins&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">th</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">autothreshold_num_twins</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">th</span><span class="si">}</span><span class="se">\t</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_threshold</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AutoThreshold was enabled for LeaveOutTwinCV.&quot;</span><span class="p">)</span>
        <span class="c1">#     print(&quot;Thresholds / Number of Twins&quot;)</span>
        <span class="c1">#     for th, num in autothreshold_num_twins:</span>
        <span class="c1">#         print(f&quot;{th}\t{num}&quot;)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">splitdir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">autothreshold_num_twins</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">autothreshold_num_twins</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Threshold&quot;</span><span class="p">,</span> <span class="s2">&quot;n_twins&quot;</span><span class="p">])</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;autothreshold_num_twins&quot;</span>
            <span class="n">autothreshold_num_twins</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">splitdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># remove twins from original indices</span>
        <span class="n">twinIdx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">twinIdx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">twinIdx</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">origIdx</span><span class="p">:</span>
                <span class="n">origIdx</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">origIdx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">origIdx</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Non-Twins / Twins&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">origIdx</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">twinIdx</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">origIdx</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: All data was marked as twins. Consider reducing threshold or enabling autothreshold. If you are using autothreshold make sure ceiling &lt; 1.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">twinIdx</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: No data twins were found, returning train/test split as empty. Consider increasing threshold or setting autothreshold to True.&quot;</span><span class="p">)</span>

        <span class="n">splits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">origIdx</span><span class="p">,</span> <span class="n">twinIdx</span><span class="p">])</span>
        <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">twinIdx</span><span class="p">,</span> <span class="n">origIdx</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">splits</span></div></div>


<div class="viewcode-block" id="Bootstrap"><a class="viewcode-back" href="../../api/mastml.data_splitters.Bootstrap.html#mastml.data_splitters.Bootstrap">[docs]</a><span class="k">class</span> <span class="nc">Bootstrap</span><span class="p">(</span><span class="n">BaseSplitter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    # Note: Bootstrap taken directly from sklearn Github (https://github.com/scikit-learn/scikit-learn/blob/0.11.X/sklearn/cross_validation.py)</span>
<span class="sd">    # which was necessary as it was later removed from more recent sklearn releases</span>
<span class="sd">    Random sampling with replacement cross-validation iterator</span>
<span class="sd">    Provides train/test indices to split data in train test sets</span>
<span class="sd">    while resampling the input n_bootstraps times: each time a new</span>
<span class="sd">    random split of the data is performed and then samples are drawn</span>
<span class="sd">    (with replacement) on each side of the split to build the training</span>
<span class="sd">    and test sets.</span>
<span class="sd">    Note: contrary to other cross-validation strategies, bootstrapping</span>
<span class="sd">    will allow some samples to occur several times in each splits. However</span>
<span class="sd">    a sample that occurs in the train split will never occur in the test</span>
<span class="sd">    split and vice-versa.</span>
<span class="sd">    If you want each sample to occur at most once you should probably</span>
<span class="sd">    use ShuffleSplit cross validation instead.</span>

<span class="sd">    Args:</span>
<span class="sd">        n: (int), total number of elements in the dataset</span>

<span class="sd">        n_bootstraps: (int), (default is 3) Number of bootstrapping iterations</span>

<span class="sd">        train_size: (int or float), (default is 0.5) If int, number of samples to include in the training split</span>
<span class="sd">            (should be smaller than the total number of samples passed in the dataset).</span>
<span class="sd">            If float, should be between 0.0 and 1.0 and represent the</span>
<span class="sd">            proportion of the dataset to include in the train split.</span>

<span class="sd">        test_size: (int or float or None), (default is None)</span>
<span class="sd">            If int, number of samples to include in the training set</span>
<span class="sd">            (should be smaller than the total number of samples passed</span>
<span class="sd">            in the dataset).</span>
<span class="sd">            If float, should be between 0.0 and 1.0 and represent the</span>
<span class="sd">            proportion of the dataset to include in the test split.</span>
<span class="sd">            If None, n_test is set as the complement of n_train.</span>

<span class="sd">        random_state: (int or RandomState), Pseudo number generator state used for random sampling.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Static marker to be able to introspect the CV type</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n_bootstraps</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">n_train</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_test</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Bootstrap</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_bootstraps</span> <span class="o">=</span> <span class="n">n_bootstraps</span>
        <span class="k">if</span> <span class="n">n_train</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">train_size</span> <span class="o">=</span> <span class="n">n_train</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;n_train is deprecated in 0.11 and scheduled for &quot;</span>
                <span class="s2">&quot;removal in 0.12, use train_size instead&quot;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test_size</span> <span class="o">=</span> <span class="n">n_test</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;n_test is deprecated in 0.11 and scheduled for &quot;</span>
                <span class="s2">&quot;removal in 0.12, use test_size instead&quot;</span><span class="p">,</span>
                <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">train_size</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">train_size</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">train_size</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_size</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">train_size</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">train_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_size</span> <span class="o">=</span> <span class="n">train_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for train_size: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span>
                             <span class="n">train_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_size</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;train_size=</span><span class="si">%d</span><span class="s2"> should not be larger than n=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_size</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">test_size</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">test_size</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">test_size</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span><span class="n">test_size</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">=</span> <span class="n">test_size</span>
        <span class="k">elif</span> <span class="n">test_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for test_size: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">test_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;test_size=</span><span class="si">%d</span><span class="s2"> should not be larger than n=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">check_random_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_bootstraps</span><span class="p">):</span>
            <span class="c1"># random partition</span>
            <span class="n">permutation</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
            <span class="n">ind_train</span> <span class="o">=</span> <span class="n">permutation</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">train_size</span><span class="p">]</span>
            <span class="n">ind_test</span> <span class="o">=</span> <span class="n">permutation</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">train_size</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">train_size</span>
                                   <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">]</span>

            <span class="c1"># bootstrap in each split individually</span>
            <span class="n">train</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_size</span><span class="p">,</span>
                                <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_size</span><span class="p">,))</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">,</span>
                               <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">,))</span>
            <span class="k">yield</span> <span class="n">ind_train</span><span class="p">[</span><span class="n">train</span><span class="p">],</span> <span class="n">ind_test</span><span class="p">[</span><span class="n">test</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%d</span><span class="s1">, n_bootstraps=</span><span class="si">%d</span><span class="s1">, train_size=</span><span class="si">%d</span><span class="s1">, test_size=</span><span class="si">%d</span><span class="s1">, &#39;</span>
                <span class="s1">&#39;random_state=</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_bootstraps</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">train_size</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">test_size</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
                <span class="p">))</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_bootstraps</span>

<div class="viewcode-block" id="Bootstrap.get_n_splits"><a class="viewcode-back" href="../../api/mastml.data_splitters.Bootstrap.html#mastml.data_splitters.Bootstrap.get_n_splits">[docs]</a>    <span class="k">def</span> <span class="nf">get_n_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span></div>

<div class="viewcode-block" id="Bootstrap.split"><a class="viewcode-back" href="../../api/mastml.data_splitters.Bootstrap.html#mastml.data_splitters.Bootstrap.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">split</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">trains</span><span class="p">,</span> <span class="n">tests</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">split</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">trains</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">tests</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">split</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2021, University of Wisconsin-Madison Computational Materials Group

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>