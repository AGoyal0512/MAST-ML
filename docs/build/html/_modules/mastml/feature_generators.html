

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mastml.feature_generators &mdash; MAterials Simulation Toolkit for Machine Learning (MAST-ML) 2.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> MAterials Simulation Toolkit for Machine Learning (MAST-ML)
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../00_acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../0_4_majorchanges.html">MAST-ML version 3.x</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../0_4_majorchanges.html#new-changes-to-mast-ml">New changes to MAST-ML</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../0_installation.html">Installing MAST-ML</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../0_1_hardware_data_requirements.html">Hardware and Data Requirements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../0_1_hardware_data_requirements.html#hardware">Hardware</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../0_1_hardware_data_requirements.html#data">Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../0_1_terminal_installation.html">Terminal installation (Linux or linux-like terminal environment e.g. Mac)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../0_1_terminal_installation.html#install-python3">Install Python3</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../0_1_terminal_installation.html#create-a-conda-environment-if-using-anaconda">Create a conda environment (if using Anaconda)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../0_1_terminal_installation.html#create-a-virtualenv-environment-if-not-using-anaconda">Create a virtualenv environment (if not using Anaconda)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../0_1_terminal_installation.html#install-the-mast-ml-package-via-pypi">Install the MAST-ML package via PyPi</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../0_1_terminal_installation.html#install-the-mast-ml-package-via-git">Install the MAST-ML package via Git</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../0_1_terminal_installation.html#set-up-juptyer-notebooks">Set up Juptyer notebooks</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../0_1_terminal_installation.html#imports-that-dont-work">Imports that don’t work</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../0_2_windows_installation.html">Windows installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../0_2_windows_installation.html#install-python3">Install Python3</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../0_2_windows_installation.html#create-a-conda-environment">Create a conda environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../0_2_windows_installation.html#set-up-the-spyder-ide-and-jupyter-notebooks">Set up the Spyder IDE and Jupyter notebooks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../0_2_windows_installation.html#install-the-mast-ml-package">Install the MAST-ML package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../0_2_windows_installation.html#imports-that-dont-work">Imports that don’t work</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../0_2_windows_installation.html#windows-10-install-step-by-step-guide-credit-joe-kern">Windows 10 install: step-by-step guide (credit Joe Kern)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../0_3_startup.html">Getting Started with MAST-ML</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../0_3_startup.html#installing-mast-ml">Installing MAST-ML</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../0_3_startup.html#performing-your-first-mast-ml-run">Performing your first MAST-ML run</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../0_5_tutorials.html">Overview of MAST-ML tutorials and examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../0_5_tutorials.html#mast-ml-tutorials">MAST-ML tutorials</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../1_data_cleaning.html">Code Documentation: Data Cleaning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../1_data_cleaning.html#module-mastml.data_cleaning">mastml.data_cleaning Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../1_data_cleaning.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_cleaning.DataCleaning.html">DataCleaning</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_cleaning.DataUtilities.html">DataUtilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_cleaning.PPCA.html">PPCA</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../1_data_cleaning.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../2_data_splitters.html">Code Documentation: Data Splitters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../2_data_splitters.html#module-mastml.data_splitters">mastml.data_splitters Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../2_data_splitters.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.BaseSplitter.html">BaseSplitter</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.Bootstrap.html">Bootstrap</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.JustEachGroup.html">JustEachGroup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.LeaveCloseCompositionsOut.html">LeaveCloseCompositionsOut</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.LeaveOutPercent.html">LeaveOutPercent</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.LeaveOutTwinCV.html">LeaveOutTwinCV</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.NoSplit.html">NoSplit</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.data_splitters.SklearnDataSplitter.html">SklearnDataSplitter</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../2_data_splitters.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../3_datasets.html">Code Documentation: Datasets</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../3_datasets.html#module-mastml.datasets">mastml.datasets Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../3_datasets.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.datasets.FigshareDatasets.html">FigshareDatasets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.datasets.FoundryDatasets.html">FoundryDatasets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.datasets.LocalDatasets.html">LocalDatasets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.datasets.MatminerDatasets.html">MatminerDatasets</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.datasets.SklearnDatasets.html">SklearnDatasets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../3_datasets.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../4_error_analysis.html">Code Documentation: Error Analysis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../4_error_analysis.html#module-mastml.error_analysis">mastml.error_analysis Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../4_error_analysis.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.error_analysis.CorrectionFactors.html">CorrectionFactors</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.error_analysis.ErrorUtils.html">ErrorUtils</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../4_error_analysis.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../5_feature_generators.html">Code Documentation: Feature Generators</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../5_feature_generators.html#module-mastml.feature_generators">mastml.feature_generators Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../5_feature_generators.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.BaseGenerator.html">BaseGenerator</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.DataframeUtilities.html">DataframeUtilities</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.ElementalFeatureGenerator.html">ElementalFeatureGenerator</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.MaterialsProjectFeatureGenerator.html">MaterialsProjectFeatureGenerator</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.MatminerFeatureGenerator.html">MatminerFeatureGenerator</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.OneHotElementEncoder.html">OneHotElementEncoder</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.OneHotGroupGenerator.html">OneHotGroupGenerator</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_generators.PolynomialFeatureGenerator.html">PolynomialFeatureGenerator</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../5_feature_generators.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../6_feature_selectors.html">Code Documentation: Feature Selectors</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../6_feature_selectors.html#module-mastml.feature_selectors">mastml.feature_selectors Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../6_feature_selectors.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_selectors.BaseSelector.html">BaseSelector</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_selectors.EnsembleModelFeatureSelector.html">EnsembleModelFeatureSelector</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_selectors.MASTMLFeatureSelector.html">MASTMLFeatureSelector</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_selectors.NoSelect.html">NoSelect</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_selectors.PearsonSelector.html">PearsonSelector</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.feature_selectors.SklearnFeatureSelector.html">SklearnFeatureSelector</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../6_feature_selectors.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../7_hyper_opt.html">Code Documentation: Hyperparameter Optimization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../7_hyper_opt.html#module-mastml.hyper_opt">mastml.hyper_opt Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../7_hyper_opt.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.hyper_opt.BayesianSearch.html">BayesianSearch</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.hyper_opt.GridSearch.html">GridSearch</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.hyper_opt.HyperOptUtils.html">HyperOptUtils</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.hyper_opt.RandomizedSearch.html">RandomizedSearch</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../7_hyper_opt.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../8_learning_curve.html">Code Documentation: Learning Curve</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../8_learning_curve.html#module-mastml.learning_curve">mastml.learning_curve Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../8_learning_curve.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.learning_curve.LearningCurve.html">LearningCurve</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../8_learning_curve.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../9_mastml.html">Code Documentation: Mastml</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../9_mastml.html#module-mastml.mastml">mastml.mastml Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../9_mastml.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.mastml.Mastml.html">Mastml</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../9_mastml.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../10_metrics.html">Code Documentation: Metrics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../10_metrics.html#module-mastml.metrics">mastml.metrics Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../10_metrics.html#functions">Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.metrics.r2_score_adjusted.html">r2_score_adjusted</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.metrics.r2_score_fitted.html">r2_score_fitted</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.metrics.r2_score_noint.html">r2_score_noint</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.metrics.rmse_over_stdev.html">rmse_over_stdev</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.metrics.root_mean_squared_error.html">root_mean_squared_error</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../10_metrics.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.metrics.Metrics.html">Metrics</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../10_metrics.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../11_models.html">Code Documentation: Models</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../11_models.html#module-mastml.models">mastml.models Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../11_models.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.models.EnsembleModel.html">EnsembleModel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.models.SklearnModel.html">SklearnModel</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../11_models.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../12_plots.html">Code Documentation: Plots</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../12_plots.html#module-mastml.plots">mastml.plots Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../12_plots.html#functions">Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.check_dimensions.html">check_dimensions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.get_divisor.html">get_divisor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.make_axis_same.html">make_axis_same</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.make_fig_ax.html">make_fig_ax</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.make_fig_ax_square.html">make_fig_ax_square</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.make_plots.html">make_plots</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.nice_mean.html">nice_mean</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.nice_names.html">nice_names</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.nice_range.html">nice_range</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.nice_std.html">nice_std</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.plot_stats.html">plot_stats</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.recursive_max.html">recursive_max</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.recursive_max_and_min.html">recursive_max_and_min</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.recursive_min.html">recursive_min</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.reset_index.html">reset_index</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.round_down.html">round_down</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.round_up.html">round_up</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.rounder.html">rounder</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.stat_to_string.html">stat_to_string</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.trim_array.html">trim_array</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../12_plots.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.Error.html">Error</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.Histogram.html">Histogram</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.Line.html">Line</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.plots.Scatter.html">Scatter</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../12_plots.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../13_preprocessing.html">Code Documentation: Preprocessing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../13_preprocessing.html#module-mastml.preprocessing">mastml.preprocessing Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../13_preprocessing.html#classes">Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.preprocessing.BasePreprocessor.html">BasePreprocessor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.preprocessing.MeanStdevScaler.html">MeanStdevScaler</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.preprocessing.NoPreprocessor.html">NoPreprocessor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/mastml.preprocessing.SklearnPreprocessor.html">SklearnPreprocessor</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../13_preprocessing.html#class-inheritance-diagram">Class Inheritance Diagram</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MAterials Simulation Toolkit for Machine Learning (MAST-ML)</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>mastml.feature_generators</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mastml.feature_generators</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains a collection of classes for generating input features to fit machine learning models to.</span>

<span class="sd">BaseGenerator:</span>
<span class="sd">    Base class to provide MAST-ML type functionality to all feature generators. All other feature generator classes</span>
<span class="sd">    should inherit from this base class</span>

<span class="sd">ElementalFeatureGenerator:</span>
<span class="sd">    Class written for MAST-ML to generate features for material compositions based on properties of the elements</span>
<span class="sd">    comprising the composition. A number of mathematically derived variants are included, like arithmetic average,</span>
<span class="sd">    composition-weighted average, range, max, and min. This generator also supports sublattice-based generation, where</span>
<span class="sd">    the elemental features can be averaged for each sublattice as opposed to just the total composition together. To</span>
<span class="sd">    use the sublattice feature of this generator, composition strings must include square brackets to separate the sublattices,</span>
<span class="sd">    e.g. the perovskite material La0.75Sr0.25MnO3 would be written as [La0.75Sr0.25][Mn][O3]</span>

<span class="sd">PolynomialFeatureGenerator:</span>
<span class="sd">    Class used to construct new features based on a polynomial expansion of existing features. The degree of the</span>
<span class="sd">    polynomial is given as input. For example, for two features x1 and x2, the quadratic features x1^2, x2^2 and x1*x2</span>
<span class="sd">    would be generated if the degree is set to 2.</span>

<span class="sd">OneHotGroupGenerator:</span>
<span class="sd">    Class used to create a set of one-hot encoded features based on a single feature containing assorted categories.</span>
<span class="sd">    For example, if a feature contains strings denoting each data point as belonging to one of three groups such as</span>
<span class="sd">    &quot;metal&quot;, &quot;semiconductor&quot;, &quot;insulator&quot;, then the generated one-hot features are three feature columns containing a 1 or</span>
<span class="sd">    0 to denote which group each data point is in</span>

<span class="sd">OneHotElementEncoder:</span>
<span class="sd">    Class used to create a set of one-hot encoded features based on elements present in a supplied chemical composition string.</span>
<span class="sd">    For example, if the data set contains alloys of materials with chemical formulas such as &quot;GaAs&quot;, &quot;InAs&quot;, &quot;InP&quot;, etc.,</span>
<span class="sd">    then the generated one-hot features are four feature columns containing a 1 or 0 to denote whether a particular data</span>
<span class="sd">    point contains each of the unique elements, in this case Ga, As, In, or P.</span>

<span class="sd">MaterialsProjectFeatureGenerator:</span>
<span class="sd">    Class used to search the Materials Project database for computed material property information for the</span>
<span class="sd">    supplied composition. This only works if the material composition matches an entry present in the Materials Project.</span>
<span class="sd">    Will return material properties like formation energy, volume, electronic bandgap, elastic constants, etc.</span>

<span class="sd">MatminerFeatureGenerator:</span>
<span class="sd">    Class used to combine various composition and structure-based feature generation routines in the matminer package</span>
<span class="sd">    into MAST-ML. The use of structure-based features will require pymatgen structure objects in the input</span>
<span class="sd">    dataframe, while composition-based features require only a composition string. See the class documentation</span>
<span class="sd">    for more information on the different types of feature generation this class supports.</span>

<span class="sd">DataframeUtilities:</span>
<span class="sd">    Collection of helper routines for various common dataframe operations, like concatentation, merging, etc.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span><span class="p">,</span> <span class="n">OneHotEncoder</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matminer</span>
    <span class="kn">import</span> <span class="nn">matminer.featurizers.structure</span>
    <span class="kn">import</span> <span class="nn">matminer.featurizers.site</span>
    <span class="kn">from</span> <span class="nn">matminer.featurizers.composition</span> <span class="kn">import</span> <span class="n">ElementProperty</span><span class="p">,</span> <span class="n">OxidationStates</span>
    <span class="kn">from</span> <span class="nn">matminer.featurizers.conversions</span> <span class="kn">import</span> <span class="n">StrToComposition</span><span class="p">,</span> <span class="n">CompositionToOxidComposition</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;matminer is an optional dependency. To install matminer, do pip install matminer&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pymatgen</span>
    <span class="kn">from</span> <span class="nn">pymatgen</span> <span class="kn">import</span> <span class="n">Element</span><span class="p">,</span> <span class="n">Composition</span>
    <span class="kn">from</span> <span class="nn">pymatgen.ext.matproj</span> <span class="kn">import</span> <span class="n">MPRester</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;pymatgen is an optional dependency. To install pymatgen, do pip install pymatgen&#39;</span><span class="p">)</span>

<span class="c1"># locate path to directory containing AtomicNumber.table, AtomicRadii.table AtomicVolume.table, etc</span>
<span class="c1"># (needs to do it the hard way becuase python -m sets cwd to wherever python is ran from)</span>
<span class="kn">import</span> <span class="nn">mastml</span>
<span class="n">MAGPIE_DATA_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mastml</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;magpie&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="BaseGenerator"><a class="viewcode-back" href="../../api/mastml.feature_generators.BaseGenerator.html#mastml.feature_generators.BaseGenerator">[docs]</a><span class="k">class</span> <span class="nc">BaseGenerator</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class functioning as a base generator to support directory organization and evaluating different feature generators</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>

<span class="sd">    Methods:</span>
<span class="sd">        evaluate: main method to run feature generators on supplied data, and save to file</span>
<span class="sd">            Args:</span>
<span class="sd">                X: (pd.DataFrame), dataframe of X data containing features and composition string information</span>

<span class="sd">                y: (pd.Series), series of y target data</span>

<span class="sd">                savepath: (str) string denoting the main save path directory</span>

<span class="sd">            Returns:</span>
<span class="sd">                X: (pd.DataFrame), dataframe of X features containing newly generated features</span>

<span class="sd">                y: (pd.Series), series of y target data</span>

<span class="sd">        _setup_savedir: method to set up a save directory for the generated dataset</span>
<span class="sd">            Args:</span>
<span class="sd">                generator: mastml.feature_generators instance, e.g. ElementalFeatureGenerator</span>

<span class="sd">                savepath: (str) string denoting the main save path directory</span>

<span class="sd">            Returns:</span>
<span class="sd">                splitdir: (str) string of the split directory where generated feature data is saved</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="BaseGenerator.evaluate"><a class="viewcode-back" href="../../api/mastml.feature_generators.BaseGenerator.html#mastml.feature_generators.BaseGenerator.evaluate">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">make_new_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">X_orig</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">savepath</span><span class="p">:</span>
            <span class="n">savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">make_new_dir</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">splitdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_savedir</span><span class="p">(</span><span class="n">generator</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">savepath</span><span class="p">)</span>
            <span class="n">savepath</span> <span class="o">=</span> <span class="n">splitdir</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
        <span class="c1"># Join the originally provided feature set with the new feature set</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_orig</span><span class="p">,</span> <span class="n">X</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="s1">&#39;generated_features.xlsx&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning! Excel file too large to save.&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="s1">&#39;generated_features.pickle&#39;</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span></div>

    <span class="k">def</span> <span class="nf">_setup_savedir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">savepath</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">month</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">day</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span> \
                        <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">hour</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">minute</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">now</span><span class="o">.</span><span class="n">second</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">savepath</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">splitdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">splitdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">splitdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">splitdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitdir</span> <span class="o">=</span> <span class="n">splitdir</span>
        <span class="k">return</span> <span class="n">splitdir</span></div>


<div class="viewcode-block" id="ElementalFeatureGenerator"><a class="viewcode-back" href="../../api/mastml.feature_generators.ElementalFeatureGenerator.html#mastml.feature_generators.ElementalFeatureGenerator">[docs]</a><span class="k">class</span> <span class="nc">ElementalFeatureGenerator</span><span class="p">(</span><span class="n">BaseGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class that is used to create elemental-based features from material composition strings</span>

<span class="sd">    Args:</span>
<span class="sd">        composition_df: (pd.DataFrame), dataframe containing vector of chemical compositions (strings) to generate elemental features from</span>

<span class="sd">        feature_types: (list), list of strings denoting which elemental feature types to include in the final feature matrix.</span>

<span class="sd">        remove_constant_columns: (bool), whether to remove constant columns from the generated feature set</span>

<span class="sd">    Methods:</span>
<span class="sd">        fit: pass through, copies input columns as pre-generated features</span>
<span class="sd">            Args:</span>
<span class="sd">                X: (pd.DataFrame), input dataframe containing X data</span>

<span class="sd">                y: (pd.Series), series containing y data</span>

<span class="sd">        transform: generate the elemental feature matrix from composition strings</span>
<span class="sd">            Args:</span>
<span class="sd">                None.</span>

<span class="sd">            Returns:</span>
<span class="sd">                X: (dataframe), output dataframe containing generated features</span>

<span class="sd">                y: (series), output y data as series</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">composition_df</span><span class="p">,</span> <span class="n">feature_types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">remove_constant_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BaseGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span> <span class="o">=</span> <span class="n">composition_df</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span> <span class="o">=</span> <span class="n">feature_types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_constant_columns</span> <span class="o">=</span> <span class="n">remove_constant_columns</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;composition_avg&#39;</span><span class="p">,</span> <span class="s1">&#39;arithmetic_avg&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;difference&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="ElementalFeatureGenerator.fit"><a class="viewcode-back" href="../../api/mastml.feature_generators.ElementalFeatureGenerator.html#mastml.feature_generators.ElementalFeatureGenerator.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">#self.df = X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="c1">#self.original_features = self.df.columns</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ElementalFeatureGenerator.transform"><a class="viewcode-back" href="../../api/mastml.feature_generators.ElementalFeatureGenerator.html#mastml.feature_generators.ElementalFeatureGenerator.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_magpie_features</span><span class="p">()</span>

        <span class="c1"># delete missing values, generation makes a lot of garbage.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">DataframeUtilities</span><span class="p">()</span><span class="o">.</span><span class="n">clean_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">([</span><span class="s1">&#39;number&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_constant_columns</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">DataframeUtilities</span><span class="p">()</span><span class="o">.</span><span class="n">remove_constant_columns</span><span class="p">(</span><span class="n">dataframe</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())]</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span></div>

<div class="viewcode-block" id="ElementalFeatureGenerator.generate_magpie_features"><a class="viewcode-back" href="../../api/mastml.feature_generators.ElementalFeatureGenerator.html#mastml.feature_generators.ElementalFeatureGenerator.generate_magpie_features">[docs]</a>    <span class="k">def</span> <span class="nf">generate_magpie_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Replace empty composition fields with empty string instead of NaN</span>
        <span class="c1">#self.df = self.df.fillna(&#39;&#39;)</span>

        <span class="n">compositions_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="c1"># Check first entry of comps to find [] for delimiting different sublattices</span>
        <span class="n">has_sublattices</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;[&#39;</span> <span class="ow">in</span> <span class="n">compositions_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;]&#39;</span> <span class="ow">in</span> <span class="n">compositions_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">has_sublattices</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1">#log.info(&#39;MAGPIE feature generation found brackets in material compositions denoting specific sublattices!&#39;)</span>
                <span class="c1"># Parse raw composition strings with brackets to denote compositions of different sublattices</span>
                <span class="n">site_dict_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">compositions_raw</span><span class="p">:</span>
                    <span class="n">sites</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[([A-Za-z0-9_.]+)\]&quot;</span><span class="p">,</span> <span class="n">comp</span><span class="p">)</span>
                    <span class="n">site_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sites</span><span class="p">):</span>
                        <span class="n">comp_by_site</span> <span class="o">=</span> <span class="n">Composition</span><span class="p">(</span><span class="n">site</span><span class="p">)</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
                        <span class="n">site_dict</span><span class="p">[</span><span class="s1">&#39;Site&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">comp_by_site</span>
                    <span class="n">site_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site_dict</span><span class="p">)</span>

        <span class="n">compositions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">has_sublattices</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Parse out brackets from compositions</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">compositions_raw</span><span class="p">:</span>
                <span class="n">comp_split</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span>
                <span class="n">comp_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">comp_split</span><span class="p">:</span>
                    <span class="n">comp_str</span> <span class="o">+=</span> <span class="n">s</span>
                <span class="n">comp_split</span> <span class="o">=</span> <span class="n">comp_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
                <span class="n">comp_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">comp_split</span><span class="p">:</span>
                    <span class="n">comp_str</span> <span class="o">+=</span> <span class="n">s</span>
                <span class="n">compositions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compositions</span> <span class="o">=</span> <span class="n">compositions_raw</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compositions</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Error! No material compositions column found in your input data file. To use this feature generation routine, you must supply a material composition for each data point&#39;</span><span class="p">)</span>

        <span class="c1"># Add the column of combined material compositions into the dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">compositions</span>

        <span class="c1"># Assign each magpiedata feature set to appropriate composition name</span>
        <span class="n">magpiedata_dict_composition_average</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_arithmetic_average</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_max</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_min</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_difference</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">magpiedata_dict_atomic_bysite</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">magpiedata_dict_composition_average_site1</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_arithmetic_average_site1</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_max_site1</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_min_site1</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_difference_site1</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">magpiedata_dict_composition_average_site2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_arithmetic_average_site2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_max_site2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_min_site2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_difference_site2</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">magpiedata_dict_composition_average_site3</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_arithmetic_average_site3</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_max_site3</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_min_site3</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_difference_site3</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">magpiedata_dict_composition_average_site1site2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_arithmetic_average_site1site2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_max_site1site2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_min_site1site2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_difference_site1site2</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">magpiedata_dict_composition_average_site1site3</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_arithmetic_average_site1site3</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_max_site1site3</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_min_site1site3</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_difference_site1site3</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">magpiedata_dict_composition_average_site2site3</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_arithmetic_average_site2site3</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_max_site2site3</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_min_site2site3</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_dict_difference_site2site3</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">composition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">compositions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">has_sublattices</span><span class="p">:</span>
                <span class="n">magpiedata_collected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_computed_magpie_features</span><span class="p">(</span><span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="p">,</span> <span class="n">data_path</span><span class="o">=</span><span class="n">MAGPIE_DATA_PATH</span><span class="p">,</span> <span class="n">site_dict</span><span class="o">=</span><span class="n">site_dict_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">magpiedata_collected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_computed_magpie_features</span><span class="p">(</span><span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="p">,</span><span class="n">data_path</span><span class="o">=</span><span class="n">MAGPIE_DATA_PATH</span><span class="p">,</span> <span class="n">site_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">magpiedata_atomic_notparsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_atomic_magpie_features</span><span class="p">(</span><span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="p">,</span> <span class="n">data_path</span><span class="o">=</span><span class="n">MAGPIE_DATA_PATH</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">has_sublattices</span><span class="p">:</span>
                <span class="n">number_sites</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">site_dict_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">magpiedata_composition_average</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">magpiedata_arithmetic_average</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">magpiedata_max</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">magpiedata_min</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">magpiedata_difference</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">magpiedata_composition_average_site1</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                    <span class="n">magpiedata_arithmetic_average_site1</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                    <span class="n">magpiedata_max_site1</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                    <span class="n">magpiedata_min_site1</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
                    <span class="n">magpiedata_difference_site1</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>

                    <span class="n">magpiedata_dict_composition_average</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average</span>
                    <span class="n">magpiedata_dict_arithmetic_average</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average</span>
                    <span class="n">magpiedata_dict_max</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max</span>
                    <span class="n">magpiedata_dict_min</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min</span>
                    <span class="n">magpiedata_dict_difference</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference</span>

                    <span class="n">magpiedata_dict_composition_average_site1</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site1</span>
                    <span class="n">magpiedata_dict_arithmetic_average_site1</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site1</span>
                    <span class="n">magpiedata_dict_max_site1</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max_site1</span>
                    <span class="n">magpiedata_dict_min_site1</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min_site1</span>
                    <span class="n">magpiedata_dict_difference_site1</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site1</span>

                <span class="k">elif</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">magpiedata_composition_average</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">magpiedata_arithmetic_average</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">magpiedata_max</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">magpiedata_min</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">magpiedata_difference</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">magpiedata_composition_average_site1</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                    <span class="n">magpiedata_arithmetic_average_site1</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                    <span class="n">magpiedata_max_site1</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                    <span class="n">magpiedata_min_site1</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
                    <span class="n">magpiedata_difference_site1</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
                    <span class="n">magpiedata_composition_average_site2</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
                    <span class="n">magpiedata_arithmetic_average_site2</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
                    <span class="n">magpiedata_max_site2</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
                    <span class="n">magpiedata_min_site2</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>
                    <span class="n">magpiedata_difference_site2</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span>

                    <span class="n">magpiedata_dict_composition_average</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average</span>
                    <span class="n">magpiedata_dict_arithmetic_average</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average</span>
                    <span class="n">magpiedata_dict_max</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max</span>
                    <span class="n">magpiedata_dict_min</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min</span>
                    <span class="n">magpiedata_dict_difference</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference</span>

                    <span class="n">magpiedata_dict_composition_average_site1</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site1</span>
                    <span class="n">magpiedata_dict_arithmetic_average_site1</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site1</span>
                    <span class="n">magpiedata_dict_max_site1</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max_site1</span>
                    <span class="n">magpiedata_dict_min_site1</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min_site1</span>
                    <span class="n">magpiedata_dict_difference_site1</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site1</span>

                    <span class="n">magpiedata_dict_composition_average_site2</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site2</span>
                    <span class="n">magpiedata_dict_arithmetic_average_site2</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site2</span>
                    <span class="n">magpiedata_dict_max_site2</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max_site2</span>
                    <span class="n">magpiedata_dict_min_site2</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min_site2</span>
                    <span class="n">magpiedata_dict_difference_site2</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site2</span>

                <span class="k">elif</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">magpiedata_composition_average</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">magpiedata_arithmetic_average</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">magpiedata_max</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">magpiedata_min</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">magpiedata_difference</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">magpiedata_composition_average_site1</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                    <span class="n">magpiedata_arithmetic_average_site1</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                    <span class="n">magpiedata_max_site1</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                    <span class="n">magpiedata_min_site1</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
                    <span class="n">magpiedata_difference_site1</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
                    <span class="n">magpiedata_composition_average_site2</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
                    <span class="n">magpiedata_arithmetic_average_site2</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
                    <span class="n">magpiedata_max_site2</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
                    <span class="n">magpiedata_min_site2</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>
                    <span class="n">magpiedata_difference_site2</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span>
                    <span class="n">magpiedata_composition_average_site3</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span>
                    <span class="n">magpiedata_arithmetic_average_site3</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span>
                    <span class="n">magpiedata_max_site3</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span>
                    <span class="n">magpiedata_min_site3</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span>
                    <span class="n">magpiedata_difference_site3</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span>

                    <span class="c1"># Couplings between sites</span>
                    <span class="n">magpiedata_composition_average_site1site2</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span>
                    <span class="n">magpiedata_arithmetic_average_site1site2</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span>
                    <span class="n">magpiedata_difference_site1site2</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span>
                    <span class="n">magpiedata_composition_average_site1site3</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span>
                    <span class="n">magpiedata_arithmetic_average_site1site3</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span>
                    <span class="n">magpiedata_difference_site1site3</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span>
                    <span class="n">magpiedata_composition_average_site2site3</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span>
                    <span class="n">magpiedata_arithmetic_average_site2site3</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span>
                    <span class="n">magpiedata_difference_site2site3</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span>

                    <span class="n">magpiedata_dict_composition_average</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average</span>
                    <span class="n">magpiedata_dict_arithmetic_average</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average</span>
                    <span class="n">magpiedata_dict_max</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max</span>
                    <span class="n">magpiedata_dict_min</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min</span>
                    <span class="n">magpiedata_dict_difference</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference</span>

                    <span class="n">magpiedata_dict_composition_average_site1</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site1</span>
                    <span class="n">magpiedata_dict_arithmetic_average_site1</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site1</span>
                    <span class="n">magpiedata_dict_max_site1</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max_site1</span>
                    <span class="n">magpiedata_dict_min_site1</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min_site1</span>
                    <span class="n">magpiedata_dict_difference_site1</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site1</span>

                    <span class="n">magpiedata_dict_composition_average_site2</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site2</span>
                    <span class="n">magpiedata_dict_arithmetic_average_site2</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site2</span>
                    <span class="n">magpiedata_dict_max_site2</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max_site2</span>
                    <span class="n">magpiedata_dict_min_site2</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min_site2</span>
                    <span class="n">magpiedata_dict_difference_site2</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site2</span>

                    <span class="n">magpiedata_dict_composition_average_site3</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site3</span>
                    <span class="n">magpiedata_dict_arithmetic_average_site3</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site3</span>
                    <span class="n">magpiedata_dict_max_site3</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max_site3</span>
                    <span class="n">magpiedata_dict_min_site3</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min_site3</span>
                    <span class="n">magpiedata_dict_difference_site3</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site3</span>

                    <span class="c1"># Site1+Site2 coupling</span>
                    <span class="n">magpiedata_dict_composition_average_site1site2</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site1site2</span>
                    <span class="n">magpiedata_dict_arithmetic_average_site1site2</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site1site2</span>
                    <span class="n">magpiedata_dict_difference_site1site2</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site1site2</span>

                    <span class="c1"># Site1+Site3 coupling</span>
                    <span class="n">magpiedata_dict_composition_average_site1site3</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site1site3</span>
                    <span class="n">magpiedata_dict_arithmetic_average_site1site3</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site1site3</span>
                    <span class="n">magpiedata_dict_difference_site1site3</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site1site3</span>

                    <span class="c1"># Site2+Site3 coupling</span>
                    <span class="n">magpiedata_dict_composition_average_site2site3</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site2site3</span>
                    <span class="n">magpiedata_dict_arithmetic_average_site2site3</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site2site3</span>
                    <span class="n">magpiedata_dict_difference_site2site3</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site2site3</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">magpiedata_composition_average</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">magpiedata_arithmetic_average</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">magpiedata_max</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">magpiedata_min</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">magpiedata_difference</span> <span class="o">=</span> <span class="n">magpiedata_collected</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

                <span class="n">magpiedata_dict_composition_average</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average</span>
                <span class="n">magpiedata_dict_arithmetic_average</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average</span>
                <span class="n">magpiedata_dict_max</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max</span>
                <span class="n">magpiedata_dict_min</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min</span>
                <span class="n">magpiedata_dict_difference</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference</span>

            <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">magpiedata_atomic_bysite</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Also include magpie features of individual elements in the material</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">magpiedata_atomic_notparsed</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">magpiefeature</span><span class="p">,</span> <span class="n">featurevalue</span> <span class="ow">in</span> <span class="n">magpiedata_atomic_notparsed</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">magpiedata_atomic_bysite</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">magpiefeature</span><span class="p">)]</span> <span class="o">=</span> <span class="n">featurevalue</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">magpiedata_dict_atomic_bysite</span><span class="p">[</span><span class="n">composition</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_atomic_bysite</span>

        <span class="k">if</span> <span class="n">has_sublattices</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">magpiedata_dict_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">magpiedata_dict_composition_average</span><span class="p">,</span> <span class="n">magpiedata_dict_arithmetic_average</span><span class="p">,</span>
                                    <span class="n">magpiedata_dict_max</span><span class="p">,</span> <span class="n">magpiedata_dict_min</span><span class="p">,</span> <span class="n">magpiedata_dict_difference</span><span class="p">,</span> <span class="n">magpiedata_dict_atomic_bysite</span><span class="p">,</span>
                                        <span class="n">magpiedata_dict_composition_average_site1</span><span class="p">,</span> <span class="n">magpiedata_dict_arithmetic_average_site1</span><span class="p">,</span>
                                        <span class="n">magpiedata_dict_max_site1</span><span class="p">,</span> <span class="n">magpiedata_dict_min_site1</span><span class="p">,</span> <span class="n">magpiedata_dict_difference_site1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">magpiedata_dict_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">magpiedata_dict_composition_average</span><span class="p">,</span> <span class="n">magpiedata_dict_arithmetic_average</span><span class="p">,</span>
                                    <span class="n">magpiedata_dict_max</span><span class="p">,</span> <span class="n">magpiedata_dict_min</span><span class="p">,</span> <span class="n">magpiedata_dict_difference</span><span class="p">,</span> <span class="n">magpiedata_dict_atomic_bysite</span><span class="p">,</span>
                                        <span class="n">magpiedata_dict_composition_average_site1</span><span class="p">,</span> <span class="n">magpiedata_dict_arithmetic_average_site1</span><span class="p">,</span>
                                        <span class="n">magpiedata_dict_max_site1</span><span class="p">,</span> <span class="n">magpiedata_dict_min_site1</span><span class="p">,</span> <span class="n">magpiedata_dict_difference_site1</span><span class="p">,</span>
                                        <span class="n">magpiedata_dict_composition_average_site2</span><span class="p">,</span> <span class="n">magpiedata_dict_arithmetic_average_site2</span><span class="p">,</span>
                                        <span class="n">magpiedata_dict_max_site2</span><span class="p">,</span> <span class="n">magpiedata_dict_min_site2</span><span class="p">,</span> <span class="n">magpiedata_dict_difference_site2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">magpiedata_dict_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">magpiedata_dict_composition_average</span><span class="p">,</span> <span class="n">magpiedata_dict_arithmetic_average</span><span class="p">,</span>
                                    <span class="n">magpiedata_dict_max</span><span class="p">,</span> <span class="n">magpiedata_dict_min</span><span class="p">,</span> <span class="n">magpiedata_dict_difference</span><span class="p">,</span> <span class="n">magpiedata_dict_atomic_bysite</span><span class="p">,</span>
                                        <span class="n">magpiedata_dict_composition_average_site1</span><span class="p">,</span> <span class="n">magpiedata_dict_arithmetic_average_site1</span><span class="p">,</span>
                                        <span class="n">magpiedata_dict_max_site1</span><span class="p">,</span> <span class="n">magpiedata_dict_min_site1</span><span class="p">,</span> <span class="n">magpiedata_dict_difference_site1</span><span class="p">,</span>
                                        <span class="n">magpiedata_dict_composition_average_site2</span><span class="p">,</span> <span class="n">magpiedata_dict_arithmetic_average_site2</span><span class="p">,</span>
                                        <span class="n">magpiedata_dict_max_site2</span><span class="p">,</span> <span class="n">magpiedata_dict_min_site2</span><span class="p">,</span> <span class="n">magpiedata_dict_difference_site2</span><span class="p">,</span>
                                        <span class="n">magpiedata_dict_composition_average_site3</span><span class="p">,</span> <span class="n">magpiedata_dict_arithmetic_average_site3</span><span class="p">,</span>
                                        <span class="n">magpiedata_dict_max_site3</span><span class="p">,</span> <span class="n">magpiedata_dict_min_site3</span><span class="p">,</span> <span class="n">magpiedata_dict_difference_site3</span><span class="p">,</span>
                                        <span class="n">magpiedata_dict_composition_average_site1site2</span><span class="p">,</span> <span class="n">magpiedata_dict_arithmetic_average_site1site2</span><span class="p">,</span> <span class="n">magpiedata_dict_difference_site1site2</span><span class="p">,</span>
                                        <span class="n">magpiedata_dict_composition_average_site1site3</span><span class="p">,</span> <span class="n">magpiedata_dict_arithmetic_average_site1site3</span><span class="p">,</span> <span class="n">magpiedata_dict_difference_site1site3</span><span class="p">,</span>
                                        <span class="n">magpiedata_dict_composition_average_site2site3</span><span class="p">,</span> <span class="n">magpiedata_dict_arithmetic_average_site2site3</span><span class="p">,</span> <span class="n">magpiedata_dict_difference_site2site3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">magpiedata_dict_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">magpiedata_dict_composition_average</span><span class="p">,</span> <span class="n">magpiedata_dict_arithmetic_average</span><span class="p">,</span>
                                <span class="n">magpiedata_dict_max</span><span class="p">,</span> <span class="n">magpiedata_dict_min</span><span class="p">,</span> <span class="n">magpiedata_dict_difference</span><span class="p">,</span> <span class="n">magpiedata_dict_atomic_bysite</span><span class="p">]</span>

        <span class="c1">#dataframe = self.dataframe #not needed anymore as df already in self</span>

        <span class="n">magpiedata_dict_list_toinclude</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;composition_avg&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
            <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;arithmetic_avg&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
            <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;max&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
            <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;min&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
            <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;difference&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
            <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;elements&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
            <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">has_sublattices</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;composition_avg&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;arithmetic_avg&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;max&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;min&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;difference&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;composition_avg&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;arithmetic_avg&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;max&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;min&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;difference&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;composition_avg&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;Site1Site2&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                        <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">21</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;Site1Site3&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                        <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">24</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;Site2Site3&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                        <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">27</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;arithmetic_avg&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">17</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;Site1Site2&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                        <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">22</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;Site1Site3&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                        <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">25</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;Site2Site3&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                        <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">28</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;max&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">18</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;min&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">19</span><span class="p">])</span>
                <span class="k">if</span> <span class="s1">&#39;difference&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span>
                    <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">20</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;Site1Site2&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                        <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">23</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;Site1Site3&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                        <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">26</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;Site2Site3&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_types</span><span class="p">:</span>
                        <span class="n">magpiedata_dict_list_toinclude</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_dict_list</span><span class="p">[</span><span class="mi">29</span><span class="p">])</span>

        <span class="c1">#df = self.df # Initialize the final df as initial df then add magpie features to it</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">magpiedata_dict</span> <span class="ow">in</span> <span class="n">magpiedata_dict_list_toinclude</span><span class="p">:</span>
            <span class="n">df_magpie</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">magpiedata_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
            <span class="c1"># Need to reorder compositions in new dataframe to match input dataframe</span>
            <span class="n">df_magpie</span> <span class="o">=</span> <span class="n">df_magpie</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="c1"># Need to make compositions the first column, instead of the row names</span>
            <span class="n">df_magpie</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">df_magpie</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Merge magpie feature dataframe with originally supplied dataframe</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df_magpie</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">DataframeUtilities</span><span class="p">()</span><span class="o">.</span><span class="n">merge_dataframe_columns</span><span class="p">(</span><span class="n">dataframe1</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">dataframe2</span><span class="o">=</span><span class="n">df_magpie</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">df</span></div>

    <span class="k">def</span> <span class="nf">_get_computed_magpie_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">composition</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">site_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">magpiedata_composition_average</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_arithmetic_average</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_max</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_min</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_difference</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_atomic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_atomic_magpie_features</span><span class="p">(</span><span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="p">,</span> <span class="n">data_path</span><span class="o">=</span><span class="n">data_path</span><span class="p">)</span>
        <span class="n">composition</span> <span class="o">=</span> <span class="n">Composition</span><span class="p">(</span><span class="n">composition</span><span class="p">)</span>
        <span class="n">element_list</span><span class="p">,</span> <span class="n">atoms_per_formula_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_element_list</span><span class="p">(</span><span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="p">)</span>

        <span class="c1"># Make per-site dicts if site_dict_list specified</span>
        <span class="k">if</span> <span class="n">site_dict</span><span class="p">:</span>
            <span class="n">number_sites</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">site_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">site</span><span class="p">,</span> <span class="n">comp_dict</span> <span class="ow">in</span> <span class="n">site_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">site</span> <span class="o">==</span> <span class="s2">&quot;Site1&quot;</span><span class="p">:</span>
                    <span class="n">num_site1_elements</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">site_dict</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="n">site1_total</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">el</span><span class="p">,</span> <span class="n">amt</span> <span class="ow">in</span> <span class="n">comp_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">site1_total</span> <span class="o">+=</span> <span class="n">amt</span>
                <span class="k">if</span> <span class="n">site</span> <span class="o">==</span> <span class="s2">&quot;Site2&quot;</span><span class="p">:</span>
                    <span class="n">num_site2_elements</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">site_dict</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="n">site2_total</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">el</span><span class="p">,</span> <span class="n">amt</span> <span class="ow">in</span> <span class="n">comp_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">site2_total</span> <span class="o">+=</span> <span class="n">amt</span>
                <span class="k">if</span> <span class="n">site</span> <span class="o">==</span> <span class="s2">&quot;Site3&quot;</span><span class="p">:</span>
                    <span class="n">num_site3_elements</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">site_dict</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="n">site3_total</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">el</span><span class="p">,</span> <span class="n">amt</span> <span class="ow">in</span> <span class="n">comp_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">site3_total</span> <span class="o">+=</span> <span class="n">amt</span>
            <span class="k">if</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">magpiedata_composition_average_site1</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_arithmetic_average_site1</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_max_site1</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_min_site1</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_difference_site1</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">elif</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">magpiedata_composition_average_site1</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_arithmetic_average_site1</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_max_site1</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_min_site1</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_difference_site1</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_composition_average_site2</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_arithmetic_average_site2</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_max_site2</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_min_site2</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_difference_site2</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">elif</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">magpiedata_composition_average_site1</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_arithmetic_average_site1</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_max_site1</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_min_site1</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_difference_site1</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_composition_average_site2</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_arithmetic_average_site2</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_max_site2</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_min_site2</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_difference_site2</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_composition_average_site3</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_arithmetic_average_site3</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_max_site3</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_min_site3</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_difference_site3</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># Couplings between sites</span>
                <span class="n">magpiedata_composition_average_site1site2</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_arithmetic_average_site1site2</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_difference_site1site2</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_composition_average_site1site3</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_arithmetic_average_site1site3</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_difference_site1site3</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_composition_average_site2site3</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_arithmetic_average_site2site3</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">magpiedata_difference_site2site3</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MASTML currently only supports up to 3 sublattices to generate site-specific MAGPIE features. &#39;</span>
                          <span class="s1">&#39;Please reduce number of sublattices an re-run MASTML.&#39;</span><span class="p">)</span>

        <span class="c1"># Initialize feature values to all be 0, because need to dynamically update them with weighted values in next loop.</span>
        <span class="k">for</span> <span class="n">magpie_feature</span> <span class="ow">in</span> <span class="n">magpiedata_atomic</span><span class="p">[</span><span class="n">element_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
            <span class="n">magpiedata_composition_average</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">magpiedata_arithmetic_average</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">magpiedata_max</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">magpiedata_min</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">magpiedata_difference</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">site_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">magpiedata_composition_average_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_arithmetic_average_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_max_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_min_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_difference_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">magpiedata_composition_average_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_arithmetic_average_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_max_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_min_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_difference_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_composition_average_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_arithmetic_average_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_max_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_min_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_difference_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">magpiedata_composition_average_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_arithmetic_average_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_max_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_min_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_difference_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_composition_average_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_arithmetic_average_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_max_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_min_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_difference_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_composition_average_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_arithmetic_average_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_max_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_min_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_difference_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1"># Couplings between sites</span>
                    <span class="n">magpiedata_composition_average_site1site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_arithmetic_average_site1site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_difference_site1site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_composition_average_site1site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_arithmetic_average_site1site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_difference_site1site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_composition_average_site2site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_arithmetic_average_site2site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">magpiedata_difference_site2site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Original magpie feature set</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">magpiedata_atomic</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">magpie_feature</span><span class="p">,</span> <span class="n">feature_value</span> <span class="ow">in</span> <span class="n">magpiedata_atomic</span><span class="p">[</span><span class="n">element</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">feature_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;NaN&#39;</span><span class="p">:</span>
                    <span class="c1"># Composition average features</span>
                    <span class="n">magpiedata_composition_average</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="n">feature_value</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">composition</span><span class="p">[</span><span class="n">element</span><span class="p">])</span><span class="o">/</span><span class="n">atoms_per_formula_unit</span>
                    <span class="c1"># Arithmetic average features</span>
                    <span class="n">magpiedata_arithmetic_average</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="n">feature_value</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">element_list</span><span class="p">)</span>
                    <span class="c1"># Max features</span>
                    <span class="k">if</span> <span class="n">magpiedata_max</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">feature_value</span> <span class="o">&gt;</span> <span class="n">magpiedata_max</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]:</span>
                            <span class="n">magpiedata_max</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                    <span class="k">elif</span> <span class="n">magpiedata_max</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">magpiedata_max</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                    <span class="c1"># Min features</span>
                    <span class="k">if</span> <span class="n">magpiedata_min</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">feature_value</span> <span class="o">&lt;</span> <span class="n">magpiedata_min</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]:</span>
                            <span class="n">magpiedata_min</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                    <span class="k">elif</span> <span class="n">magpiedata_min</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">magpiedata_min</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                    <span class="c1"># Difference features (max - min)</span>
                    <span class="n">magpiedata_difference</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">-</span> <span class="n">magpiedata_min</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span>

        <span class="c1"># Site-specific magpie features</span>
        <span class="k">if</span> <span class="n">site_dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">magpiedata_atomic</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">site</span><span class="p">,</span> <span class="n">comp_dict</span> <span class="ow">in</span> <span class="n">site_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">magpie_data_by_site_collected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">el</span><span class="p">,</span> <span class="n">amt</span> <span class="ow">in</span> <span class="n">comp_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">el</span> <span class="o">==</span> <span class="n">element</span><span class="p">:</span>
                            <span class="n">magpie_data_by_site_collected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">magpiedata_atomic</span><span class="p">[</span><span class="n">element</span><span class="p">])</span>
                    <span class="c1"># Here, calc magpie values over the particular site</span>
                    <span class="k">for</span> <span class="n">magpiedata</span> <span class="ow">in</span> <span class="n">magpie_data_by_site_collected</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">magpie_feature</span><span class="p">,</span> <span class="n">feature_value</span> <span class="ow">in</span> <span class="n">magpiedata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">feature_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s1">&#39;NaN&#39;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">site</span> <span class="o">==</span> <span class="s2">&quot;Site1&quot;</span><span class="p">:</span>
                                    <span class="c1"># Composition weighted average by site</span>
                                    <span class="n">magpiedata_composition_average_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="n">feature_value</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">site_dict</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="n">element</span><span class="p">])</span><span class="o">/</span><span class="n">site1_total</span>
                                    <span class="c1"># Arithmetic average by site</span>
                                    <span class="n">magpiedata_arithmetic_average_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="n">feature_value</span> <span class="o">/</span> <span class="n">num_site1_elements</span>
                                    <span class="c1"># Max features by site</span>
                                    <span class="k">if</span> <span class="n">magpiedata_max_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">feature_value</span> <span class="o">&gt;</span> <span class="n">magpiedata_max_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]:</span>
                                            <span class="n">magpiedata_max_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                                    <span class="k">elif</span> <span class="n">magpiedata_max_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">magpiedata_max_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                                    <span class="c1"># Min features by site</span>
                                    <span class="k">if</span> <span class="n">magpiedata_min_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">feature_value</span> <span class="o">&lt;</span> <span class="n">magpiedata_min_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]:</span>
                                            <span class="n">magpiedata_min_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                                    <span class="k">elif</span> <span class="n">magpiedata_min_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">magpiedata_min_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                                    <span class="c1"># Difference features (max - min)</span>
                                    <span class="n">magpiedata_difference_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">-</span> <span class="n">magpiedata_min_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span>
                                <span class="k">elif</span> <span class="n">site</span> <span class="o">==</span> <span class="s2">&quot;Site2&quot;</span><span class="p">:</span>
                                    <span class="c1"># Composition weighted average by site</span>
                                    <span class="n">magpiedata_composition_average_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="n">feature_value</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">site_dict</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="n">element</span><span class="p">])</span><span class="o">/</span><span class="n">site2_total</span>
                                    <span class="c1"># Arithmetic average by site</span>
                                    <span class="n">magpiedata_arithmetic_average_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="n">feature_value</span> <span class="o">/</span> <span class="n">num_site2_elements</span>
                                    <span class="c1"># Max features by site</span>
                                    <span class="k">if</span> <span class="n">magpiedata_max_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">feature_value</span> <span class="o">&gt;</span> <span class="n">magpiedata_max_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]:</span>
                                            <span class="n">magpiedata_max_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                                    <span class="k">elif</span> <span class="n">magpiedata_max_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">magpiedata_max_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                                    <span class="c1"># Min features by site</span>
                                    <span class="k">if</span> <span class="n">magpiedata_min_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">feature_value</span> <span class="o">&lt;</span> <span class="n">magpiedata_min_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]:</span>
                                            <span class="n">magpiedata_min_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                                    <span class="k">elif</span> <span class="n">magpiedata_min_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">magpiedata_min_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                                    <span class="c1"># Difference features (max - min)</span>
                                    <span class="n">magpiedata_difference_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">-</span> <span class="n">magpiedata_min_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span>
                                <span class="k">elif</span> <span class="n">site</span> <span class="o">==</span> <span class="s2">&quot;Site3&quot;</span><span class="p">:</span>
                                    <span class="c1"># Composition weighted average by site</span>
                                    <span class="n">magpiedata_composition_average_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="n">feature_value</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">site_dict</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="n">element</span><span class="p">])</span><span class="o">/</span><span class="n">site3_total</span>
                                    <span class="c1"># Arithmetic average by site</span>
                                    <span class="n">magpiedata_arithmetic_average_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="n">feature_value</span> <span class="o">/</span> <span class="n">num_site3_elements</span>
                                    <span class="c1"># Max features by site</span>
                                    <span class="k">if</span> <span class="n">magpiedata_max_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">feature_value</span> <span class="o">&gt;</span> <span class="n">magpiedata_max_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]:</span>
                                            <span class="n">magpiedata_max_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                                    <span class="k">elif</span> <span class="n">magpiedata_max_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">magpiedata_max_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                                    <span class="c1"># Min features by site</span>
                                    <span class="k">if</span> <span class="n">magpiedata_min_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">feature_value</span> <span class="o">&lt;</span> <span class="n">magpiedata_min_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]:</span>
                                            <span class="n">magpiedata_min_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                                    <span class="k">elif</span> <span class="n">magpiedata_min_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">magpiedata_min_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_value</span>
                                    <span class="c1"># Difference features (max - min)</span>
                                    <span class="n">magpiedata_difference_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">-</span> <span class="n">magpiedata_min_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span>
                                    <span class="c1"># Add Site couplings here</span>
                                    <span class="n">magpiedata_composition_average_site1site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">magpiedata_composition_average_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span><span class="o">+</span><span class="n">magpiedata_composition_average_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
                                    <span class="n">magpiedata_arithmetic_average_site1site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">magpiedata_arithmetic_average_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span><span class="o">+</span><span class="n">magpiedata_arithmetic_average_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
                                    <span class="c1">#magpiedata_difference_site1site2[magpie_feature] += abs(magpiedata_difference_site1[magpie_feature]-magpiedata_difference_site2[magpie_feature])</span>
                                    <span class="n">magpiedata_difference_site1site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">magpiedata_max_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">],</span> <span class="n">magpiedata_max_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">])</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">magpiedata_min_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">],</span><span class="n">magpiedata_min_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">])</span>
                                    <span class="n">magpiedata_composition_average_site1site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">magpiedata_composition_average_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span><span class="o">+</span><span class="n">magpiedata_composition_average_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
                                    <span class="n">magpiedata_arithmetic_average_site1site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">magpiedata_arithmetic_average_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span><span class="o">+</span><span class="n">magpiedata_arithmetic_average_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
                                    <span class="c1">#magpiedata_difference_site1site3[magpie_feature] += abs(magpiedata_difference_site1[magpie_feature]-magpiedata_difference_site3[magpie_feature])</span>
                                    <span class="n">magpiedata_difference_site1site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">magpiedata_max_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">],</span><span class="n">magpiedata_max_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">])</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">magpiedata_min_site1</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">],</span> <span class="n">magpiedata_min_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">])</span>
                                    <span class="n">magpiedata_composition_average_site2site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">magpiedata_composition_average_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span><span class="o">+</span><span class="n">magpiedata_composition_average_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
                                    <span class="n">magpiedata_arithmetic_average_site2site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">magpiedata_arithmetic_average_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span><span class="o">+</span><span class="n">magpiedata_arithmetic_average_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
                                    <span class="c1">#magpiedata_difference_site2site3[magpie_feature] += abs(magpiedata_difference_site2[magpie_feature]-magpiedata_difference_site3[magpie_feature])</span>
                                    <span class="n">magpiedata_difference_site2site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">max</span><span class="p">(</span><span class="n">magpiedata_max_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">],</span> <span class="n">magpiedata_max_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">])</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">magpiedata_min_site2</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">],</span> <span class="n">magpiedata_min_site3</span><span class="p">[</span><span class="n">magpie_feature</span><span class="p">])</span>
        <span class="c1"># Change names of features to reflect each computed type of magpie feature (max, min, etc.)</span>
        <span class="n">magpiedata_composition_average_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_arithmetic_average_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_max_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_min_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_difference_renamed</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_composition_average</span><span class="p">:</span>
            <span class="n">magpiedata_composition_average_renamed</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_composition_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_arithmetic_average</span><span class="p">:</span>
            <span class="n">magpiedata_arithmetic_average_renamed</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_arithmetic_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_max</span><span class="p">:</span>
            <span class="n">magpiedata_max_renamed</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_max_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_min</span><span class="p">:</span>
            <span class="n">magpiedata_min_renamed</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_min_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_difference</span><span class="p">:</span>
            <span class="n">magpiedata_difference_renamed</span><span class="p">[</span><span class="n">key</span><span class="o">+</span><span class="s2">&quot;_difference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># Rename feature dicts for sublattice specific cases</span>
        <span class="n">magpiedata_composition_average_site1_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_arithmetic_average_site1_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_max_site1_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_min_site1_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_difference_site1_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_composition_average_site2_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_arithmetic_average_site2_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_max_site2_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_min_site2_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_difference_site2_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_composition_average_site3_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_arithmetic_average_site3_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_max_site3_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_min_site3_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_difference_site3_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Couplings between sites</span>
        <span class="n">magpiedata_composition_average_site1site2_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_arithmetic_average_site1site2_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_difference_site1site2_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_composition_average_site1site3_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_arithmetic_average_site1site3_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_difference_site1site3_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_composition_average_site2site3_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_arithmetic_average_site2site3_renamed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">magpiedata_difference_site2site3_renamed</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">site_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_composition_average_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_composition_average_site1_renamed</span><span class="p">[</span><span class="s2">&quot;Site1_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_composition_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_arithmetic_average_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_arithmetic_average_site1_renamed</span><span class="p">[</span><span class="s2">&quot;Site1_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_arithmetic_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_max_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_max_site1_renamed</span><span class="p">[</span><span class="s2">&quot;Site1_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_max_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max_site1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_min_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_min_site1_renamed</span><span class="p">[</span><span class="s2">&quot;Site1_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_min_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min_site1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_difference_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_difference_site1_renamed</span><span class="p">[</span><span class="s2">&quot;Site1_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_difference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_composition_average_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_composition_average_site1_renamed</span><span class="p">[</span><span class="s2">&quot;Site1_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_composition_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_arithmetic_average_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_arithmetic_average_site1_renamed</span><span class="p">[</span><span class="s2">&quot;Site1_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_arithmetic_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_max_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_max_site1_renamed</span><span class="p">[</span><span class="s2">&quot;Site1_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_max_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max_site1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_min_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_min_site1_renamed</span><span class="p">[</span><span class="s2">&quot;Site1_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_min_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min_site1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_difference_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_difference_site1_renamed</span><span class="p">[</span><span class="s2">&quot;Site1_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_difference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_composition_average_site2</span><span class="p">:</span>
                    <span class="n">magpiedata_composition_average_site2_renamed</span><span class="p">[</span><span class="s2">&quot;Site2_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_composition_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_arithmetic_average_site2</span><span class="p">:</span>
                    <span class="n">magpiedata_arithmetic_average_site2_renamed</span><span class="p">[</span><span class="s2">&quot;Site2_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_arithmetic_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_max_site2</span><span class="p">:</span>
                    <span class="n">magpiedata_max_site2_renamed</span><span class="p">[</span><span class="s2">&quot;Site2_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_max_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max_site2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_min_site2</span><span class="p">:</span>
                    <span class="n">magpiedata_min_site2_renamed</span><span class="p">[</span><span class="s2">&quot;Site2_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_min_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min_site2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_difference_site2</span><span class="p">:</span>
                    <span class="n">magpiedata_difference_site2_renamed</span><span class="p">[</span><span class="s2">&quot;Site2_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_difference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_composition_average_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_composition_average_site1_renamed</span><span class="p">[</span><span class="s2">&quot;Site1_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_composition_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_arithmetic_average_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_arithmetic_average_site1_renamed</span><span class="p">[</span><span class="s2">&quot;Site1_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_arithmetic_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_max_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_max_site1_renamed</span><span class="p">[</span><span class="s2">&quot;Site1_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_max_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max_site1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_min_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_min_site1_renamed</span><span class="p">[</span><span class="s2">&quot;Site1_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_min_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min_site1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_difference_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_difference_site1_renamed</span><span class="p">[</span><span class="s2">&quot;Site1_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_difference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_composition_average_site2</span><span class="p">:</span>
                    <span class="n">magpiedata_composition_average_site2_renamed</span><span class="p">[</span><span class="s2">&quot;Site2_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_composition_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_arithmetic_average_site2</span><span class="p">:</span>
                    <span class="n">magpiedata_arithmetic_average_site2_renamed</span><span class="p">[</span><span class="s2">&quot;Site2_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_arithmetic_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_max_site2</span><span class="p">:</span>
                    <span class="n">magpiedata_max_site2_renamed</span><span class="p">[</span><span class="s2">&quot;Site2_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_max_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max_site2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_min_site2</span><span class="p">:</span>
                    <span class="n">magpiedata_min_site2_renamed</span><span class="p">[</span><span class="s2">&quot;Site2_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_min_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min_site2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_difference_site2</span><span class="p">:</span>
                    <span class="n">magpiedata_difference_site2_renamed</span><span class="p">[</span><span class="s2">&quot;Site2_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_difference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_composition_average_site3</span><span class="p">:</span>
                    <span class="n">magpiedata_composition_average_site3_renamed</span><span class="p">[</span><span class="s2">&quot;Site3_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_composition_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site3</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_arithmetic_average_site3</span><span class="p">:</span>
                    <span class="n">magpiedata_arithmetic_average_site3_renamed</span><span class="p">[</span><span class="s2">&quot;Site3_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_arithmetic_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site3</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_max_site3</span><span class="p">:</span>
                    <span class="n">magpiedata_max_site3_renamed</span><span class="p">[</span><span class="s2">&quot;Site3_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_max_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_max_site3</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_min_site1</span><span class="p">:</span>
                    <span class="n">magpiedata_min_site3_renamed</span><span class="p">[</span><span class="s2">&quot;Site3_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_min_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_min_site3</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_difference_site3</span><span class="p">:</span>
                    <span class="n">magpiedata_difference_site3_renamed</span><span class="p">[</span><span class="s2">&quot;Site3_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_difference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site3</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="c1"># Couplings between sites</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_composition_average_site1site2</span><span class="p">:</span>
                    <span class="n">magpiedata_composition_average_site1site2_renamed</span><span class="p">[</span><span class="s2">&quot;Site1Site2_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_composition_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site1site2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_arithmetic_average_site1site2</span><span class="p">:</span>
                    <span class="n">magpiedata_arithmetic_average_site1site2_renamed</span><span class="p">[</span><span class="s2">&quot;Site1Site2_&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_arithmetic_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site1site2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_difference_site1site2</span><span class="p">:</span>
                    <span class="n">magpiedata_difference_site1site2_renamed</span><span class="p">[</span><span class="s2">&quot;Site1Site2_&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_difference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site1site2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_composition_average_site1site3</span><span class="p">:</span>
                    <span class="n">magpiedata_composition_average_site1site3_renamed</span><span class="p">[</span><span class="s2">&quot;Site1Site3_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_composition_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site1site3</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_arithmetic_average_site1site3</span><span class="p">:</span>
                    <span class="n">magpiedata_arithmetic_average_site1site3_renamed</span><span class="p">[</span><span class="s2">&quot;Site1Site3_&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_arithmetic_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site1site3</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_difference_site1site3</span><span class="p">:</span>
                    <span class="n">magpiedata_difference_site1site3_renamed</span><span class="p">[</span><span class="s2">&quot;Site1Site3_&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_difference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site1site3</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_composition_average_site2site3</span><span class="p">:</span>
                    <span class="n">magpiedata_composition_average_site2site3_renamed</span><span class="p">[</span><span class="s2">&quot;Site2Site3_&quot;</span><span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_composition_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_composition_average_site2site3</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_arithmetic_average_site2site3</span><span class="p">:</span>
                    <span class="n">magpiedata_arithmetic_average_site2site3_renamed</span><span class="p">[</span><span class="s2">&quot;Site2Site3_&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_arithmetic_average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_arithmetic_average_site2site3</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">magpiedata_difference_site2site3</span><span class="p">:</span>
                    <span class="n">magpiedata_difference_site2site3_renamed</span><span class="p">[</span><span class="s2">&quot;Site2Site3_&quot;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_difference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magpiedata_difference_site2site3</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">site_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">magpiedata_composition_average_renamed</span><span class="p">,</span> <span class="n">magpiedata_arithmetic_average_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_max_renamed</span><span class="p">,</span> <span class="n">magpiedata_min_renamed</span><span class="p">,</span> <span class="n">magpiedata_difference_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_composition_average_site1_renamed</span><span class="p">,</span> <span class="n">magpiedata_arithmetic_average_site1_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_max_site1_renamed</span><span class="p">,</span> <span class="n">magpiedata_min_site1_renamed</span><span class="p">,</span> <span class="n">magpiedata_difference_site1_renamed</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">magpiedata_composition_average_renamed</span><span class="p">,</span> <span class="n">magpiedata_arithmetic_average_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_max_renamed</span><span class="p">,</span> <span class="n">magpiedata_min_renamed</span><span class="p">,</span> <span class="n">magpiedata_difference_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_composition_average_site1_renamed</span><span class="p">,</span> <span class="n">magpiedata_arithmetic_average_site1_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_max_site1_renamed</span><span class="p">,</span> <span class="n">magpiedata_min_site1_renamed</span><span class="p">,</span> <span class="n">magpiedata_difference_site1_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_composition_average_site2_renamed</span><span class="p">,</span> <span class="n">magpiedata_arithmetic_average_site2_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_max_site2_renamed</span><span class="p">,</span> <span class="n">magpiedata_min_site2_renamed</span><span class="p">,</span> <span class="n">magpiedata_difference_site2_renamed</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">number_sites</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">magpiedata_composition_average_renamed</span><span class="p">,</span> <span class="n">magpiedata_arithmetic_average_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_max_renamed</span><span class="p">,</span> <span class="n">magpiedata_min_renamed</span><span class="p">,</span> <span class="n">magpiedata_difference_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_composition_average_site1_renamed</span><span class="p">,</span> <span class="n">magpiedata_arithmetic_average_site1_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_max_site1_renamed</span><span class="p">,</span> <span class="n">magpiedata_min_site1_renamed</span><span class="p">,</span> <span class="n">magpiedata_difference_site1_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_composition_average_site2_renamed</span><span class="p">,</span> <span class="n">magpiedata_arithmetic_average_site2_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_max_site2_renamed</span><span class="p">,</span> <span class="n">magpiedata_min_site2_renamed</span><span class="p">,</span> <span class="n">magpiedata_difference_site2_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_composition_average_site3_renamed</span><span class="p">,</span> <span class="n">magpiedata_arithmetic_average_site3_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_max_site3_renamed</span><span class="p">,</span> <span class="n">magpiedata_min_site3_renamed</span><span class="p">,</span> <span class="n">magpiedata_difference_site3_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_composition_average_site1site2_renamed</span><span class="p">,</span> <span class="n">magpiedata_arithmetic_average_site1site2_renamed</span><span class="p">,</span> <span class="n">magpiedata_difference_site1site2_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_composition_average_site1site3_renamed</span><span class="p">,</span> <span class="n">magpiedata_arithmetic_average_site1site3_renamed</span><span class="p">,</span> <span class="n">magpiedata_difference_site1site3_renamed</span><span class="p">,</span>
                        <span class="n">magpiedata_composition_average_site2site3_renamed</span><span class="p">,</span> <span class="n">magpiedata_arithmetic_average_site2site3_renamed</span><span class="p">,</span> <span class="n">magpiedata_difference_site2site3_renamed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">magpiedata_composition_average_renamed</span><span class="p">,</span> <span class="n">magpiedata_arithmetic_average_renamed</span><span class="p">,</span>
                    <span class="n">magpiedata_max_renamed</span><span class="p">,</span> <span class="n">magpiedata_min_renamed</span><span class="p">,</span> <span class="n">magpiedata_difference_renamed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_atomic_magpie_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">composition</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
        <span class="c1"># Get .table files containing feature values for each element, assign file names as feature names</span>
        <span class="n">magpie_feature_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">data_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;.table&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">magpie_feature_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">])</span>

        <span class="n">composition</span> <span class="o">=</span> <span class="n">Composition</span><span class="p">(</span><span class="n">composition</span><span class="p">)</span>
        <span class="n">element_list</span><span class="p">,</span> <span class="n">atoms_per_formula_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_element_list</span><span class="p">(</span><span class="n">composition</span><span class="o">=</span><span class="n">composition</span><span class="p">)</span>

        <span class="n">element_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">element_list</span><span class="p">:</span>
            <span class="n">element_dict</span><span class="p">[</span><span class="n">element</span><span class="p">]</span> <span class="o">=</span> <span class="n">Element</span><span class="p">(</span><span class="n">element</span><span class="p">)</span><span class="o">.</span><span class="n">Z</span>

        <span class="n">magpiedata_atomic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">element_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">atomic_values</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">feature_name</span> <span class="ow">in</span> <span class="n">magpie_feature_names</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">feature_name</span> <span class="o">+</span> <span class="s1">&#39;.table&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="c1"># Get Magpie data of relevant atomic numbers for this composition</span>
                <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">feature_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s2">&quot;Missing&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">feature_value</span> <span class="ow">and</span> <span class="s2">&quot;NA&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">feature_value</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">feature_name</span> <span class="o">!=</span> <span class="s2">&quot;OxidationStates&quot;</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">atomic_values</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">feature_value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                    <span class="n">atomic_values</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NaN&#39;</span>
                        <span class="k">if</span> <span class="s2">&quot;Missing&quot;</span> <span class="ow">in</span> <span class="n">feature_value</span><span class="p">:</span>
                            <span class="n">atomic_values</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NaN&#39;</span>
                        <span class="k">if</span> <span class="s2">&quot;NA&quot;</span> <span class="ow">in</span> <span class="n">feature_value</span><span class="p">:</span>
                            <span class="n">atomic_values</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NaN&#39;</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">magpiedata_atomic</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomic_values</span>

        <span class="k">return</span> <span class="n">magpiedata_atomic</span>

    <span class="k">def</span> <span class="nf">_get_element_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">composition</span><span class="p">):</span>
        <span class="n">element_amounts</span> <span class="o">=</span> <span class="n">composition</span><span class="o">.</span><span class="n">get_el_amt_dict</span><span class="p">()</span>
        <span class="n">atoms_per_formula_unit</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">element_amounts</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">atoms_per_formula_unit</span> <span class="o">+=</span> <span class="n">v</span>

        <span class="c1"># Get list of unique elements present</span>
        <span class="n">element_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">element_amounts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">element_list</span><span class="p">:</span>
                <span class="n">element_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">element_list</span><span class="p">,</span> <span class="n">atoms_per_formula_unit</span></div>


<div class="viewcode-block" id="PolynomialFeatureGenerator"><a class="viewcode-back" href="../../api/mastml.feature_generators.PolynomialFeatureGenerator.html#mastml.feature_generators.PolynomialFeatureGenerator">[docs]</a><span class="k">class</span> <span class="nc">PolynomialFeatureGenerator</span><span class="p">(</span><span class="n">BaseGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to generate polynomial features using scikit-learn&#39;s polynomial features method</span>
<span class="sd">    More info at: http://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.PolynomialFeatures.html</span>

<span class="sd">    Args:</span>
<span class="sd">        degree: (int), degree of polynomial features</span>

<span class="sd">        interaction_only: (bool), If true, only interaction features are produced: features that are products of at most degree distinct input features (so not x[1] ** 2, x[0] * x[2] ** 3, etc.).</span>

<span class="sd">        include_bias: (bool),If True (default), then include a bias column, the feature in which all polynomial powers are zero (i.e. a column of ones - acts as an intercept term in a linear model).</span>

<span class="sd">    Methods:</span>
<span class="sd">        fit: conducts fit method of polynomial feature generation</span>
<span class="sd">            Args:</span>
<span class="sd">                df: (dataframe), dataframe of input X and y data</span>

<span class="sd">        transform: generates dataframe containing polynomial features</span>
<span class="sd">            Args:</span>
<span class="sd">                df: (dataframe), dataframe of input X and y data</span>

<span class="sd">        Returns:</span>
<span class="sd">            (dataframe), dataframe containing new polynomial features, plus original features present</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">interaction_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PolynomialFeatureGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SPF</span> <span class="o">=</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="p">,</span> <span class="n">interaction_only</span><span class="p">,</span> <span class="n">include_bias</span><span class="p">)</span>

<div class="viewcode-block" id="PolynomialFeatureGenerator.fit"><a class="viewcode-back" href="../../api/mastml.feature_generators.PolynomialFeatureGenerator.html#mastml.feature_generators.PolynomialFeatureGenerator.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SPF</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="PolynomialFeatureGenerator.transform"><a class="viewcode-back" href="../../api/mastml.feature_generators.PolynomialFeatureGenerator.html#mastml.feature_generators.PolynomialFeatureGenerator.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">new_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SPF</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SPF</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">array</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">new_features</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span></div></div>


<div class="viewcode-block" id="OneHotGroupGenerator"><a class="viewcode-back" href="../../api/mastml.feature_generators.OneHotGroupGenerator.html#mastml.feature_generators.OneHotGroupGenerator">[docs]</a><span class="k">class</span> <span class="nc">OneHotGroupGenerator</span><span class="p">(</span><span class="n">BaseGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to generate one-hot encoded values from a list of categories using scikit-learn&#39;s one hot encoder method</span>
<span class="sd">    More info at: https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.OneHotEncoder.html</span>

<span class="sd">    Args:</span>
<span class="sd">        groups: (pd.Series): pandas Series of group (category) names</span>

<span class="sd">        remove_constant_columns: (bool), whether to remove constant columns from the generated feature set</span>

<span class="sd">    Methods:</span>
<span class="sd">        fit: pass through, copies input columns as pre-generated features</span>
<span class="sd">            Args:</span>
<span class="sd">                X: (pd.DataFrame), input dataframe containing X data</span>

<span class="sd">                y: (pd.Series), series containing y data</span>

<span class="sd">        transform: generate the one-hot encoded features. There will be n columns made, where n = number of unique categories in groups</span>
<span class="sd">            Args:</span>
<span class="sd">                None.</span>

<span class="sd">            Returns:</span>
<span class="sd">                df: (dataframe), output dataframe containing generated features</span>

<span class="sd">                y: (series), output y data as series</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">remove_constant_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BaseGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_constant_columns</span> <span class="o">=</span> <span class="n">remove_constant_columns</span>

<div class="viewcode-block" id="OneHotGroupGenerator.fit"><a class="viewcode-back" href="../../api/mastml.feature_generators.OneHotGroupGenerator.html#mastml.feature_generators.OneHotGroupGenerator.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="OneHotGroupGenerator.transform"><a class="viewcode-back" href="../../api/mastml.feature_generators.OneHotGroupGenerator.html#mastml.feature_generators.OneHotGroupGenerator.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">()</span>
        <span class="n">enc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">groups_trans</span> <span class="o">=</span> <span class="n">enc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        <span class="n">col_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">name</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">groups_trans</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">groups_trans</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">column_names</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_constant_columns</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">DataframeUtilities</span><span class="p">()</span><span class="o">.</span><span class="n">remove_constant_columns</span><span class="p">(</span><span class="n">dataframe</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span></div></div>


<div class="viewcode-block" id="OneHotElementEncoder"><a class="viewcode-back" href="../../api/mastml.feature_generators.OneHotElementEncoder.html#mastml.feature_generators.OneHotElementEncoder">[docs]</a><span class="k">class</span> <span class="nc">OneHotElementEncoder</span><span class="p">(</span><span class="n">BaseGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to generate new categorical features (i.e. values of 1 or 0) based on whether an input composition contains a</span>
<span class="sd">    certain designated element</span>

<span class="sd">    Args:</span>
<span class="sd">        composition_feature: (str), string denoting a chemical composition to generate elemental features from</span>

<span class="sd">        element: (str), string representing the name of an element</span>

<span class="sd">        new_name: (str), the name of the new feature column to be generated</span>

<span class="sd">        all_elments: (bool), whether to generate new features for all elements present from all compositions in the dataset.</span>

<span class="sd">    Methods:</span>
<span class="sd">        fit: pass through, needed to maintain scikit-learn class structure</span>
<span class="sd">            Args:</span>
<span class="sd">                df: (dataframe), dataframe of input X and y data</span>

<span class="sd">        transform: generate new element-specific features</span>
<span class="sd">            Args:</span>
<span class="sd">                df: (dataframe), dataframe of input X and y data</span>

<span class="sd">        Returns:</span>
<span class="sd">            df_trans: (dataframe), dataframe with generated element-specific features</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">composition_df</span><span class="p">,</span> <span class="n">remove_constant_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OneHotElementEncoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span> <span class="o">=</span> <span class="n">composition_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_constant_columns</span> <span class="o">=</span> <span class="n">remove_constant_columns</span>

<div class="viewcode-block" id="OneHotElementEncoder.fit"><a class="viewcode-back" href="../../api/mastml.feature_generators.OneHotElementEncoder.html#mastml.feature_generators.OneHotElementEncoder.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="OneHotElementEncoder.transform"><a class="viewcode-back" href="../../api/mastml.feature_generators.OneHotElementEncoder.html#mastml.feature_generators.OneHotElementEncoder.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">compositions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">X_trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contains_all_elements</span><span class="p">(</span><span class="n">compositions</span><span class="o">=</span><span class="n">compositions</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_constant_columns</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">X_trans</span> <span class="o">=</span> <span class="n">DataframeUtilities</span><span class="p">()</span><span class="o">.</span><span class="n">remove_constant_columns</span><span class="p">(</span><span class="n">dataframe</span><span class="o">=</span><span class="n">X_trans</span><span class="p">)</span>
        <span class="c1">#X_trans = pd.concat([X, X_trans], axis=1)</span>
        <span class="k">return</span> <span class="n">X_trans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span></div>

    <span class="k">def</span> <span class="nf">_contains_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns 1 if comp contains that element, and 0 if not.</span>
<span class="sd">        Uses ints because sklearn and numpy like number classes better than bools. Could even be</span>
<span class="sd">        something crazy like &quot;contains {element}&quot; and &quot;does not contain {element}&quot; if you really</span>
<span class="sd">        wanted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">pymatgen</span><span class="o">.</span><span class="n">Composition</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_contains_all_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compositions</span><span class="p">):</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">df_trans</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">compositions</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">pymatgen</span><span class="o">.</span><span class="n">Composition</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
                    <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">element</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_column_name</span> <span class="o">=</span> <span class="s2">&quot;has_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">)</span>
            <span class="n">has_element</span> <span class="o">=</span> <span class="n">compositions</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_contains_element</span><span class="p">)</span>
            <span class="n">df_trans</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">new_column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">has_element</span>
        <span class="k">return</span> <span class="n">df_trans</span></div>


<div class="viewcode-block" id="MaterialsProjectFeatureGenerator"><a class="viewcode-back" href="../../api/mastml.feature_generators.MaterialsProjectFeatureGenerator.html#mastml.feature_generators.MaterialsProjectFeatureGenerator">[docs]</a><span class="k">class</span> <span class="nc">MaterialsProjectFeatureGenerator</span><span class="p">(</span><span class="n">BaseGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class that wraps MaterialsProjectFeatureGeneration, giving it scikit-learn structure</span>

<span class="sd">    Args:</span>
<span class="sd">        composition_df: (pd.DataFrame), dataframe containing vector of chemical compositions (strings) to generate elemental features from</span>

<span class="sd">        mapi_key: (str), string denoting your Materials Project API key</span>

<span class="sd">    Methods:</span>
<span class="sd">        fit: pass through, copies input columns as pre-generated features</span>
<span class="sd">            Args:</span>
<span class="sd">                df: (dataframe), input dataframe containing X and y data</span>

<span class="sd">        transform: generate Materials Project features</span>
<span class="sd">            Args:</span>
<span class="sd">                df: (dataframe), input dataframe containing X and y data</span>

<span class="sd">        Returns:</span>
<span class="sd">            df: (dataframe), output dataframe containing generated features, original features and y data</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">composition_df</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MaterialsProjectFeatureGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span> <span class="o">=</span> <span class="n">composition_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="MaterialsProjectFeatureGenerator.fit"><a class="viewcode-back" href="../../api/mastml.feature_generators.MaterialsProjectFeatureGenerator.html#mastml.feature_generators.MaterialsProjectFeatureGenerator.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_features</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="MaterialsProjectFeatureGenerator.transform"><a class="viewcode-back" href="../../api/mastml.feature_generators.MaterialsProjectFeatureGenerator.html#mastml.feature_generators.MaterialsProjectFeatureGenerator.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="c1"># make materials project api call (uses internet)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_materialsproject_features</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span>
        <span class="c1"># Clean dataframe in case some values missing</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">DataframeUtilities</span><span class="p">()</span><span class="o">.</span><span class="n">clean_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span></div>

<div class="viewcode-block" id="MaterialsProjectFeatureGenerator.generate_materialsproject_features"><a class="viewcode-back" href="../../api/mastml.feature_generators.MaterialsProjectFeatureGenerator.html#mastml.feature_generators.MaterialsProjectFeatureGenerator.generate_materialsproject_features">[docs]</a>    <span class="k">def</span> <span class="nf">generate_materialsproject_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">compositions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_feature</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No column named </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_feature</span><span class="si">}</span><span class="s1"> in csv file&#39;</span><span class="p">)</span>

        <span class="n">mpdata_dict_composition</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">comp_data_mp</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_data_from_materials_project</span><span class="p">,</span> <span class="n">compositions</span><span class="p">)</span>

        <span class="n">mpdata_dict_composition</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">compositions</span><span class="p">,</span> <span class="n">comp_data_mp</span><span class="p">)))</span>

        <span class="n">dataframe_mp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mpdata_dict_composition</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="c1"># Need to reorder compositions in new dataframe to match input dataframe</span>
        <span class="n">dataframe_mp</span> <span class="o">=</span> <span class="n">dataframe_mp</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_feature</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="c1"># Need to make compositions the first column, instead of the row names</span>
        <span class="n">dataframe_mp</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_feature</span>
        <span class="n">dataframe_mp</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Need to delete duplicate column before merging dataframes</span>
        <span class="k">del</span> <span class="n">dataframe_mp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">composition_feature</span><span class="p">]</span>
        <span class="c1"># Merge magpie feature dataframe with originally supplied dataframe</span>
        <span class="c1">#dataframe = DataframeUtilities().merge_dataframe_columns(dataframe1=X, dataframe2=dataframe_mp)</span>
        <span class="k">return</span> <span class="n">dataframe_mp</span></div>

    <span class="k">def</span> <span class="nf">_get_data_from_materials_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">composition</span><span class="p">):</span>
        <span class="n">mprester</span> <span class="o">=</span> <span class="n">MPRester</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="p">)</span>
        <span class="n">structure_data_list</span> <span class="o">=</span> <span class="n">mprester</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">chemsys_formula_id</span><span class="o">=</span><span class="n">composition</span><span class="p">)</span>

        <span class="c1"># Sort structures by stability (i.e. E above hull), and only return most stable compound data</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">structure_data_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">structure_data_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">structure_data_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e_above</span><span class="p">:</span> <span class="n">e_above</span><span class="p">[</span><span class="s1">&#39;e_above_hull&#39;</span><span class="p">])</span>
            <span class="n">structure_data_most_stable</span> <span class="o">=</span> <span class="n">structure_data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">structure_data_most_stable</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Trim down the full Materials Project data dict to include only quantities relevant to make features</span>
        <span class="n">structure_data_dict_condensed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">property_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;G_Voigt_Reuss_Hill&quot;</span><span class="p">,</span> <span class="s2">&quot;G_Reuss&quot;</span><span class="p">,</span> <span class="s2">&quot;K_Voigt_Reuss_Hill&quot;</span><span class="p">,</span> <span class="s2">&quot;K_Reuss&quot;</span><span class="p">,</span> <span class="s2">&quot;K_Voigt&quot;</span><span class="p">,</span> <span class="s2">&quot;G_Voigt&quot;</span><span class="p">,</span> <span class="s2">&quot;G_VRH&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;homogeneous_poisson&quot;</span><span class="p">,</span> <span class="s2">&quot;poisson_ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;universal_anisotropy&quot;</span><span class="p">,</span> <span class="s2">&quot;K_VRH&quot;</span><span class="p">,</span> <span class="s2">&quot;elastic_anisotropy&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;band_gap&quot;</span><span class="p">,</span> <span class="s2">&quot;e_above_hull&quot;</span><span class="p">,</span> <span class="s2">&quot;formation_energy_per_atom&quot;</span><span class="p">,</span> <span class="s2">&quot;nelements&quot;</span><span class="p">,</span> <span class="s2">&quot;energy_per_atom&quot;</span><span class="p">,</span> <span class="s2">&quot;volume&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;density&quot;</span><span class="p">,</span> <span class="s2">&quot;total_magnetization&quot;</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">]</span>
        <span class="n">elastic_property_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;G_Voigt_Reuss_Hill&quot;</span><span class="p">,</span> <span class="s2">&quot;G_Reuss&quot;</span><span class="p">,</span> <span class="s2">&quot;K_Voigt_Reuss_Hill&quot;</span><span class="p">,</span> <span class="s2">&quot;K_Reuss&quot;</span><span class="p">,</span> <span class="s2">&quot;K_Voigt&quot;</span><span class="p">,</span> <span class="s2">&quot;G_Voigt&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;G_VRH&quot;</span><span class="p">,</span> <span class="s2">&quot;homogeneous_poisson&quot;</span><span class="p">,</span> <span class="s2">&quot;poisson_ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;universal_anisotropy&quot;</span><span class="p">,</span> <span class="s2">&quot;K_VRH&quot;</span><span class="p">,</span> <span class="s2">&quot;elastic_anisotropy&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">structure_data_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">property_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">elastic_property_list</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">structure_data_dict_condensed</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">structure_data_most_stable</span><span class="p">[</span><span class="s2">&quot;elasticity&quot;</span><span class="p">][</span><span class="n">prop</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="n">structure_data_dict_condensed</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="n">prop</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">structure_data_dict_condensed</span><span class="p">[</span><span class="s2">&quot;Spacegroup_&quot;</span><span class="o">+</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">structure_data_most_stable</span><span class="p">[</span><span class="s2">&quot;spacegroup&quot;</span><span class="p">][</span><span class="n">prop</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="n">structure_data_dict_condensed</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">structure_data_dict_condensed</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">structure_data_most_stable</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="n">structure_data_dict_condensed</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">property_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">:</span>
                    <span class="n">structure_data_dict_condensed</span><span class="p">[</span><span class="s2">&quot;Spacegroup_&quot;</span><span class="o">+</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">structure_data_dict_condensed</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">return</span> <span class="n">structure_data_dict_condensed</span></div>


<span class="c1"># TODO: finish assessing each method compatability</span>
<div class="viewcode-block" id="MatminerFeatureGenerator"><a class="viewcode-back" href="../../api/mastml.feature_generators.MatminerFeatureGenerator.html#mastml.feature_generators.MatminerFeatureGenerator">[docs]</a><span class="k">class</span> <span class="nc">MatminerFeatureGenerator</span><span class="p">(</span><span class="n">BaseGenerator</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class to wrap feature generator routines contained in the matminer package to more neatly conform to the</span>
<span class="sd">    MAST-ML working environment, and have all under a single class</span>

<span class="sd">    Args:</span>
<span class="sd">        featurize_df: (pd.DataFrame), input dataframe to be featurized. Needs to contain at least a column with chemical compositions or pymatgen Structure objects</span>

<span class="sd">        featurizer: (str), type of featurization to conduct. Valid names are &quot;composition&quot; or &quot;structure&quot;</span>

<span class="sd">        composition_feature_types: (list of str), if featurizer=&#39;composition&#39;, the type of composition-based features to include. Valid values are &#39;magpie&#39;, &#39;deml&#39;, &#39;matminer&#39;, &#39;matscholar_el&#39;, &#39;megnet_el&#39;</span>

<span class="sd">        structure_feature_type: (str), if featurizer=&#39;structure&#39;, the type of structure-based featurization to conduct. See list below for valid names.</span>

<span class="sd">        remove_constant_columns: (bool), whether or not to remove feature columns that are constant values. Default is False.</span>

<span class="sd">        kwargs: additional keyword arguments needed if structure based features are being made</span>


<span class="sd">    Available structure featurizer types for structure_feature_types:</span>
<span class="sd">        matminer.featurizers.structure</span>
<span class="sd">        [&#39;BagofBonds&#39;, x</span>
<span class="sd">        &#39;BondFractions&#39;, x</span>
<span class="sd">        &#39;ChemicalOrdering&#39;, x</span>
<span class="sd">        &#39;CoulombMatrix&#39;, x</span>
<span class="sd">        &#39;DensityFeatures&#39;, x</span>
<span class="sd">        &#39;Dimensionality&#39;, x</span>
<span class="sd">        &#39;ElectronicRadialDistributionFunction&#39;, NEEDS TO BE FLATTENED</span>
<span class="sd">        &#39;EwaldEnergy&#39;, x, returns all NaN</span>
<span class="sd">        &#39;GlobalInstabilityIndex&#39;, x, returns all NaN</span>
<span class="sd">        &#39;GlobalSymmetryFeatures&#39;, x</span>
<span class="sd">        &#39;JarvisCFID&#39;, x</span>
<span class="sd">        &#39;MaximumPackingEfficiency&#39;, x</span>
<span class="sd">        &#39;MinimumRelativeDistances&#39;, x</span>
<span class="sd">        &#39;OrbitalFieldMatrix&#39;, x</span>
<span class="sd">        &#39;PartialRadialDistributionFunction&#39;, x</span>
<span class="sd">        &#39;RadialDistributionFunction&#39;, NEEDS TO BE FLATTENED</span>
<span class="sd">        &#39;SineCoulombMatrix&#39;, x</span>
<span class="sd">        &#39;SiteStatsFingerprint&#39;, x</span>
<span class="sd">        &#39;StructuralComplexity&#39;, x</span>
<span class="sd">        &#39;StructuralHeterogeneity&#39;, x</span>
<span class="sd">        &#39;XRDPowderPattern&#39;] x</span>

<span class="sd">        matminer.featurizers.site</span>
<span class="sd">        [&#39;AGNIFingerprints&#39;,</span>
<span class="sd">        &#39;AngularFourierSeries&#39;,</span>
<span class="sd">        &#39;AseAtomsAdaptor&#39;,</span>
<span class="sd">        &#39;AverageBondAngle&#39;,</span>
<span class="sd">        &#39;AverageBondLength&#39;,</span>
<span class="sd">        &#39;BondOrientationalParameter&#39;,</span>
<span class="sd">        &#39;ChemEnvSiteFingerprint&#39;,</span>
<span class="sd">        &#39;ChemicalSRO&#39;,</span>
<span class="sd">        &#39;ConvexHull&#39;,</span>
<span class="sd">        &#39;CoordinationNumber&#39;,</span>
<span class="sd">        &#39;CrystalNN&#39;,</span>
<span class="sd">        &#39;CrystalNNFingerprint&#39;,</span>
<span class="sd">        &#39;Element&#39;,</span>
<span class="sd">        &#39;EwaldSiteEnergy&#39;,</span>
<span class="sd">        &#39;EwaldSummation&#39;,</span>
<span class="sd">        &#39;Gaussian&#39;,</span>
<span class="sd">        &#39;GaussianSymmFunc&#39;,</span>
<span class="sd">        &#39;GeneralizedRadialDistributionFunction&#39;,</span>
<span class="sd">        &#39;Histogram&#39;,</span>
<span class="sd">        &#39;IntersticeDistribution&#39;,</span>
<span class="sd">        &#39;LocalGeometryFinder&#39;,</span>
<span class="sd">        &#39;LocalPropertyDifference&#39;,</span>
<span class="sd">        &#39;LocalStructOrderParams&#39;,</span>
<span class="sd">        &#39;MagpieData&#39;,</span>
<span class="sd">        &#39;MultiWeightsChemenvStrategy&#39;,</span>
<span class="sd">        &#39;OPSiteFingerprint&#39;,</span>
<span class="sd">        &#39;SOAP&#39;,</span>
<span class="sd">        &#39;SimplestChemenvStrategy&#39;,</span>
<span class="sd">        &#39;SiteElementalProperty&#39;,</span>
<span class="sd">        &#39;VoronoiFingerprint&#39;,</span>
<span class="sd">        &#39;VoronoiNN&#39;]</span>

<span class="sd">    Methods:</span>
<span class="sd">        fit: present for convenience and just passes through</span>
<span class="sd">            Args:</span>
<span class="sd">                X: (pd.DataFrame), the X feature matrix</span>

<span class="sd">            Returns:</span>
<span class="sd">                self</span>

<span class="sd">        transform: generates new features and transforms to have new dataframe with generated features</span>
<span class="sd">            Args:</span>
<span class="sd">                X: (pd.DataFrame), the X feature matrix</span>

<span class="sd">            Returns:</span>
<span class="sd">                df: (pd.DataFrame), the transformed dataframe containing generated features</span>

<span class="sd">                y: (pd.Series), the target y-data</span>

<span class="sd">        generate_matminer_features: method to generate the composition or structure features of interest</span>
<span class="sd">            Args:</span>
<span class="sd">                X: (pd.DataFrame), the X feature matrix</span>

<span class="sd">            Returns:</span>
<span class="sd">                df: (pd.DataFrame), the transformed dataframe containing generated features</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">featurize_df</span><span class="p">,</span> <span class="n">featurizer</span><span class="p">,</span> <span class="n">composition_feature_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;magpie&#39;</span><span class="p">,</span> <span class="s1">&#39;deml&#39;</span><span class="p">,</span> <span class="s1">&#39;matminer&#39;</span><span class="p">],</span>
                 <span class="n">structure_feature_type</span> <span class="o">=</span> <span class="s1">&#39;CoulombMatrix&#39;</span><span class="p">,</span> <span class="n">remove_constant_columns</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MatminerFeatureGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featurize_df</span> <span class="o">=</span> <span class="n">featurize_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">=</span> <span class="n">featurizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition_feature_types</span> <span class="o">=</span> <span class="n">composition_feature_types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure_feature_type</span> <span class="o">=</span> <span class="n">structure_feature_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_constant_columns</span> <span class="o">=</span> <span class="n">remove_constant_columns</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;structure&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">matminer</span><span class="o">.</span><span class="n">featurizers</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_feature_type</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">matminer</span><span class="o">.</span><span class="n">featurizers</span><span class="o">.</span><span class="n">site</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure_feature_type</span><span class="p">)(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;SiteStatsFingerprint&#39;</span><span class="p">:</span>
                <span class="n">site_featurizer</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">matminer</span><span class="o">.</span><span class="n">featurizers</span><span class="o">.</span><span class="n">site</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;site_featurizer&#39;</span><span class="p">])()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">=</span> <span class="n">matminer</span><span class="o">.</span><span class="n">featurizers</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">SiteStatsFingerprint</span><span class="p">(</span><span class="n">site_featurizer</span><span class="o">=</span><span class="n">site_featurizer</span><span class="p">)</span>
        <span class="k">return</span>

<div class="viewcode-block" id="MatminerFeatureGenerator.fit"><a class="viewcode-back" href="../../api/mastml.feature_generators.MatminerFeatureGenerator.html#mastml.feature_generators.MatminerFeatureGenerator.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_features</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="MatminerFeatureGenerator.transform"><a class="viewcode-back" href="../../api/mastml.feature_generators.MatminerFeatureGenerator.html#mastml.feature_generators.MatminerFeatureGenerator.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_matminer_features</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">)</span>
        <span class="c1"># Clean dataframe in case some values missing</span>
        <span class="c1">#df = DataframeUtilities().clean_dataframe(df)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_constant_columns</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurize_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">DataframeUtilities</span><span class="p">()</span><span class="o">.</span><span class="n">remove_constant_columns</span><span class="p">(</span><span class="n">dataframe</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span></div>

<div class="viewcode-block" id="MatminerFeatureGenerator.generate_matminer_features"><a class="viewcode-back" href="../../api/mastml.feature_generators.MatminerFeatureGenerator.html#mastml.feature_generators.MatminerFeatureGenerator.generate_matminer_features">[docs]</a>    <span class="k">def</span> <span class="nf">generate_matminer_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="c1"># Get the featurizer object type specified by featurizer string</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featurize_df</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">featurize_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featurize_df</span><span class="p">)</span>
        <span class="n">df_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurize_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">featurize_df</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span> <span class="o">==</span> <span class="s1">&#39;composition&#39;</span><span class="p">:</span>
            <span class="c1"># Change composition strings to pymatgen Composition objects</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">StrToComposition</span><span class="p">()</span><span class="o">.</span><span class="n">featurize_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">df_col</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">CompositionToOxidComposition</span><span class="p">()</span><span class="o">.</span><span class="n">featurize_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;composition&quot;</span><span class="p">)</span>
            <span class="n">featurizers</span> <span class="o">=</span> <span class="p">[</span><span class="n">ElementProperty</span><span class="o">.</span><span class="n">from_preset</span><span class="p">(</span><span class="n">preset_name</span><span class="o">=</span><span class="n">composition_feature_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">composition_feature_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition_feature_types</span><span class="p">]</span>
            <span class="n">featurizers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OxidationStates</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">featurizer</span> <span class="ow">in</span> <span class="n">featurizers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">featurizer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;OxidationStates&#39;</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">featurizer</span><span class="o">.</span><span class="n">featurize_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col_id</span><span class="o">=</span><span class="s1">&#39;composition_oxid&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">featurizer</span><span class="o">.</span><span class="n">featurize_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col_id</span><span class="o">=</span><span class="s1">&#39;composition&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
        <span class="c1">#elif self.featurizer == &#39;structure&#39;:</span>
            <span class="c1">#try:</span>
            <span class="c1">#    featurizer = getattr(matminer.featurizers.structure, self.structure_feature_type)(self.kwargs)</span>
            <span class="c1">#except:</span>
            <span class="c1">#    featurizer = getattr(matminer.featurizers.site, self.structure_feature_type)(self.kwargs)</span>
            <span class="c1">#if len(self.structure_feature_params.keys()) == 0:</span>
            <span class="c1">#    # Just use default params</span>
            <span class="c1">#    featurizer_instance = featurizer(self.kwargs)</span>
            <span class="c1">#else:</span>
            <span class="c1">#featurizer_instance = featurizer(self.args)</span>
            <span class="c1">#print(&#39;HERE&#39;)</span>
            <span class="c1">#print(featurizer)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;BagofBonds&#39;</span><span class="p">,</span> <span class="s1">&#39;BondFractions&#39;</span><span class="p">,</span> <span class="s1">&#39;CoulombMatrix&#39;</span><span class="p">,</span> <span class="s1">&#39;SineCoulombMatrix&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;PartialRadialDistributionFunction&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df_col</span><span class="p">])</span>

            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span><span class="o">.</span><span class="n">featurize_dataframe</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">col_id</span><span class="o">=</span><span class="n">df_col</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div></div>


<div class="viewcode-block" id="DataframeUtilities"><a class="viewcode-back" href="../../api/mastml.feature_generators.DataframeUtilities.html#mastml.feature_generators.DataframeUtilities">[docs]</a><span class="k">class</span> <span class="nc">DataframeUtilities</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class of basic utilities for dataframe manipulation, and exchanging between dataframes and numpy arrays</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>

<span class="sd">    Methods:</span>
<span class="sd">        clean_dataframe : Method to clean dataframes after feature generation has occurred, to remove columns that have a single missing or NaN value, or remove a row that is fully empty</span>
<span class="sd">            Args:</span>
<span class="sd">                df: (dataframe), a post feature generation dataframe that needs cleaning</span>

<span class="sd">        Returns:</span>
<span class="sd">            df: (dataframe), the cleaned dataframe</span>

<span class="sd">        merge_dataframe_columns : merge two dataframes by concatenating the column names (duplicate columns omitted)</span>
<span class="sd">            Args:</span>
<span class="sd">                dataframe1: (dataframe), a pandas dataframe object</span>

<span class="sd">                dataframe2: (dataframe), a pandas dataframe object</span>

<span class="sd">            Returns:</span>
<span class="sd">                dataframe: (dataframe), merged dataframe</span>

<span class="sd">        merge_dataframe_rows : merge two dataframes by concatenating the row contents (duplicate rows omitted)</span>
<span class="sd">            Args:</span>
<span class="sd">                dataframe1: (dataframe), a pandas dataframe object</span>

<span class="sd">                dataframe2: (dataframe), a pandas dataframe object</span>

<span class="sd">            Returns:</span>
<span class="sd">                dataframe: (dataframe), merged dataframe</span>

<span class="sd">        get_dataframe_statistics : obtain basic statistics about data contained in the dataframe</span>
<span class="sd">            Args:</span>
<span class="sd">                dataframe: (dataframe), a pandas dataframe object</span>

<span class="sd">            Returns:</span>
<span class="sd">                dataframe_stats: (dataframe), dataframe containing input dataframe statistics</span>

<span class="sd">        dataframe_to_array : transform a pandas dataframe to a numpy array</span>
<span class="sd">            Args:</span>
<span class="sd">                dataframe: (dataframe), a pandas dataframe object</span>

<span class="sd">            Returns:</span>
<span class="sd">                array: (numpy array), a numpy array representation of the inputted dataframe</span>

<span class="sd">        array_to_dataframe : transform a numpy array to a pandas dataframe</span>
<span class="sd">            Args:</span>
<span class="sd">                array: (numpy array), a numpy array</span>

<span class="sd">            Returns:</span>
<span class="sd">                dataframe: (dataframe), a pandas dataframe representation of the inputted numpy array</span>

<span class="sd">        concatenate_arrays : merge two numpy arrays by concatenating along the columns</span>
<span class="sd">            Args:</span>
<span class="sd">                Xarray: (numpy array), a numpy array object</span>

<span class="sd">                yarray: (numpy array), a numpy array object</span>

<span class="sd">            Returns:</span>
<span class="sd">                array: (numpy array), a numpy array merging the two input arrays</span>

<span class="sd">        assign_columns_as_features : adds column names to dataframe based on the x and y feature names</span>
<span class="sd">            Args:</span>
<span class="sd">                dataframe: (dataframe), a pandas dataframe object</span>

<span class="sd">                x_features: (list), list containing x feature names</span>

<span class="sd">                y_feature: (str), target feature name</span>

<span class="sd">            Returns:</span>
<span class="sd">                dataframe: (dataframe), dataframe containing same data as input, with columns labeled with features</span>

<span class="sd">        save_all_dataframe_statistics : obtain dataframe statistics and save it to a csv file</span>
<span class="sd">            Args:</span>
<span class="sd">                dataframe: (dataframe), a pandas dataframe object</span>

<span class="sd">                data_path: (str), file path to save dataframe statistics to</span>

<span class="sd">            Returns:</span>
<span class="sd">                fname: (str), name of file dataframe stats saved to</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="DataframeUtilities.clean_dataframe"><a class="viewcode-back" href="../../api/mastml.feature_generators.DataframeUtilities.html#mastml.feature_generators.DataframeUtilities.clean_dataframe">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">clean_dataframe</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>  <span class="c1"># convert non-number to NaN</span>

        <span class="c1"># warn on empty rows</span>
        <span class="n">before_count</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">lost_count</span> <span class="o">=</span> <span class="n">before_count</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lost_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dropping </span><span class="si">{</span><span class="n">lost_count</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">before_count</span><span class="si">}</span><span class="s1"> rows for being totally empty&#39;</span><span class="p">)</span>

        <span class="c1"># drop columns with any empty cells</span>
        <span class="n">before_count</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">([</span><span class="s1">&#39;number&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lost_count</span> <span class="o">=</span> <span class="n">before_count</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lost_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dropping </span><span class="si">{</span><span class="n">lost_count</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">before_count</span><span class="si">}</span><span class="s1"> generated columns due to missing values&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="DataframeUtilities.merge_dataframe_columns"><a class="viewcode-back" href="../../api/mastml.feature_generators.DataframeUtilities.html#mastml.feature_generators.DataframeUtilities.merge_dataframe_columns">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">merge_dataframe_columns</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dataframe1</span><span class="p">,</span> <span class="n">dataframe2</span><span class="p">):</span>
        <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataframe1</span><span class="p">,</span> <span class="n">dataframe2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataframe</span></div>

<div class="viewcode-block" id="DataframeUtilities.merge_dataframe_rows"><a class="viewcode-back" href="../../api/mastml.feature_generators.DataframeUtilities.html#mastml.feature_generators.DataframeUtilities.merge_dataframe_rows">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">merge_dataframe_rows</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dataframe1</span><span class="p">,</span> <span class="n">dataframe2</span><span class="p">):</span>
        <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">dataframe1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">dataframe2</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
        <span class="c1">#dataframe = pd.concat([dataframe1, dataframe2], axis=1, join=&#39;outer&#39;)</span>
        <span class="k">return</span> <span class="n">dataframe</span></div>

<div class="viewcode-block" id="DataframeUtilities.get_dataframe_statistics"><a class="viewcode-back" href="../../api/mastml.feature_generators.DataframeUtilities.html#mastml.feature_generators.DataframeUtilities.get_dataframe_statistics">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_dataframe_statistics</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">):</span>
        <span class="n">dataframe_stats</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataframe_stats</span></div>

<div class="viewcode-block" id="DataframeUtilities.dataframe_to_array"><a class="viewcode-back" href="../../api/mastml.feature_generators.DataframeUtilities.html#mastml.feature_generators.DataframeUtilities.dataframe_to_array">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">dataframe_to_array</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">):</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">array</span></div>

<div class="viewcode-block" id="DataframeUtilities.array_to_dataframe"><a class="viewcode-back" href="../../api/mastml.feature_generators.DataframeUtilities.html#mastml.feature_generators.DataframeUtilities.array_to_dataframe">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">array_to_dataframe</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">array</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">dataframe</span></div>

<div class="viewcode-block" id="DataframeUtilities.concatenate_arrays"><a class="viewcode-back" href="../../api/mastml.feature_generators.DataframeUtilities.html#mastml.feature_generators.DataframeUtilities.concatenate_arrays">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">concatenate_arrays</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">X_array</span><span class="p">,</span> <span class="n">y_array</span><span class="p">):</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">X_array</span><span class="p">,</span> <span class="n">y_array</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">array</span></div>

<div class="viewcode-block" id="DataframeUtilities.assign_columns_as_features"><a class="viewcode-back" href="../../api/mastml.feature_generators.DataframeUtilities.html#mastml.feature_generators.DataframeUtilities.assign_columns_as_features">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">assign_columns_as_features</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">x_features</span><span class="p">,</span> <span class="n">y_feature</span><span class="p">,</span> <span class="n">remove_first_row</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">column_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">x_and_y_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">x_features</span><span class="p">]</span>
        <span class="n">x_and_y_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_feature</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_and_y_features</span><span class="p">):</span>
            <span class="n">column_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature</span>
        <span class="n">dataframe</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">column_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remove_first_row</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">dataframe</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># Need to remove feature names from first row so can obtain data</span>
        <span class="k">return</span> <span class="n">dataframe</span></div>

<div class="viewcode-block" id="DataframeUtilities.save_all_dataframe_statistics"><a class="viewcode-back" href="../../api/mastml.feature_generators.DataframeUtilities.html#mastml.feature_generators.DataframeUtilities.save_all_dataframe_statistics">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">save_all_dataframe_statistics</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">configdict</span><span class="p">):</span>
        <span class="n">dataframe_stats</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_dataframe_statistics</span><span class="p">(</span><span class="n">dataframe</span><span class="o">=</span><span class="n">dataframe</span><span class="p">)</span>
        <span class="c1"># Need configdict to get save path</span>
        <span class="c1">#if not configfile_path:</span>
        <span class="c1">#    configdict = ConfigFileParser(configfile=sys.argv[1]).get_config_dict(path_to_file=os.getcwd())</span>
            <span class="c1">#data_path_name = data_path.split(&#39;./&#39;)[1]</span>
            <span class="c1">#data_path_name = data_path_name.split(&#39;.csv&#39;)[0]</span>
        <span class="c1">#    data_path_name = configdict[&#39;General Setup&#39;][&#39;target_feature&#39;]</span>
        <span class="c1">#else:</span>
        <span class="c1">#    configdict = ConfigFileParser(configfile=configfile_name).get_config_dict(path_to_file=configfile_path)</span>
        <span class="n">data_path_name</span> <span class="o">=</span> <span class="n">configdict</span><span class="p">[</span><span class="s1">&#39;General Setup&#39;</span><span class="p">][</span><span class="s1">&#39;target_feature&#39;</span><span class="p">]</span> <span class="c1"># TODO</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">configdict</span><span class="p">[</span><span class="s1">&#39;General Setup&#39;</span><span class="p">][</span><span class="s1">&#39;save_path&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s1">&#39;input_data_statistics_&#39;</span><span class="o">+</span><span class="n">data_path_name</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span>
        <span class="n">dataframe_stats</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fname</span></div>

<div class="viewcode-block" id="DataframeUtilities.remove_constant_columns"><a class="viewcode-back" href="../../api/mastml.feature_generators.DataframeUtilities.html#mastml.feature_generators.DataframeUtilities.remove_constant_columns">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">remove_constant_columns</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">):</span>
        <span class="n">nunique</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="o">.</span><span class="n">nunique</span><span class="p">)</span>
        <span class="n">cols_to_drop</span> <span class="o">=</span> <span class="n">nunique</span><span class="p">[</span><span class="n">nunique</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="n">dataframe</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">cols_to_drop</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataframe</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2021, University of Wisconsin-Madison Computational Materials Group

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>