

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>plot_helper &mdash; MAterials Simulation Toolkit for Machine Learning (MAST-ML) 2.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> MAterials Simulation Toolkit for Machine Learning (MAST-ML)
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../00_acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0_installation.html">Installing MAST-ML</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../0_1_hardware_data_requirements.html">Hardware and Data Requirements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../0_1_hardware_data_requirements.html#hardware">Hardware</a></li>
<li class="toctree-l3"><a class="reference internal" href="../0_1_hardware_data_requirements.html#data">Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../0_1_terminal_installation.html">Terminal installation (Linux or linux-like terminal on Mac)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../0_1_terminal_installation.html#install-python3">Install Python3</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../0_1_terminal_installation.html#create-a-conda-environment">Create a conda environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../0_1_terminal_installation.html#set-up-juptyer-notebooks">Set up Juptyer notebooks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../0_1_terminal_installation.html#install-the-mast-ml-package">Install the MAST-ML package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../0_1_terminal_installation.html#imports-that-dont-work">Imports that don’t work</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../0_2_windows_installation.html">Windows installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../0_2_windows_installation.html#install-python3">Install Python3</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../0_2_windows_installation.html#create-a-conda-environment">Create a conda environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../0_2_windows_installation.html#set-up-the-spyder-ide-and-jupyter-notebooks">Set up the Spyder IDE and Jupyter notebooks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../0_2_windows_installation.html#install-the-mast-ml-package">Install the MAST-ML package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../0_2_windows_installation.html#imports-that-dont-work">Imports that don’t work</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../0_2_windows_installation.html#windows-10-install-step-by-step-guide-credit-joe-kern">Windows 10 install: step-by-step guide (credit Joe Kern)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../0_3_startup.html">Startup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../0_3_startup.html#locate-the-examples-folder">Locate the examples folder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../0_3_startup.html#run-the-mastml-command">Run the MASTML command</a></li>
<li class="toctree-l3"><a class="reference internal" href="../0_3_startup.html#check-output">Check output</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../1_mastml_inputfile.html">MAST-ML Input File</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../1_mastml_inputfile.html#input-file-sections">Input file sections</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../1_mastml_inputfile.html#general-setup">General Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1_mastml_inputfile.html#data-cleaning">Data Cleaning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1_mastml_inputfile.html#clustering">Clustering</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1_mastml_inputfile.html#feature-generation">Feature Generation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1_mastml_inputfile.html#feature-normalization">Feature Normalization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1_mastml_inputfile.html#learning-curve">Learning Curve</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1_mastml_inputfile.html#feature-selection">Feature Selection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1_mastml_inputfile.html#data-splits">Data Splits</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1_mastml_inputfile.html#models">Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../1_mastml_inputfile.html#misc-settings">Misc Settings</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../2_mastml_overview.html">MAST-ML overview slides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_running_mastml_nanohub.html">Running MAST-ML on Nanohub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2_mastml_tutorial.html">MAST-ML tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../2_mastml_tutorial_introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_mastml_tutorial_firstrun.html">Your first MAST-ML run</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_mastml_tutorial_cleaning.html">Cleaning input data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_mastml_tutorial_featuregen.html">Feature generation and normalization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_mastml_tutorial_firstmodel.html">Training and evaluating your first model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_mastml_tutorial_featureselect.html">Feature selection and learning curves</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_mastml_tutorial_hyperparam.html">Hyperparameter optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_mastml_tutorial_logcv.html">Random leave-out versus leave-out-group cross-validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_mastml_tutorial_modelimport.html">Making predictions by importing a previously fit model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../2_mastml_tutorial_prediction.html">Predicting values for new, extrapolated data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../3_code_documentation.html">MAST-ML Code Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../3_metrics.html">Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4_conf_parser.html">Configuration file parser</a></li>
<li class="toctree-l2"><a class="reference internal" href="../5_data_cleaner.html">Data cleaner</a></li>
<li class="toctree-l2"><a class="reference internal" href="../6_data_loader.html">Data loader</a></li>
<li class="toctree-l2"><a class="reference internal" href="../7_learning_curve.html">Learning curve</a></li>
<li class="toctree-l2"><a class="reference internal" href="../8_clusterers.html">Clusterers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../9_data_splitters.html">Data splitters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10_utils.html">Utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../11_mastml_driver.html">MAST-ML Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../12_plot_helper.html">Plot Helper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../13_html_helper.html">HTML Helper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../14_feature_selectors.html">Feature Selectors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../15_feature_normalizers.html">Feature Normalizers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../16_randomizers.html">Randomizers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../17_model_finder.html">Model Finder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../18_util_legos.html">Utility Legos</a></li>
<li class="toctree-l2"><a class="reference internal" href="../19_feature_generators.html">Feature Generators</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MAterials Simulation Toolkit for Machine Learning (MAST-ML)</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>plot_helper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for plot_helper</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains a collection of functions which make plots (saved as png files) using matplotlib, generated from</span>
<span class="sd">some model fits and cross-validation evaluation within a MAST-ML run.</span>

<span class="sd">This module also contains a method to create python notebooks containing plotted data and the relevant source code from</span>
<span class="sd">this module, to enable the user to make their own modifications to the created plots in a straightforward way (useful for</span>
<span class="sd">tweaking plots for a presentation or publication).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">statistics</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">floor</span><span class="p">,</span> <span class="n">ceil</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="k">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="k">import</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble._forest</span> <span class="k">import</span> <span class="n">_generate_sample_indices</span><span class="p">,</span> <span class="n">_get_n_samples_bootstrap</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="k">import</span> <span class="n">make_axes_locatable</span>

<span class="c1"># Ignore the harmless warning about the gelsd driver on mac.</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;scipy&quot;</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;^internal gelsd&quot;</span><span class="p">)</span>
<span class="c1"># Ignore matplotlib deprecation warning (set as all warnings for now)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="k">import</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">roc_curve</span><span class="p">,</span> <span class="n">auc</span><span class="p">,</span> <span class="n">precision_recall_curve</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_agg</span> <span class="k">import</span> <span class="n">FigureCanvasAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="k">import</span> <span class="n">Figure</span><span class="p">,</span> <span class="n">figaspect</span>
<span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="k">import</span> <span class="n">FuncAnimation</span>
<span class="kn">from</span> <span class="nn">matplotlib.font_manager</span> <span class="k">import</span> <span class="n">FontProperties</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="k">import</span> <span class="n">gaussian_kde</span><span class="p">,</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="k">import</span> <span class="n">mark_inset</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="k">import</span> <span class="n">zoomed_inset_axes</span>

<span class="c1"># Needed imports for ipynb_maker</span>
<span class="c1">#from mastml.utils import nice_range</span>
<span class="c1">#from mastml.metrics import nice_names</span>

<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="k">import</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">Series</span>

<span class="kn">import</span> <span class="nn">nbformat</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>

<span class="kn">import</span> <span class="nn">forestci</span> <span class="k">as</span> <span class="nn">fci</span>
<span class="kn">from</span> <span class="nn">forestci.calibration</span> <span class="k">import</span> <span class="n">calibrateEB</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="s1">&#39;sans-serif&#39;</span><span class="p">)</span> <span class="c1"># set all font to bigger</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;figure&#39;</span><span class="p">,</span> <span class="n">autolayout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># turn on autolayout</span>

<span class="c1"># adding dpi as a constant global so it can be changed later</span>
<span class="n">DPI</span> <span class="o">=</span> <span class="mi">250</span>

<span class="c1">#logger = logging.getLogger() # only used inside ipynb_maker I guess</span>

<span class="c1"># HEADERENDER don&#39;t delete this line, it&#39;s used by ipynb maker</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;mastml&#39;</span><span class="p">)</span> <span class="c1"># the real logger</span>

<div class="viewcode-block" id="ipynb_maker"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.ipynb_maker">[docs]</a><span class="k">def</span> <span class="nf">ipynb_maker</span><span class="p">(</span><span class="n">plot_func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method creates Jupyter Notebooks so user can modify and regenerate the plots produced by MAST-ML.</span>

<span class="sd">    Args:</span>

<span class="sd">        plot_func: (plot_helper method), a plotting method contained in plot_helper.py which contains the</span>

<span class="sd">        @ipynb_maker decorator</span>

<span class="sd">    Returns:</span>

<span class="sd">        (plot_helper method), the same plot_func as used as input, but after having written the Jupyter notebook with source code to create plot</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">mastml</span> <span class="k">import</span> <span class="n">plot_helper</span> <span class="c1"># Strange self-import but it works, as had cyclic import issues with ipynb_maker as its own module</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">plot_func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># convert everything to kwargs for easier display</span>
        <span class="c1"># from geniuses at https://stackoverflow.com/a/831164</span>
        <span class="c1">#kwargs.update(dict(zip(plot_func.func_code.co_varnames, args)))</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">plot_func</span><span class="p">)</span>
        <span class="n">binding</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">all_args</span> <span class="o">=</span> <span class="n">binding</span><span class="o">.</span><span class="n">arguments</span>

        <span class="c1"># if this is an outdir style function, fill in savepath and delete outdir</span>
        <span class="k">if</span> <span class="s1">&#39;savepath&#39;</span> <span class="ow">in</span> <span class="n">all_args</span><span class="p">:</span>
            <span class="n">ipynb_savepath</span> <span class="o">=</span> <span class="n">all_args</span><span class="p">[</span><span class="s1">&#39;savepath&#39;</span><span class="p">]</span>
            <span class="n">knows_savepath</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ipynb_savepath</span><span class="p">)</span> <span class="c1"># fix absolute path problem</span>
        <span class="k">elif</span> <span class="s1">&#39;outdir&#39;</span> <span class="ow">in</span> <span class="n">all_args</span><span class="p">:</span>
            <span class="n">knows_savepath</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">plot_func</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">ipynb_savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_args</span><span class="p">[</span><span class="s1">&#39;outdir&#39;</span><span class="p">],</span> <span class="n">basename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;you must have an &quot;outdir&quot; or &quot;savepath&quot; argument to use ipynb_maker&#39;</span><span class="p">)</span>

        <span class="n">readme</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">            This notebook was automatically generated from your MAST-ML run so you can recreate the</span>
<span class="s2">            plots. Some things are a bit different from the usual way of creating plots - we are</span>
<span class="s2">            using the [object oriented</span>
<span class="s2">            interface](https://matplotlib.org/tutorials/introductory/lifecycle.html) instead of</span>
<span class="s2">            pyplot to create the `fig` and `ax` instances.</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># get source of the top of plot_helper.py</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">plot_helper</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;HEADERENDER&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">header</span> <span class="o">+=</span> <span class="n">line</span>

        <span class="n">core_funcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">plot_helper</span><span class="o">.</span><span class="n">stat_to_string</span><span class="p">,</span> <span class="n">plot_helper</span><span class="o">.</span><span class="n">plot_stats</span><span class="p">,</span> <span class="n">plot_helper</span><span class="o">.</span><span class="n">make_fig_ax</span><span class="p">,</span>
                      <span class="n">plot_helper</span><span class="o">.</span><span class="n">get_histogram_bins</span><span class="p">,</span> <span class="n">plot_helper</span><span class="o">.</span><span class="n">nice_names</span><span class="p">,</span> <span class="n">plot_helper</span><span class="o">.</span><span class="n">nice_range</span><span class="p">,</span>
                      <span class="n">plot_helper</span><span class="o">.</span><span class="n">nice_mean</span><span class="p">,</span> <span class="n">plot_helper</span><span class="o">.</span><span class="n">nice_std</span><span class="p">,</span> <span class="n">plot_helper</span><span class="o">.</span><span class="n">rounder</span><span class="p">,</span> <span class="n">plot_helper</span><span class="o">.</span><span class="n">_set_tick_labels</span><span class="p">,</span>
                      <span class="n">plot_helper</span><span class="o">.</span><span class="n">_set_tick_labels_different</span><span class="p">,</span> <span class="n">plot_helper</span><span class="o">.</span><span class="n">_nice_range_helper</span><span class="p">,</span> <span class="n">plot_helper</span><span class="o">.</span><span class="n">_nearest_pow_ten</span><span class="p">,</span>
                      <span class="n">plot_helper</span><span class="o">.</span><span class="n">_three_sigfigs</span><span class="p">,</span> <span class="n">plot_helper</span><span class="o">.</span><span class="n">_n_sigfigs</span><span class="p">,</span> <span class="n">plot_helper</span><span class="o">.</span><span class="n">_int_if_int</span><span class="p">,</span> <span class="n">plot_helper</span><span class="o">.</span><span class="n">_round_up</span><span class="p">,</span>
                      <span class="n">plot_helper</span><span class="o">.</span><span class="n">prediction_intervals</span><span class="p">]</span>
        <span class="n">func_strings</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">core_funcs</span><span class="p">)</span>

        <span class="n">plot_func_string</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">plot_func</span><span class="p">)</span>
        <span class="c1"># remove first line that has this decorator on it (!!!)</span>
        <span class="n">plot_func_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plot_func_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="c1"># put the arguments and their values in the code</span>
        <span class="n">arg_assignments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">arg_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">all_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">):</span>
                <span class="c1"># this is amazing</span>
                <span class="n">arg_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{key}</span><span class="s2"> = pd.read_csv(StringIO(&#39;&#39;&#39;</span><span class="se">\n</span><span class="s2">{var.to_csv(index=False)}&#39;&#39;&#39;))&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">Series</span><span class="p">):</span>
                <span class="n">arg_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{key}</span><span class="s2"> = pd.Series(pd.read_csv(StringIO(&#39;&#39;&#39;</span><span class="se">\n</span><span class="s2">{var.to_csv(index=False)}&#39;&#39;&#39;)).iloc[:,0])&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arg_assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="si">{key}</span><span class="s1"> = {repr(var)}&#39;</span><span class="p">)</span>
            <span class="n">arg_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">args_block</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;from numpy import array</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                      <span class="s2">&quot;from collections import OrderedDict</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                      <span class="s2">&quot;from io import StringIO</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;from sklearn.gaussian_process import GaussianProcessRegressor  # Need for error plots</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;from sklearn.gaussian_process.kernels import *  # Need for error plots</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                    <span class="s2">&quot;from sklearn.ensemble import RandomForestRegressor  # Need for error plots</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                      <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg_assignments</span><span class="p">))</span>
        <span class="n">arg_names</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg_names</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">knows_savepath</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;.png&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">basename</span><span class="p">:</span>
                <span class="n">basename</span> <span class="o">+=</span> <span class="s1">&#39;.png&#39;</span>
            <span class="n">main</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">                import pandas as pd</span>
<span class="s2">                from IPython.display import Image, display</span>

<span class="s2">                </span><span class="si">{plot_func.__name__}</span><span class="s2">(</span><span class="si">{arg_names}</span><span class="s2">)</span>
<span class="s2">                display(Image(filename=&#39;</span><span class="si">{basename}</span><span class="s2">&#39;))</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">main</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">                import pandas as pd</span>
<span class="s2">                from IPython.display import Image, display</span>

<span class="s2">                plot_paths = plot_predicted_vs_true(train_quad, test_quad, outdir, label)</span>
<span class="s2">                for plot_path in plot_paths:</span>
<span class="s2">                    display(Image(filename=plot_path))</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">)</span>

        <span class="n">nb</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_notebook</span><span class="p">()</span>
        <span class="n">readme_cell</span> <span class="o">=</span> <span class="n">nbformat</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_markdown_cell</span><span class="p">(</span><span class="n">readme</span><span class="p">)</span>
        <span class="n">text_cells</span> <span class="o">=</span> <span class="p">[</span><span class="n">header</span><span class="p">,</span> <span class="n">func_strings</span><span class="p">,</span> <span class="n">plot_func_string</span><span class="p">,</span> <span class="n">args_block</span><span class="p">,</span> <span class="n">main</span><span class="p">]</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="p">[</span><span class="n">readme_cell</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">nbformat</span><span class="o">.</span><span class="n">v4</span><span class="o">.</span><span class="n">new_code_cell</span><span class="p">(</span><span class="n">cell_text</span><span class="p">)</span> <span class="k">for</span> <span class="n">cell_text</span> <span class="ow">in</span> <span class="n">text_cells</span><span class="p">]</span>
        <span class="n">nb</span><span class="p">[</span><span class="s1">&#39;cells&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cells</span>
        <span class="n">nbformat</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">ipynb_savepath</span> <span class="o">+</span> <span class="s1">&#39;.ipynb&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">plot_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span></div>

<div class="viewcode-block" id="make_train_test_plots"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.make_train_test_plots">[docs]</a><span class="k">def</span> <span class="nf">make_train_test_plots</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">is_classification</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_X</span><span class="p">,</span> <span class="n">test_X</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    General plotting method used to execute sequence of specific plots of train-test data analysis</span>

<span class="sd">    Args:</span>

<span class="sd">        run: (dict), a particular split_result from masml_driver</span>

<span class="sd">        path: (str), path to save the generated plots and analysis of split_result designated in &#39;run&#39;</span>

<span class="sd">        is_classification: (bool), whether or not the analysis is a classification task</span>

<span class="sd">        label: (str), name of the y data variable being fit</span>

<span class="sd">        model: (scikit-learn model object), a scikit-learn model/estimator</span>

<span class="sd">        train_X: (numpy array), array of X features used in training</span>

<span class="sd">        test_X: (numpy array), array of X features used in testing</span>

<span class="sd">        groups: (numpy array), array of group names</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y_train_true</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">,</span> <span class="n">y_test_true</span> <span class="o">=</span> \
        <span class="n">run</span><span class="p">[</span><span class="s1">&#39;y_train_true&#39;</span><span class="p">],</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;y_train_pred&#39;</span><span class="p">],</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;y_test_true&#39;</span><span class="p">]</span>
    <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">train_metrics</span><span class="p">,</span> <span class="n">test_metrics</span> <span class="o">=</span> \
        <span class="n">run</span><span class="p">[</span><span class="s1">&#39;y_test_pred&#39;</span><span class="p">],</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;train_metrics&#39;</span><span class="p">],</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;test_metrics&#39;</span><span class="p">]</span>
    <span class="n">train_groups</span><span class="p">,</span> <span class="n">test_groups</span> <span class="o">=</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;train_groups&#39;</span><span class="p">],</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;test_groups&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">is_classification</span><span class="p">:</span>
        <span class="c1"># Need these class prediction probabilities for ROC curve analysis</span>
        <span class="n">y_train_pred_proba</span> <span class="o">=</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;y_train_pred_proba&#39;</span><span class="p">]</span>
        <span class="n">y_test_pred_proba</span> <span class="o">=</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;y_test_pred_proba&#39;</span><span class="p">]</span>

        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;train_confusion_matrix&#39;</span>
        <span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">y_train_true</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">,</span>
                              <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">title</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">),</span> <span class="n">train_metrics</span><span class="p">,</span>
                              <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;test_confusion_matrix&#39;</span>
        <span class="n">plot_confusion_matrix</span><span class="p">(</span><span class="n">y_test_true</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">,</span>
                              <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">title</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">),</span> <span class="n">test_metrics</span><span class="p">,</span>
                              <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;train_roc_curve&#39;</span>
        <span class="n">plot_roc_curve</span><span class="p">(</span><span class="n">y_train_true</span><span class="p">,</span> <span class="n">y_train_pred_proba</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">title</span><span class="o">+</span><span class="s1">&#39;png&#39;</span><span class="p">))</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;test_roc_curve&#39;</span>
        <span class="n">plot_roc_curve</span><span class="p">(</span><span class="n">y_test_true</span><span class="p">,</span> <span class="n">y_test_pred_proba</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">title</span><span class="o">+</span><span class="s1">&#39;png&#39;</span><span class="p">))</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;train_precision_recall_curve&#39;</span>
        <span class="n">plot_precision_recall_curve</span><span class="p">(</span><span class="n">y_train_true</span><span class="p">,</span> <span class="n">y_train_pred_proba</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">title</span><span class="o">+</span><span class="s1">&#39;png&#39;</span><span class="p">))</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;test_precision_recall_curve&#39;</span>
        <span class="n">plot_precision_recall_curve</span><span class="p">(</span><span class="n">y_test_true</span><span class="p">,</span> <span class="n">y_test_pred_proba</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">title</span> <span class="o">+</span> <span class="s1">&#39;png&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># is_regression</span>
        <span class="n">plot_predicted_vs_true</span><span class="p">((</span><span class="n">y_train_true</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">,</span> <span class="n">train_metrics</span><span class="p">,</span> <span class="n">train_groups</span><span class="p">),</span>
                          <span class="p">(</span><span class="n">y_test_true</span><span class="p">,</span>  <span class="n">y_test_pred</span><span class="p">,</span>  <span class="n">test_metrics</span><span class="p">,</span> <span class="n">test_groups</span><span class="p">),</span> 
                          <span class="n">path</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;train_residuals_histogram&#39;</span>
        <span class="n">plot_residuals_histogram</span><span class="p">(</span><span class="n">y_train_true</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">,</span>
                                 <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">title</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">),</span> <span class="n">train_metrics</span><span class="p">,</span>
                                 <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;test_residuals_histogram&#39;</span>
        <span class="n">plot_residuals_histogram</span><span class="p">(</span><span class="n">y_test_true</span><span class="p">,</span>  <span class="n">y_test_pred</span><span class="p">,</span>
                                 <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">title</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">),</span> <span class="n">test_metrics</span><span class="p">,</span>
                                 <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">make_error_plots</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">is_classification</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">train_X</span><span class="p">,</span> <span class="n">test_X</span><span class="p">,</span> <span class="n">rf_error_method</span><span class="p">,</span> <span class="n">rf_error_percentile</span><span class="p">,</span>
                     <span class="n">is_validation</span><span class="p">,</span> <span class="n">validation_column_name</span><span class="p">,</span> <span class="n">validation_X</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">y_train_true</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">,</span> <span class="n">y_test_true</span> <span class="o">=</span> \
        <span class="n">run</span><span class="p">[</span><span class="s1">&#39;y_train_true&#39;</span><span class="p">],</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;y_train_pred&#39;</span><span class="p">],</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;y_test_true&#39;</span><span class="p">]</span>
    <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">train_metrics</span><span class="p">,</span> <span class="n">test_metrics</span> <span class="o">=</span> \
        <span class="n">run</span><span class="p">[</span><span class="s1">&#39;y_test_pred&#39;</span><span class="p">],</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;train_metrics&#39;</span><span class="p">],</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;test_metrics&#39;</span><span class="p">]</span>
    <span class="n">train_groups</span><span class="p">,</span> <span class="n">test_groups</span> <span class="o">=</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;train_groups&#39;</span><span class="p">],</span> <span class="n">run</span><span class="p">[</span><span class="s1">&#39;test_groups&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">is_validation</span><span class="p">:</span>
        <span class="n">y_validation_pred</span><span class="p">,</span> <span class="n">y_validation_true</span><span class="p">,</span> <span class="n">prediction_metrics</span> <span class="o">=</span> \
            <span class="n">run</span><span class="p">[</span><span class="s1">&#39;y_validation_pred&#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">validation_column_name</span><span class="p">)],</span> \
            <span class="n">run</span><span class="p">[</span><span class="s1">&#39;y_validation_true&#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">validation_column_name</span><span class="p">)],</span> \
            <span class="n">run</span><span class="p">[</span><span class="s1">&#39;prediction_metrics&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">is_classification</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;There is no error distribution plotting for classification problems, just passing through...&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># is_regression</span>

        <span class="c1">#title = &#39;train_normalized_error&#39;</span>
        <span class="c1">#plot_normalized_error(y_train_true, y_train_pred, join(path, title+&#39;.png&#39;), model, error_method, percentile,</span>
        <span class="c1"># X=train_X, Xtrain=train_X, Xtest=test_X)</span>

        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;test_normalized_error&#39;</span>
        <span class="n">plot_normalized_error</span><span class="p">(</span><span class="n">y_test_true</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">title</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">),</span> <span class="n">model</span><span class="p">,</span> <span class="n">rf_error_method</span><span class="p">,</span>
                              <span class="n">rf_error_percentile</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">test_X</span><span class="p">,</span> <span class="n">Xtrain</span><span class="o">=</span><span class="n">train_X</span><span class="p">,</span> <span class="n">Xtest</span><span class="o">=</span><span class="n">test_X</span><span class="p">)</span>

        <span class="c1">#title = &#39;train_cumulative_normalized_error&#39;</span>
        <span class="c1">#plot_cumulative_normalized_error(y_train_true, y_train_pred, join(path, title+&#39;.png&#39;), model, error_method,</span>
        <span class="c1"># percentile, X=train_X, Xtrain=train_X, Xtest=test_X)</span>

        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;test_cumulative_normalized_error&#39;</span>
        <span class="n">plot_cumulative_normalized_error</span><span class="p">(</span><span class="n">y_test_true</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">title</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">),</span> <span class="n">model</span><span class="p">,</span> <span class="n">rf_error_method</span><span class="p">,</span>
                                         <span class="n">rf_error_percentile</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">test_X</span><span class="p">,</span> <span class="n">Xtrain</span><span class="o">=</span><span class="n">train_X</span><span class="p">,</span> <span class="n">Xtest</span><span class="o">=</span><span class="n">test_X</span><span class="p">)</span>

        <span class="c1"># HERE, add your RMS residual vs. error plot function</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RandomForestRegressor&#39;</span><span class="p">,</span> <span class="s1">&#39;ExtraTreesRegressor&#39;</span><span class="p">,</span> <span class="s1">&#39;GaussianProcessRegressor&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;GradientBoostingRegressor&#39;</span><span class="p">,</span> <span class="s1">&#39;EnsembleRegressor&#39;</span><span class="p">]:</span>
            <span class="n">y_all_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_test_true</span><span class="p">,</span> <span class="n">y_train_true</span><span class="p">])</span>
            <span class="n">plot_real_vs_predicted_error</span><span class="p">(</span><span class="n">y_all_data</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data_test_type</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_validation</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;validation_cumulative_normalized_error&#39;</span>
            <span class="n">plot_cumulative_normalized_error</span><span class="p">(</span><span class="n">y_validation_true</span><span class="p">,</span> <span class="n">y_validation_pred</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">title</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">),</span> <span class="n">model</span><span class="p">,</span> <span class="n">rf_error_method</span><span class="p">,</span>
                                             <span class="n">rf_error_percentile</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">validation_X</span><span class="p">,</span> <span class="n">Xtrain</span><span class="o">=</span><span class="n">train_X</span><span class="p">,</span> <span class="n">Xtest</span><span class="o">=</span><span class="n">test_X</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;validation_normalized_error&#39;</span>
            <span class="n">plot_normalized_error</span><span class="p">(</span><span class="n">y_validation_true</span><span class="p">,</span> <span class="n">y_validation_pred</span><span class="p">,</span> <span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">title</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">),</span> <span class="n">model</span><span class="p">,</span> <span class="n">rf_error_method</span><span class="p">,</span>
                                  <span class="n">rf_error_percentile</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">validation_X</span><span class="p">,</span> <span class="n">Xtrain</span><span class="o">=</span><span class="n">train_X</span><span class="p">,</span> <span class="n">Xtest</span><span class="o">=</span><span class="n">test_X</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RandomForestRegressor&#39;</span><span class="p">,</span> <span class="s1">&#39;ExtraTreesRegressor&#39;</span><span class="p">,</span> <span class="s1">&#39;GaussianProcessRegressor&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;GradientBoostingRegressor&#39;</span><span class="p">,</span> <span class="s1">&#39;EnsembleRegressor&#39;</span><span class="p">]:</span>
                <span class="n">y_all_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_test_true</span><span class="p">,</span> <span class="n">y_train_true</span><span class="p">])</span>
                <span class="n">plot_real_vs_predicted_error</span><span class="p">(</span><span class="n">y_all_data</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data_test_type</span><span class="o">=</span><span class="s1">&#39;validation&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="plot_confusion_matrix"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_confusion_matrix">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Confusion matrix&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method used to generate a confusion matrix for a classification run. Additional information can be found</span>
<span class="sd">    at: http://scikit-learn.org/stable/auto_examples/model_selection/plot_confusion_matrix.html</span>

<span class="sd">    Args:</span>

<span class="sd">        y_true: (numpy array), array containing the true y data values</span>

<span class="sd">        y_pred: (numpy array), array containing the predicted y data values</span>

<span class="sd">        savepath: (str), path to save the plotted confusion matrix</span>

<span class="sd">        stats: (dict), dict of training or testing statistics for a particular run</span>

<span class="sd">        normalize: (bool), whether or not to normalize data output as truncated float vs. double</span>

<span class="sd">        title: (str), title of the confusion matrix plot</span>

<span class="sd">        cmap: (matplotlib colormap), the color map to use for confusion matrix plotting</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># calculate confusion matrix and lables in correct order</span>
    <span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="c1">#classes = sorted(list(set(y_true).intersection(set(y_pred))))</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">y_pred</span><span class="p">))))</span>

    <span class="n">x_align</span> <span class="o">=</span> <span class="mf">0.64</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">)</span>

    <span class="c1">#ax.set_title(title)</span>

    <span class="c1"># create the colorbar, not really needed but everyones got &#39;em</span>
    <span class="n">mappable</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
    <span class="c1">#fig.colorbar(mappable)</span>

    <span class="c1"># set x and y ticks to labels</span>
    <span class="n">tick_marks</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">tick_marks</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">tick_marks</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">classes</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

    <span class="c1"># draw number in the boxes</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;.2f&#39;</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="s1">&#39;d&#39;</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">range</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">format</span><span class="p">(</span><span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">],</span> <span class="n">fmt</span><span class="p">),</span>
                <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span> <span class="k">if</span> <span class="n">cm</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">thresh</span> <span class="k">else</span> <span class="s2">&quot;black&quot;</span><span class="p">)</span>

    <span class="c1"># plots the stats</span>
    <span class="n">plot_stats</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="mf">0.60</span><span class="p">,</span> <span class="n">y_align</span><span class="o">=</span><span class="mf">0.90</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;True label&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Predicted label&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_roc_curve"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_roc_curve">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_roc_curve</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">savepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to calculate and plot the receiver-operator characteristic curve for classification model results</span>

<span class="sd">    Args:</span>

<span class="sd">        y_true: (numpy array), array of true y data values</span>

<span class="sd">        y_pred: (numpy array), array of predicted y data values</span>

<span class="sd">        savepath: (str), path to save the plotted ROC curve</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#TODO: have work when probability=False in model params. Suggest user set probability=True!!</span>
    <span class="c1">#classes = sorted(list(set(y_true).union(set(y_pred))))</span>
    <span class="c1">#n_classes = y_pred.shape[1]</span>

    <span class="n">classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_true</span><span class="p">))</span>

    <span class="n">fpr</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">tpr</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">roc_auc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)):</span>
        <span class="n">fpr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tpr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">roc_auc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">auc</span><span class="p">(</span><span class="n">fpr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tpr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">x_align</span> <span class="o">=</span> <span class="mf">0.95</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">aspect_ratio</span><span class="o">=</span><span class="mf">0.66</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">]</span>
    <span class="c1">#for i in range(len(classes)):</span>
    <span class="c1">#    ax.plot(fpr[i], tpr[i], color=colors[i], lw=2, label=&#39;ROC curve class &#39;+str(i)+&#39; (area = %0.2f)&#39; % roc_auc[i])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tpr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ROC curve&#39;</span> <span class="o">+</span> <span class="s1">&#39; (area = </span><span class="si">%0.2f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">roc_auc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Random guess&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">_set_tick_labels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">maxx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">minn</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;False Positive Rate&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;16&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;True Positive Rate&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;16&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="c1">#plot_stats(fig, stats, x_align=0.60, y_align=0.90)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_to_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_precision_recall_curve"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_precision_recall_curve">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_precision_recall_curve</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">savepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to calculate and plot the precision-recall curve for classification model results</span>

<span class="sd">    Args:</span>

<span class="sd">        y_true: (numpy array), array of true y data values</span>

<span class="sd">        y_pred: (numpy array), array of predicted y data values</span>

<span class="sd">        savepath: (str), path to save the plotted precision-recall curve</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Note this only works with probability predictions of the classifier labels.</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y_true</span><span class="p">))</span>

    <span class="n">precision</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">recall</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c1">#roc_auc = dict()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)):</span>
        <span class="n">precision</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">recall</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_</span> <span class="o">=</span> <span class="n">precision_recall_curve</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>

    <span class="n">x_align</span> <span class="o">=</span> <span class="mf">0.95</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">aspect_ratio</span><span class="o">=</span><span class="mf">0.66</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">]</span>
    <span class="c1">#for i in range(len(classes)):</span>
    <span class="c1">#    ax.plot(fpr[i], tpr[i], color=colors[i], lw=2, label=&#39;ROC curve class &#39;+str(i)+&#39; (area = %0.2f)&#39; % roc_auc[i])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">recall</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">precision</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Precision-recall curve&#39;</span><span class="p">)</span>
    <span class="c1">#ax.fill_between(recall[1], precision[1], alpha=0.4, color=colors[0])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">_set_tick_labels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">maxx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">minn</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;16&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;16&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="c1">#plot_stats(fig, stats, x_align=0.60, y_align=0.90)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_to_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">return</span></div>

<div class="viewcode-block" id="plot_residuals_histogram"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_residuals_histogram">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_residuals_histogram</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span>
                             <span class="n">stats</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;residuals histogram&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;residuals&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to calculate and plot the histogram of residuals from regression model</span>

<span class="sd">    Args:</span>

<span class="sd">        y_true: (numpy array), array of true y data values</span>

<span class="sd">        y_pred: (numpy array), array of predicted y data values</span>

<span class="sd">        savepath: (str), path to save the plotted precision-recall curve</span>

<span class="sd">        stats: (dict), dict of training or testing statistics for a particular run</span>

<span class="sd">        title: (str), title of residuals histogram</span>

<span class="sd">        label: (str), label used for axis labeling</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># make fig and ax, use x_align when placing text so things don&#39;t overlap</span>
    <span class="n">x_align</span> <span class="o">=</span> <span class="mf">0.64</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">)</span>

    <span class="c1">#ax.set_title(title)</span>
    <span class="c1"># do the actual plotting</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span>

    <span class="c1">#Output residuals data and stats to spreadsheet</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">savepath</span><span class="p">)</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s1">&#39;residual_statistics.csv&#39;</span><span class="p">))</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="s1">&#39;residuals.csv&#39;</span><span class="p">)</span>

    <span class="c1">#Get num_bins using smarter method</span>
    <span class="n">num_bins</span> <span class="o">=</span> <span class="n">get_histogram_bins</span><span class="p">(</span><span class="n">y_df</span><span class="o">=</span><span class="n">residuals</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="c1"># normal text stuff</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Value of &#39;</span><span class="o">+</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of occurences&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="c1"># make y axis ints, because it is discrete</span>
    <span class="c1">#ax.yaxis.set_major_locator(MaxNLocator(integer=True))</span>

    <span class="n">plot_stats</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">,</span> <span class="n">y_align</span><span class="o">=</span><span class="mf">0.90</span><span class="p">)</span>
    <span class="n">plot_stats</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">,</span> <span class="n">y_align</span><span class="o">=</span><span class="mf">0.60</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_target_histogram"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_target_histogram">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_target_histogram</span><span class="p">(</span><span class="n">y_df</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;target histogram&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target values&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to plot the histogram of true y values</span>

<span class="sd">    Args:</span>

<span class="sd">        y_df: (pandas dataframe), dataframe of true y data values</span>

<span class="sd">        savepath: (str), path to save the plotted precision-recall curve</span>

<span class="sd">        title: (str), title of residuals histogram</span>

<span class="sd">        label: (str), label used for axis labeling</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># make fig and ax, use x_align when placing text so things don&#39;t overlap</span>
    <span class="n">x_align</span> <span class="o">=</span> <span class="mf">0.70</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">aspect_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">)</span>

    <span class="c1">#ax.set_title(title)</span>

    <span class="c1">#Get num_bins using smarter method</span>
    <span class="n">num_bins</span> <span class="o">=</span> <span class="n">get_histogram_bins</span><span class="p">(</span><span class="n">y_df</span><span class="o">=</span><span class="n">y_df</span><span class="p">)</span>

    <span class="c1"># do the actual plotting</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y_df</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span><span class="c1">#, histtype=&#39;stepfilled&#39;)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not plot target histgram&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1"># normal text stuff</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Value of &#39;</span><span class="o">+</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of occurences&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="c1"># make y axis ints, because it is discrete</span>
    <span class="c1">#ax.yaxis.set_major_locator(MaxNLocator(integer=True))</span>


    <span class="n">plot_stats</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">y_df</span><span class="o">.</span><span class="n">describe</span><span class="p">()),</span> <span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">,</span> <span class="n">y_align</span><span class="o">=</span><span class="mf">0.90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="c1"># Save input data stats to csv</span>
    <span class="n">savepath_parse</span> <span class="o">=</span> <span class="n">savepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;target_histogram.png&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y_df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath_parse</span><span class="o">+</span><span class="s1">&#39;/&#39;&#39;input_data_statistics.csv&#39;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_predicted_vs_true"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_predicted_vs_true">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_predicted_vs_true</span><span class="p">(</span><span class="n">train_quad</span><span class="p">,</span> <span class="n">test_quad</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to create a parity plot (predicted vs. true values)</span>

<span class="sd">    Args:</span>

<span class="sd">        train_quad: (tuple), tuple containing 4 numpy arrays: true training y data, predicted training y data,</span>

<span class="sd">        training metric data, and groups used in training</span>

<span class="sd">        test_quad: (tuple), tuple containing 4 numpy arrays: true test y data, predicted test y data,</span>

<span class="sd">        testing metric data, and groups used in testing</span>

<span class="sd">        outdir: (str), path to save plots to</span>

<span class="sd">        label: (str), label used for axis labeling</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">y_train_true</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">,</span> <span class="n">train_metrics</span><span class="p">,</span> <span class="n">train_groups</span> <span class="o">=</span> <span class="n">train_quad</span>
    <span class="n">y_test_true</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">,</span> <span class="n">test_metrics</span><span class="p">,</span> <span class="n">test_groups</span> <span class="o">=</span> <span class="n">test_quad</span>

    <span class="c1"># make diagonal line from absolute min to absolute max of any data point</span>
    <span class="c1"># using round because Ryan did - but won&#39;t that ruin small numbers??? TODO this</span>
    <span class="c1">#max1 = max(y_train_true.max(), y_train_pred.max(),</span>
    <span class="c1">#           y_test_true.max(), y_test_pred.max())</span>
    <span class="n">max1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_train_true</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y_test_true</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="c1">#min1 = min(y_train_true.min(), y_train_pred.min(),</span>
    <span class="c1">#           y_test_true.min(), y_test_pred.min())</span>
    <span class="n">min1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_train_true</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_test_true</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">max1</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">max1</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">max1</span><span class="o">-</span><span class="n">min1</span><span class="p">))</span>
    <span class="n">min1</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">min1</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">max1</span><span class="o">-</span><span class="n">min1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">title_addon</span> <span class="ow">in</span> \
            <span class="p">(</span><span class="n">train_quad</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,),</span> <span class="n">test_quad</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,)):</span>
        <span class="c1"># make fig and ax, use x_align when placing text so things don&#39;t overlap</span>
        <span class="n">x_align</span><span class="o">=</span><span class="mf">0.64</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">)</span>

        <span class="c1"># set tick labels</span>
        <span class="c1"># notice that we use the same max and min for all three. Don&#39;t</span>
        <span class="c1"># calculate those inside the loop, because all the should be on the same scale and axis</span>
        <span class="n">_set_tick_labels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">max1</span><span class="p">,</span> <span class="n">min1</span><span class="p">)</span>

        <span class="c1"># plot diagonal line</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">min1</span><span class="p">,</span> <span class="n">max1</span><span class="p">],</span> <span class="p">[</span><span class="n">min1</span><span class="p">,</span> <span class="n">max1</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># do the actual plotting</span>
        <span class="k">if</span> <span class="n">groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">handles</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">unique_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">train_groups</span><span class="p">,</span> <span class="n">test_groups</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">unique_groups_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">train_groups</span><span class="p">)</span>
            <span class="n">unique_groups_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">test_groups</span><span class="p">)</span>
            <span class="c1">#logger.debug(&#39; &#39;*12 + &#39;unique groups: &#39; +str(list(unique_groups)))</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">]</span>
            <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">]</span>
            <span class="n">colorcount</span> <span class="o">=</span> <span class="n">markercount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">groupcount</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_groups</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">groups</span> <span class="o">==</span> <span class="n">group</span>
                <span class="c1">#logger.debug(&#39; &#39;*12 + f&#39;{group} group_percent = {np.count_nonzero(mask) / len(groups)}&#39;)</span>
                <span class="n">handles</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">colorcount</span><span class="p">],</span>
                                            <span class="n">marker</span><span class="o">=</span><span class="n">markers</span><span class="p">[</span><span class="n">markercount</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
                <span class="n">colorcount</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">colorcount</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">markercount</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">colorcount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">title_addon</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
                <span class="n">to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">handles</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_groups_train</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">to_delete</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">handles</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">title_addon</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span>
                <span class="n">to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">handles</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_groups_test</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">to_delete</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">handles</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">handles</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

        <span class="c1"># set axis labels</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;True &#39;</span><span class="o">+</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted &#39;</span><span class="o">+</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="n">plot_stats</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">,</span> <span class="n">y_align</span><span class="o">=</span><span class="mf">0.90</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;predicted_vs_true_&#39;</span><span class="o">+</span> <span class="n">title_addon</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
        <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;y_pred&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s1">&#39;y_true&#39;</span><span class="p">:</span> <span class="n">y_true</span><span class="p">})</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s1">&#39;predicted_vs_true_&#39;</span> <span class="o">+</span> <span class="n">title_addon</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">filenames</span></div>

<div class="viewcode-block" id="plot_scatter"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_scatter">[docs]</a><span class="k">def</span> <span class="nf">plot_scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target data&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to create a general scatter plot</span>

<span class="sd">    Args:</span>

<span class="sd">        x: (numpy array), array of x data</span>

<span class="sd">        y: (numpy array), array of y data</span>

<span class="sd">        savepath: (str), path to save plots to</span>

<span class="sd">        groups: (list), list of group labels</span>

<span class="sd">        xlabel: (str), label used for x-axis labeling</span>

<span class="sd">        label: (str), label used for y-axis labeling</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Set image aspect ratio:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">()</span>

    <span class="c1"># set tick labels</span>
    <span class="n">max_tick_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">min_tick_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">max_tick_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">min_tick_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">max_tick_x</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">max_tick_x</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">max_tick_x</span><span class="o">-</span><span class="n">min_tick_x</span><span class="p">))</span>
    <span class="n">min_tick_x</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">min_tick_x</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">max_tick_x</span><span class="o">-</span><span class="n">min_tick_x</span><span class="p">))</span>
    <span class="n">max_tick_y</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">max_tick_y</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">max_tick_y</span><span class="o">-</span><span class="n">min_tick_y</span><span class="p">))</span>
    <span class="n">min_tick_y</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">min_tick_y</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">max_tick_y</span><span class="o">-</span><span class="n">min_tick_y</span><span class="p">))</span>
    <span class="c1">#divisor_y = get_divisor(max(y), min(y))</span>
    <span class="c1">#max_tick_y = round_up(max(y), divisor_y)</span>
    <span class="c1">#min_tick_y = round_down(min(y), divisor_y)</span>

    <span class="n">_set_tick_labels_different</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">max_tick_x</span><span class="p">,</span> <span class="n">min_tick_x</span><span class="p">,</span> <span class="n">max_tick_y</span><span class="p">,</span> <span class="n">min_tick_y</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">]</span>
        <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">]</span>
        <span class="n">colorcount</span> <span class="o">=</span> <span class="n">markercount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">groupcount</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">groups</span><span class="p">)):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">groups</span> <span class="o">==</span> <span class="n">group</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">colorcount</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">markers</span><span class="p">[</span><span class="n">markercount</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">colorcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">colorcount</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">markercount</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">colorcount</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Value of &#39;</span><span class="o">+</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="c1">#ax.set_xticklabels(rotation=45)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">plot_keras_history</span><span class="p">(</span><span class="n">model_history</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">):</span>
    <span class="c1"># Set image aspect ratio:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">()</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">model_history</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;loss&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">and</span> <span class="s1">&#39;val&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">k</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">model_history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)]</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">model_history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;loss&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;training &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; (Accuracy)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">validation_accuracy</span> <span class="o">=</span> <span class="n">model_history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">validation_accuracy</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;validation &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;loss&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;training loss&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; (Loss)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">validation_loss</span> <span class="o">=</span> <span class="n">model_history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">validation_loss</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;validation loss&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="c1">#_set_tick_labels_different(ax, max_tick_x, min_tick_x, max_tick_y, min_tick_y)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epochs&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">return</span>

<div class="viewcode-block" id="plot_best_worst_split"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_best_worst_split">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_best_worst_split</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">best_run</span><span class="p">,</span> <span class="n">worst_run</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span>
                          <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Best Worst Overlay&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target_value&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to create a parity plot (predicted vs. true values) of just the best scoring and worst scoring CV splits</span>

<span class="sd">    Args:</span>

<span class="sd">        y_true: (numpy array), array of true y data</span>

<span class="sd">        best_run: (dict), the best scoring split_result from mastml_driver</span>

<span class="sd">        worst_run: (dict), the worst scoring split_result from mastml_driver</span>

<span class="sd">        savepath: (str), path to save plots to</span>

<span class="sd">        title: (str), title of the best_worst_split plot</span>

<span class="sd">        label: (str), label used for axis labeling</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># make fig and ax, use x_align when placing text so things don&#39;t overlap</span>
    <span class="n">x_align</span> <span class="o">=</span> <span class="mf">0.64</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">)</span>

    <span class="n">maxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span> <span class="c1"># TODO is round the right thing here?</span>
    <span class="n">minn</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
    <span class="n">maxx</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">maxx</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minn</span><span class="p">))</span>
    <span class="n">minn</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">minn</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minn</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">minn</span><span class="p">,</span> <span class="n">maxx</span><span class="p">],</span> <span class="p">[</span><span class="n">minn</span><span class="p">,</span> <span class="n">maxx</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># set tick labels</span>
    <span class="n">_set_tick_labels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">minn</span><span class="p">)</span>

    <span class="c1"># do the actual plotting</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">best_run</span><span class="p">[</span><span class="s1">&#39;y_test_true&#39;</span><span class="p">],</span>  <span class="n">best_run</span><span class="p">[</span><span class="s1">&#39;y_test_pred&#39;</span><span class="p">],</span>  <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
               <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;best test&#39;</span><span class="p">,</span>  <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span>  <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">worst_run</span><span class="p">[</span><span class="s1">&#39;y_test_true&#39;</span><span class="p">],</span> <span class="n">worst_run</span><span class="p">[</span><span class="s1">&#39;y_test_pred&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
               <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;worst test&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="c1"># set axis labels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;True &#39;</span><span class="o">+</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted &#39;</span><span class="o">+</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="c1">#font_dict = {&#39;size&#39;   : 10, &#39;family&#39; : &#39;sans-serif&#39;}</span>

    <span class="c1"># Duplicate the stats dicts with an additional label</span>
    <span class="n">best_stats</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;Best Run&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span>
    <span class="n">best_stats</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">best_run</span><span class="p">[</span><span class="s1">&#39;test_metrics&#39;</span><span class="p">])</span>
    <span class="n">worst_stats</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;worst Run&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span>
    <span class="n">worst_stats</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">worst_run</span><span class="p">[</span><span class="s1">&#39;test_metrics&#39;</span><span class="p">])</span>

    <span class="n">plot_stats</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">best_stats</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">,</span> <span class="n">y_align</span><span class="o">=</span><span class="mf">0.90</span><span class="p">)</span>
    <span class="n">plot_stats</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">worst_stats</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">,</span> <span class="n">y_align</span><span class="o">=</span><span class="mf">0.60</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

    <span class="n">df_best</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;best run pred&#39;</span><span class="p">:</span> <span class="n">best_run</span><span class="p">[</span><span class="s1">&#39;y_test_pred&#39;</span><span class="p">],</span> <span class="s1">&#39;best run true&#39;</span><span class="p">:</span> <span class="n">best_run</span><span class="p">[</span><span class="s1">&#39;y_test_true&#39;</span><span class="p">]})</span>
    <span class="n">df_worst</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;worst run pred&#39;</span><span class="p">:</span> <span class="n">worst_run</span><span class="p">[</span><span class="s1">&#39;y_test_pred&#39;</span><span class="p">],</span> <span class="s1">&#39;worst run true&#39;</span><span class="p">:</span> <span class="n">worst_run</span><span class="p">[</span><span class="s1">&#39;y_test_true&#39;</span><span class="p">]})</span>

    <span class="n">df_best</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath</span> <span class="o">+</span> <span class="s1">&#39;_best.csv&#39;</span><span class="p">)</span>
    <span class="n">df_worst</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath</span> <span class="o">+</span> <span class="s1">&#39;_worst.csv&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_best_worst_per_point"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_best_worst_per_point">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_best_worst_per_point</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred_list</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">metrics_dict</span><span class="p">,</span>
                              <span class="n">avg_stats</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;best worst per point&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target_value&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to create a parity plot (predicted vs. true values) of the set of best and worst CV scores for each</span>

<span class="sd">    individual data point.</span>

<span class="sd">    Args:</span>

<span class="sd">        y_true: (numpy array), array of true y data</span>

<span class="sd">        y_pred_list: (list), list of numpy arrays containing predicted y data for each CV split</span>

<span class="sd">        savepath: (str), path to save plots to</span>

<span class="sd">        metrics_dict: (dict), dict of scikit-learn metric objects to calculate score of predicted vs. true values</span>

<span class="sd">        avg_stats: (dict), dict of calculated average metrics over all CV splits</span>

<span class="sd">        title: (str), title of the best_worst_per_point plot</span>

<span class="sd">        label: (str), label used for axis labeling</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">worsts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">bests</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_y_true</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">yt</span><span class="p">,</span> <span class="n">y_pred</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="ow">in</span> <span class="n">y_pred_list</span> <span class="ow">or</span> <span class="n">yt</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">worsts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">yp</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yp</span><span class="o">-</span><span class="n">yt</span><span class="p">)))</span>
        <span class="n">bests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">yp</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">yp</span><span class="o">-</span><span class="n">yt</span><span class="p">)))</span>
        <span class="n">new_y_true</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yt</span><span class="p">)</span>

    <span class="n">worst_stats</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;Worst combined:&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span>
    <span class="n">best_stats</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;Best combined:&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="ow">in</span> <span class="n">metrics_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">worst_stats</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">new_y_true</span><span class="p">,</span> <span class="n">worsts</span><span class="p">)</span>
        <span class="n">best_stats</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">new_y_true</span><span class="p">,</span> <span class="n">bests</span><span class="p">)</span>

    <span class="c1"># make fig and ax, use x_align when placing text so things don&#39;t overlap</span>
    <span class="n">x_align</span> <span class="o">=</span> <span class="mf">15.5</span><span class="o">/</span><span class="mi">24</span> <span class="c1">#mmm yum</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">)</span>

    <span class="c1"># gather max and min</span>
    <span class="c1">#all_vals = [val for val in worsts+bests if val is not None]</span>
    <span class="n">max1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
    <span class="n">min1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>

    <span class="c1"># draw dashed horizontal line</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">min1</span><span class="p">,</span> <span class="n">max1</span><span class="p">],</span> <span class="p">[</span><span class="n">min1</span><span class="p">,</span> <span class="n">max1</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># set axis labels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;True &#39;</span><span class="o">+</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted &#39;</span><span class="o">+</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="c1"># set tick labels</span>
    <span class="c1">#maxx = max((max(bests), max(worsts), max(new_y_true)))</span>
    <span class="c1">#minn = min((min(bests), min(worsts), min(new_y_true)))</span>
    <span class="c1">#maxx, minn = recursive_max_and_min([bests, worsts, new_y_true])</span>
    <span class="n">maxx</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">max1</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">max1</span><span class="o">-</span><span class="n">min1</span><span class="p">))</span>
    <span class="n">minn</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">min1</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">max1</span><span class="o">-</span><span class="n">min1</span><span class="p">))</span>
    <span class="n">_set_tick_labels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">minn</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">new_y_true</span><span class="p">,</span> <span class="n">bests</span><span class="p">,</span>  <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>  <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;best test&#39;</span><span class="p">,</span>
               <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span>  <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">new_y_true</span><span class="p">,</span> <span class="n">worsts</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;worst test&#39;</span><span class="p">,</span>
               <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="n">plot_stats</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">avg_stats</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">,</span> <span class="n">y_align</span><span class="o">=</span><span class="mf">0.51</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plot_stats</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">worst_stats</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">,</span> <span class="n">y_align</span><span class="o">=</span><span class="mf">0.73</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">plot_stats</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">best_stats</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">,</span> <span class="n">y_align</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;y true&#39;</span><span class="p">:</span> <span class="n">new_y_true</span><span class="p">,</span>
                       <span class="s1">&#39;best per point&#39;</span><span class="p">:</span> <span class="n">bests</span><span class="p">,</span>
                       <span class="s1">&#39;worst per point&#39;</span><span class="p">:</span> <span class="n">worsts</span><span class="p">})</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_predicted_vs_true_bars"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_predicted_vs_true_bars">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_predicted_vs_true_bars</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred_list</span><span class="p">,</span> <span class="n">avg_stats</span><span class="p">,</span>
                                <span class="n">savepath</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;best worst with bars&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;target_value&#39;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to calculate parity plot (predicted vs. true) of average predictions, averaged over all CV splits, with error</span>

<span class="sd">    bars on each point corresponding to the standard deviation of the predicted values over all CV splits.</span>

<span class="sd">    Args:</span>

<span class="sd">        y_true: (numpy array), array of true y data</span>

<span class="sd">        y_pred_list: (list), list of numpy arrays containing predicted y data for each CV split</span>

<span class="sd">        avg_stats: (dict), dict of calculated average metrics over all CV splits</span>

<span class="sd">        savepath: (str), path to save plots to</span>

<span class="sd">        title: (str), title of the best_worst_per_point plot</span>

<span class="sd">        label: (str), label used for axis labeling</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="n">nice_mean</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span> <span class="k">for</span> <span class="n">y_pred</span> <span class="ow">in</span> <span class="n">y_pred_list</span><span class="p">]</span>
    <span class="n">standard_error_means</span> <span class="o">=</span> <span class="p">[</span><span class="n">nice_std</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_pred</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">y_pred</span> <span class="ow">in</span> <span class="n">y_pred_list</span><span class="p">]</span>
    <span class="n">standard_errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">nice_std</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span> <span class="k">for</span> <span class="n">y_pred</span> <span class="ow">in</span> <span class="n">y_pred_list</span><span class="p">]</span>
    <span class="c1"># make fig and ax, use x_align when placing text so things don&#39;t overlap</span>
    <span class="n">x_align</span> <span class="o">=</span> <span class="mf">0.64</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">)</span>

    <span class="c1"># gather max and min</span>
    <span class="n">max1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">y_true</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">means</span><span class="p">))</span>
    <span class="n">min1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">y_true</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">means</span><span class="p">))</span>

    <span class="c1"># draw dashed horizontal line</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">min1</span><span class="p">,</span> <span class="n">max1</span><span class="p">],</span> <span class="p">[</span><span class="n">min1</span><span class="p">,</span> <span class="n">max1</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># set axis labels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;True &#39;</span><span class="o">+</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted &#39;</span><span class="o">+</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

    <span class="c1"># set tick labels</span>
    <span class="c1">#maxx, minn = recursive_max_and_min([means, y_true])</span>
    <span class="n">maxx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
    <span class="n">minn</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
    <span class="n">maxx</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">maxx</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minn</span><span class="p">))</span>
    <span class="n">minn</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">minn</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">maxx</span><span class="o">-</span><span class="n">minn</span><span class="p">))</span>
    <span class="c1">#print(maxx, minn, rounder(maxx - minn))</span>
    <span class="n">_set_tick_labels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">minn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">groups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">standard_errors</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;black&#39;</span><span class="p">]</span>
        <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">]</span>
        <span class="n">colorcount</span> <span class="o">=</span> <span class="n">markercount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">handles</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">unique_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">groupcount</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_groups</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">groups</span> <span class="o">==</span> <span class="n">group</span>
            <span class="c1"># logger.debug(&#39; &#39;*12 + f&#39;{group} group_percent = {np.count_nonzero(mask) / len(groups)}&#39;)</span>
            <span class="n">handles</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">y_true</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">)[</span><span class="n">mask</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">standard_errors</span><span class="p">)[</span><span class="n">mask</span><span class="p">],</span>
                                         <span class="n">marker</span><span class="o">=</span><span class="n">markers</span><span class="p">[</span><span class="n">markercount</span><span class="p">],</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">colorcount</span><span class="p">],</span>
                                         <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">colorcount</span><span class="p">],</span> <span class="n">ecolor</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">colorcount</span><span class="p">],</span>
                                         <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
            <span class="n">colorcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">colorcount</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">markercount</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">colorcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">handles</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">plot_stats</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">avg_stats</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">,</span> <span class="n">y_align</span><span class="o">=</span><span class="mf">0.90</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;y true&#39;</span><span class="p">:</span> <span class="n">y_true</span><span class="p">,</span>
                       <span class="s1">&#39;average predicted values&#39;</span><span class="p">:</span> <span class="n">means</span><span class="p">,</span>
                       <span class="s1">&#39;error bar values&#39;</span><span class="p">:</span> <span class="n">standard_errors</span><span class="p">})</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_metric_vs_group"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_metric_vs_group">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_metric_vs_group</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">avg_stats</span><span class="p">,</span> <span class="n">savepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to plot the value of a particular calculated metric (e.g. RMSE, R^2, etc) for each data group</span>

<span class="sd">    Args:</span>

<span class="sd">        metric: (str), name of a calculation metric</span>

<span class="sd">        groups: (numpy array), array of group names</span>

<span class="sd">        stats: (dict), dict of training or testing statistics for a particular run</span>

<span class="sd">        avg_stats: (dict), dict of calculated average metrics over all CV splits</span>

<span class="sd">        savepath: (str), path to save plots to</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># make fig and ax, use x_align when placing text so things don&#39;t overlap</span>
    <span class="n">x_align</span> <span class="o">=</span> <span class="mf">0.64</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">)</span>

    <span class="c1"># do the actual plotting</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span>  <span class="n">stats</span><span class="p">,</span>  <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span>  <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="c1"># set axis labels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plot_stats</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">avg_stats</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">,</span> <span class="n">y_align</span><span class="o">=</span><span class="mf">0.90</span><span class="p">)</span>

    <span class="c1"># Save data stats to csv</span>
    <span class="n">savepath_parse</span> <span class="o">=</span> <span class="n">savepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_vs_group.png&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath_parse</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_vs_group.csv&#39;</span><span class="p">))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">return</span></div>

<div class="viewcode-block" id="plot_metric_vs_group_size"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_metric_vs_group_size">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_metric_vs_group_size</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">avg_stats</span><span class="p">,</span> <span class="n">savepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to plot the value of a particular calculated metric (e.g. RMSE, R^2, etc) as a function of the size of each group.</span>

<span class="sd">    Args:</span>

<span class="sd">        metric: (str), name of a calculation metric</span>

<span class="sd">        groups: (numpy array), array of group names</span>

<span class="sd">        stats: (dict), dict of training or testing statistics for a particular run</span>

<span class="sd">        avg_stats: (dict), dict of calculated average metrics over all CV splits</span>

<span class="sd">        savepath: (str), path to save plots to</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># make fig and ax, use x_align when placing text so things don&#39;t overlap</span>
    <span class="n">x_align</span> <span class="o">=</span> <span class="mf">0.64</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">)</span>

    <span class="c1"># Get unique groups from full group array</span>
    <span class="n">unique_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>

    <span class="c1"># Get the size of each group</span>
    <span class="n">group_lengths</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">unique_groups</span><span class="p">:</span>
        <span class="n">group_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">groups</span><span class="o">==</span><span class="n">group</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>

    <span class="c1"># do the actual plotting</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">group_lengths</span><span class="p">,</span>  <span class="n">stats</span><span class="p">,</span>  <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span>  <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="c1"># set axis labels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Group size&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="c1">#ax.set_xticklabels(labels=group_lengths, fontsize=14)</span>
    <span class="n">plot_stats</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">avg_stats</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">,</span> <span class="n">y_align</span><span class="o">=</span><span class="mf">0.90</span><span class="p">)</span>

    <span class="c1"># Save data stats to csv</span>
    <span class="n">savepath_parse</span> <span class="o">=</span> <span class="n">savepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_vs_group_size.png&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">group_lengths</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath_parse</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_vs_group_size.csv&#39;</span><span class="p">))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">return</span></div>

<span class="c1"># Credit to: http://contrib.scikit-learn.org/forest-confidence-interval/_modules/forestci/forestci.html</span>
<div class="viewcode-block" id="calc_inbag_modified"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.calc_inbag_modified">[docs]</a><span class="k">def</span> <span class="nf">calc_inbag_modified</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">forest</span><span class="p">,</span> <span class="n">is_ensemble</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Derive samples used to create trees in scikit-learn RandomForest objects.</span>

<span class="sd">    Recovers the samples in each tree from the random state of that tree using</span>
<span class="sd">    :func:`forest._generate_sample_indices`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n_samples : int</span>
<span class="sd">        The number of samples used to fit the scikit-learn RandomForest object.</span>

<span class="sd">    forest : RandomForest</span>
<span class="sd">        Regressor or Classifier object that is already fit by scikit-learn.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Array that records how many times a data point was placed in a tree.</span>
<span class="sd">    Columns are individual trees. Rows are the number of times a sample was</span>
<span class="sd">    used in a tree.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">forest</span><span class="o">.</span><span class="n">bootstrap</span><span class="p">:</span>
        <span class="n">e_s</span> <span class="o">=</span> <span class="s2">&quot;Cannot calculate the inbag from a forest that has &quot;</span>
        <span class="n">e_s</span> <span class="o">=</span> <span class="s2">&quot; bootstrap=False&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">e_s</span><span class="p">)</span>

    <span class="n">n_trees</span> <span class="o">=</span> <span class="n">forest</span><span class="o">.</span><span class="n">n_estimators</span>
    <span class="n">inbag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_trees</span><span class="p">))</span>
    <span class="n">sample_idx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_samples_bootstrap</span> <span class="o">=</span> <span class="n">_get_n_samples_bootstrap</span><span class="p">(</span>
        <span class="c1">#n_samples, forest.max_samples</span>
        <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_samples</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">t_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trees</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ensemble</span><span class="p">:</span>
            <span class="n">sample_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">_generate_sample_indices</span><span class="p">(</span><span class="n">forest</span><span class="o">.</span><span class="n">estimators_</span><span class="p">[</span><span class="n">t_idx</span><span class="p">]</span><span class="o">.</span><span class="n">random_state</span><span class="p">,</span>
                                         <span class="n">n_samples</span><span class="p">,</span> <span class="n">n_samples_bootstrap</span><span class="p">))</span>
            <span class="n">inbag</span><span class="p">[:,</span> <span class="n">t_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">sample_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#rand_state = 0</span>
            <span class="c1">#try:</span>
            <span class="c1">#    rand_state = forest.model[t_idx].random_state</span>
            <span class="c1">#except:</span>
            <span class="c1">#    pass</span>
            <span class="c1">#sample_idx.append(</span>
            <span class="c1">#    _generate_sample_indices(rand_state,</span>
            <span class="c1">#                             n_samples, n_samples_bootstrap))</span>
            <span class="n">sample_idx</span> <span class="o">=</span> <span class="n">forest</span><span class="o">.</span><span class="n">bootstrapped_idxs</span><span class="p">[</span><span class="n">t_idx</span><span class="p">]</span>
            <span class="n">inbag</span><span class="p">[:,</span> <span class="n">t_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">sample_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">minlength</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inbag</span></div>

<span class="c1"># Credit to: http://contrib.scikit-learn.org/forest-confidence-interval/_modules/forestci/forestci.html</span>
<div class="viewcode-block" id="random_forest_error_modified"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.random_forest_error_modified">[docs]</a><span class="k">def</span> <span class="nf">random_forest_error_modified</span><span class="p">(</span><span class="n">forest</span><span class="p">,</span> <span class="n">is_ensemble</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">basic_IJ</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">inbag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">calibrate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">memory_constrained</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">memory_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate error bars from scikit-learn RandomForest estimators.</span>

<span class="sd">    RandomForest is a regressor or classifier object</span>
<span class="sd">    this variance can be used to plot error bars for RandomForest objects</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    forest : RandomForest</span>
<span class="sd">        Regressor or Classifier object.</span>

<span class="sd">    X_train : ndarray</span>
<span class="sd">        An array with shape (n_train_sample, n_features). The design matrix for</span>
<span class="sd">        training data.</span>

<span class="sd">    X_test : ndarray</span>
<span class="sd">        An array with shape (n_test_sample, n_features). The design matrix</span>
<span class="sd">        for testing data</span>
<span class="sd">        </span>
<span class="sd">    basic_IJ : boolean, optional</span>
<span class="sd">        Return the value of basic infinitesimal jackknife or Monte Carlo </span>
<span class="sd">        corrected infinitesimal jackknife.</span>

<span class="sd">    inbag : ndarray, optional</span>
<span class="sd">        The inbag matrix that fit the data. If set to `None` (default) it</span>
<span class="sd">        will be inferred from the forest. However, this only works for trees</span>
<span class="sd">        for which bootstrapping was set to `True`. That is, if sampling was</span>
<span class="sd">        done with replacement. Otherwise, users need to provide their own</span>
<span class="sd">        inbag matrix.</span>

<span class="sd">    calibrate: boolean, optional</span>
<span class="sd">        Whether to apply calibration to mitigate Monte Carlo noise.</span>
<span class="sd">        Some variance estimates may be negative due to Monte Carlo effects if</span>
<span class="sd">        the number of trees in the forest is too small. To use calibration,</span>
<span class="sd">        Default: True</span>

<span class="sd">    memory_constrained: boolean, optional</span>
<span class="sd">        Whether or not there is a restriction on memory. If False, it is</span>
<span class="sd">        assumed that a ndarry of shape (n_train_sample,n_test_sample) fits</span>
<span class="sd">        in main memory. Setting to True can actually provide a speed up if</span>
<span class="sd">        memory_limit is tuned to the optimal range.</span>

<span class="sd">    memory_limit: int, optional.</span>
<span class="sd">        An upper bound for how much memory the itermediate matrices will take</span>
<span class="sd">        up in Megabytes. This must be provided if memory_constrained=True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    An array with the unbiased sampling variance (V_IJ_unbiased)</span>
<span class="sd">    for a RandomForest object.</span>

<span class="sd">    See Also</span>
<span class="sd">    ----------</span>
<span class="sd">    :func:`calc_inbag`</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The calculation of error is based on the infinitesimal jackknife variance,</span>
<span class="sd">    as described in [Wager2014]_ and is a Python implementation of the R code</span>
<span class="sd">    provided at: https://github.com/swager/randomForestCI</span>

<span class="sd">    .. [Wager2014] S. Wager, T. Hastie, B. Efron. &quot;Confidence Intervals for</span>
<span class="sd">       Random Forests: The Jackknife and the Infinitesimal Jackknife&quot;, Journal</span>
<span class="sd">       of Machine Learning Research vol. 15, pp. 1625-1651, 2014.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">inbag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">inbag</span> <span class="o">=</span> <span class="n">calc_inbag_modified</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">forest</span><span class="p">,</span> <span class="n">is_ensemble</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ensemble</span><span class="p">:</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">forest</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">forest</span><span class="o">.</span><span class="n">model</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pred_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">pred_centered</span> <span class="o">=</span> <span class="n">pred</span> <span class="o">-</span> <span class="n">pred_mean</span>
    <span class="n">n_trees</span> <span class="o">=</span> <span class="n">forest</span><span class="o">.</span><span class="n">n_estimators</span>
    <span class="n">V_IJ</span> <span class="o">=</span> <span class="n">fci</span><span class="o">.</span><span class="n">_core_computation</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">inbag</span><span class="p">,</span> <span class="n">pred_centered</span><span class="p">,</span> <span class="n">n_trees</span><span class="p">,</span>
                             <span class="n">memory_constrained</span><span class="p">,</span> <span class="n">memory_limit</span><span class="p">)</span>
    <span class="n">V_IJ_unbiased</span> <span class="o">=</span> <span class="n">fci</span><span class="o">.</span><span class="n">_bias_correction</span><span class="p">(</span><span class="n">V_IJ</span><span class="p">,</span> <span class="n">inbag</span><span class="p">,</span> <span class="n">pred_centered</span><span class="p">,</span> <span class="n">n_trees</span><span class="p">)</span>

    <span class="c1"># Correct for cases where resampling is done without replacement:</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">inbag</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">variance_inflation</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">inbag</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">V_IJ_unbiased</span> <span class="o">*=</span> <span class="n">variance_inflation</span>

    <span class="k">if</span> <span class="n">basic_IJ</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">V_IJ</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">calibrate</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">V_IJ_unbiased</span>

    <span class="k">if</span> <span class="n">V_IJ_unbiased</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No calibration with n_samples &lt;= 20&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">V_IJ_unbiased</span>
    <span class="k">if</span> <span class="n">calibrate</span><span class="p">:</span>

        <span class="n">calibration_ratio</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">n_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_trees</span> <span class="o">/</span> <span class="n">calibration_ratio</span><span class="p">)</span>
        <span class="n">new_forest</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">forest</span><span class="p">)</span> <span class="c1"># NOTE may need to do explicitly this for EnsembleRegressor -&gt; update: doesn&#39;t seem to cause any issues</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ensemble</span><span class="p">:</span>
            <span class="n">new_forest</span><span class="o">.</span><span class="n">estimators_</span> <span class="o">=</span>\
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">new_forest</span><span class="o">.</span><span class="n">estimators_</span><span class="p">)[:</span><span class="nb">int</span><span class="p">(</span><span class="n">n_sample</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_forest</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span>\
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">new_forest</span><span class="o">.</span><span class="n">model</span><span class="p">)[:</span><span class="nb">int</span><span class="p">(</span><span class="n">n_sample</span><span class="p">)]</span>
        <span class="n">new_forest</span><span class="o">.</span><span class="n">n_estimators</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_sample</span><span class="p">)</span>

        <span class="c1">#results_ss = fci.random_forest_error(new_forest, X_train, X_test,</span>
        <span class="c1">#                                 calibrate=False,</span>
        <span class="c1">#                                 memory_constrained=memory_constrained,</span>
        <span class="c1">#                                 memory_limit=memory_limit)</span>
        <span class="n">results_ss</span> <span class="o">=</span> <span class="n">random_forest_error_modified</span><span class="p">(</span><span class="n">new_forest</span><span class="p">,</span> <span class="n">is_ensemble</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span>
                                         <span class="n">calibrate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">memory_constrained</span><span class="o">=</span><span class="n">memory_constrained</span><span class="p">,</span>
                                         <span class="n">memory_limit</span><span class="o">=</span><span class="n">memory_limit</span><span class="p">)</span>
        <span class="c1"># Use this second set of variance estimates</span>
        <span class="c1"># to estimate scale of Monte Carlo noise</span>
        <span class="n">sigma2_ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">results_ss</span> <span class="o">-</span> <span class="n">V_IJ_unbiased</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">n_sample</span> <span class="o">/</span> <span class="n">n_trees</span>
        <span class="n">sigma2</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">delta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">delta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma2_ss</span>

        <span class="c1"># Use Monte Carlo noise scale estimate for empirical Bayes calibration</span>
        <span class="n">V_IJ_calibrated</span> <span class="o">=</span> <span class="n">fci</span><span class="o">.</span><span class="n">calibration</span><span class="o">.</span><span class="n">calibrateEB</span><span class="p">(</span><span class="n">V_IJ_unbiased</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">V_IJ_calibrated</span></div>

<div class="viewcode-block" id="prediction_intervals"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.prediction_intervals">[docs]</a><span class="k">def</span> <span class="nf">prediction_intervals</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">rf_error_method</span><span class="p">,</span> <span class="n">rf_error_percentile</span><span class="p">,</span> <span class="n">Xtrain</span><span class="p">,</span> <span class="n">Xtest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to calculate prediction intervals when using Random Forest and Gaussian Process regression models.</span>

<span class="sd">    Prediction intervals for random forest adapted from https://blog.datadive.net/prediction-intervals-for-random-forests/</span>

<span class="sd">    Args:</span>

<span class="sd">        model: (scikit-learn model/estimator object), a scikit-learn model object</span>

<span class="sd">        X: (numpy array), array of X features</span>

<span class="sd">        method: (str), type of error bar to formulate (e.g. &quot;stdev&quot; is standard deviation of predicted errors, &quot;confint&quot;</span>
<span class="sd">        is error bar as confidence interval</span>

<span class="sd">        percentile: (int), percentile for which to form error bars</span>

<span class="sd">    Returns:</span>

<span class="sd">        err_up: (list), list of upper bounds of error bars for each data point</span>

<span class="sd">        err_down: (list), list of lower bounds of error bars for each data point</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">err_down</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">err_up</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">nan_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">indices_TF</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">X_aslist</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RandomForestRegressor&#39;</span><span class="p">,</span> <span class="s1">&#39;GradientBoostingRegressor&#39;</span><span class="p">,</span> <span class="s1">&#39;ExtraTreesRegressor&#39;</span><span class="p">,</span> <span class="s1">&#39;EnsembleRegressor&#39;</span><span class="p">]:</span>

        <span class="k">if</span> <span class="n">rf_error_method</span> <span class="o">==</span> <span class="s1">&#39;jackknife_calibrated&#39;</span><span class="p">:</span>
            <span class="n">rf_variances</span> <span class="o">=</span> <span class="n">random_forest_error_modified</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="o">=</span><span class="n">Xtrain</span><span class="p">,</span> <span class="n">X_test</span><span class="o">=</span><span class="n">Xtest</span><span class="p">,</span> <span class="n">basic_IJ</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">calibrate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">rf_stdevs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rf_variances</span><span class="p">)</span>
            <span class="n">nan_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rf_stdevs</span><span class="p">))</span>
            <span class="n">nan_indices_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">nan_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rf_stdevs</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nan_indices_sorted</span><span class="p">:</span>
                    <span class="n">indices_TF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">indices_TF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">rf_stdevs</span> <span class="o">=</span> <span class="n">rf_stdevs</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rf_stdevs</span><span class="p">)]</span>
            <span class="n">err_up</span> <span class="o">=</span> <span class="n">err_down</span> <span class="o">=</span> <span class="n">rf_stdevs</span>
        <span class="k">elif</span> <span class="n">rf_error_method</span> <span class="o">==</span> <span class="s1">&#39;jackknife_uncalibrated&#39;</span><span class="p">:</span>
            <span class="n">rf_variances</span> <span class="o">=</span> <span class="n">random_forest_error_modified</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="o">=</span><span class="n">Xtrain</span><span class="p">,</span> <span class="n">X_test</span><span class="o">=</span><span class="n">Xtest</span><span class="p">,</span> <span class="n">basic_IJ</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">calibrate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">rf_stdevs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rf_variances</span><span class="p">)</span>
            <span class="n">nan_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rf_stdevs</span><span class="p">))</span>
            <span class="n">nan_indices_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">nan_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rf_stdevs</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nan_indices_sorted</span><span class="p">:</span>
                    <span class="n">indices_TF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">indices_TF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">rf_stdevs</span> <span class="o">=</span> <span class="n">rf_stdevs</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rf_stdevs</span><span class="p">)]</span>
            <span class="n">err_up</span> <span class="o">=</span> <span class="n">err_down</span> <span class="o">=</span> <span class="n">rf_stdevs</span>
        <span class="k">elif</span> <span class="n">rf_error_method</span> <span class="o">==</span> <span class="s1">&#39;jackknife_basic&#39;</span><span class="p">:</span>
            <span class="n">rf_variances</span> <span class="o">=</span> <span class="n">random_forest_error_modified</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="o">=</span><span class="n">Xtrain</span><span class="p">,</span> <span class="n">X_test</span><span class="o">=</span><span class="n">Xtest</span><span class="p">,</span> <span class="n">basic_IJ</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">calibrate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">rf_stdevs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rf_variances</span><span class="p">)</span>
            <span class="n">nan_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rf_stdevs</span><span class="p">))</span>
            <span class="n">nan_indices_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">nan_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rf_stdevs</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nan_indices_sorted</span><span class="p">:</span>
                    <span class="n">indices_TF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">indices_TF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">rf_stdevs</span> <span class="o">=</span> <span class="n">rf_stdevs</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rf_stdevs</span><span class="p">)]</span>
            <span class="n">err_up</span> <span class="o">=</span> <span class="n">err_down</span> <span class="o">=</span> <span class="n">rf_stdevs</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X_aslist</span><span class="p">)):</span>
                <span class="n">preds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;RandomForestRegressor&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">estimators_</span><span class="p">:</span>
                        <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_aslist</span><span class="p">[</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;GradientBoostingRegressor&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">estimators_</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                        <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_aslist</span><span class="p">[</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;EnsembleRegressor&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
                        <span class="n">preds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_aslist</span><span class="p">[</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">rf_error_method</span> <span class="o">==</span> <span class="s1">&#39;confint&#39;</span><span class="p">:</span>
                    <span class="c1">#e_down = np.percentile(preds, (100 - int(rf_error_percentile)) / 2.)</span>
                    <span class="c1">#e_up = np.percentile(preds, 100 - (100 - int(rf_error_percentile)) / 2.)</span>
                    <span class="n">e_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">rf_error_percentile</span><span class="p">))</span>
                    <span class="n">e_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">preds</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">rf_error_percentile</span><span class="p">))</span>

                <span class="k">elif</span> <span class="n">rf_error_method</span> <span class="o">==</span> <span class="s1">&#39;stdev&#39;</span><span class="p">:</span>
                    <span class="n">e_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
                    <span class="n">e_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">rf_error_method</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span> <span class="ow">or</span> <span class="n">rf_error_method</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="c1"># basically default to stdev</span>
                    <span class="n">e_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
                    <span class="n">e_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">preds</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;rf_error_method must be one of [&quot;stdev&quot;, &quot;confint&quot;, &quot;jackknife_basic&quot;, &quot;jackknife_calibrated&quot;, &quot;jackknife_uncalibrated&quot;]&#39;</span><span class="p">)</span>
                <span class="c1">#if e_up == 0.0:</span>
                <span class="c1">#    e_up = 10 ** 10</span>
                <span class="c1">#if e_down == 0.0:</span>
                <span class="c1">#    e_down = 10 ** 10</span>
                <span class="n">err_down</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e_down</span><span class="p">)</span>
                <span class="n">err_up</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e_up</span><span class="p">)</span>
            <span class="n">nan_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">err_up</span><span class="p">))</span>
            <span class="n">nan_indices_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">nan_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">err_up</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nan_indices_sorted</span><span class="p">:</span>
                    <span class="n">indices_TF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">indices_TF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;GaussianProcessRegressor&#39;</span><span class="p">:</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Get the stdev model error from the predictions of GPR</span>
        <span class="n">err_up</span> <span class="o">=</span> <span class="n">preds</span>
        <span class="n">err_down</span> <span class="o">=</span> <span class="n">preds</span>

    <span class="k">return</span> <span class="n">err_down</span><span class="p">,</span> <span class="n">err_up</span><span class="p">,</span> <span class="n">nan_indices</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">indices_TF</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_normalized_error"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_normalized_error">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_normalized_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">rf_error_method</span><span class="p">,</span> <span class="n">rf_error_percentile</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Xtrain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">Xtest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to plot the normalized residual errors of a model prediction</span>

<span class="sd">    Args:</span>

<span class="sd">        y_true: (numpy array), array containing the true y data values</span>

<span class="sd">        y_pred: (numpy array), array containing the predicted y data values</span>

<span class="sd">        savepath: (str), path to save the plotted normalized error plot</span>

<span class="sd">        model: (scikit-learn model/estimator object), a scikit-learn model object</span>

<span class="sd">        X: (numpy array), array of X features</span>

<span class="sd">        avg_stats: (dict), dict of calculated average metrics over all CV splits</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">savepath</span><span class="p">)</span>
    <span class="c1"># Here: if model is random forest or Gaussian process, get real error bars. Else, just residuals</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="c1"># TODO: also add support for Gradient Boosted Regressor</span>
    <span class="n">models_with_error_predictions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RandomForestRegressor&#39;</span><span class="p">,</span> <span class="s1">&#39;GaussianProcessRegressor&#39;</span><span class="p">,</span> <span class="s1">&#39;GradientBoostingRegressor&#39;</span><span class="p">,</span> <span class="s1">&#39;EnsembleRegressor&#39;</span><span class="p">]</span>
    <span class="n">has_model_errors</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">y_pred_</span> <span class="o">=</span> <span class="n">y_pred</span>
    <span class="n">y_true_</span> <span class="o">=</span> <span class="n">y_true</span>

    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">models_with_error_predictions</span><span class="p">:</span>
        <span class="n">has_model_errors</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">err_down</span><span class="p">,</span> <span class="n">err_up</span><span class="p">,</span> <span class="n">nan_indices</span><span class="p">,</span> <span class="n">indices_TF</span> <span class="o">=</span> <span class="n">prediction_intervals</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">rf_error_method</span><span class="o">=</span><span class="n">rf_error_method</span><span class="p">,</span>
                                                <span class="n">rf_error_percentile</span><span class="o">=</span><span class="n">rf_error_percentile</span><span class="p">,</span> <span class="n">Xtrain</span><span class="o">=</span><span class="n">Xtrain</span><span class="p">,</span> <span class="n">Xtest</span><span class="o">=</span><span class="n">Xtest</span><span class="p">)</span>

    <span class="n">y_pred_</span> <span class="o">=</span> <span class="n">y_pred</span>
    <span class="n">y_true_</span> <span class="o">=</span> <span class="n">y_true</span>
    <span class="c1"># Correct for nan indices being present</span>
    <span class="k">if</span> <span class="n">has_model_errors</span><span class="p">:</span>
        <span class="n">y_pred_</span> <span class="o">=</span> <span class="n">y_pred_</span><span class="p">[</span><span class="n">indices_TF</span><span class="p">]</span>
        <span class="n">y_true_</span> <span class="o">=</span> <span class="n">y_true_</span><span class="p">[</span><span class="n">indices_TF</span><span class="p">]</span>

    <span class="n">x_align</span> <span class="o">=</span> <span class="mf">0.64</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_true_</span> <span class="o">-</span> <span class="n">y_pred_</span><span class="p">)</span>
    <span class="n">normalized_residuals</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_true_</span><span class="o">-</span><span class="n">y_pred_</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_true_</span><span class="o">-</span><span class="n">y_pred_</span><span class="p">)</span>
    <span class="n">density_residuals</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">normalized_residuals</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">mu</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">y_true_</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Analytical Gaussian&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">density_residuals</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Residuals&quot;</span><span class="p">)</span>
    <span class="n">maxx</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">minn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>

    <span class="k">if</span> <span class="n">has_model_errors</span><span class="p">:</span>
        <span class="n">err_avg</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">abs</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">e2</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">err_up</span><span class="p">,</span> <span class="n">err_down</span><span class="p">)]</span>
        <span class="n">err_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">err_avg</span><span class="p">)</span>
        <span class="n">err_avg</span><span class="p">[</span><span class="n">err_avg</span><span class="o">==</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0001</span>
        <span class="n">err_avg</span> <span class="o">=</span> <span class="n">err_avg</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">model_errors</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_true_</span><span class="o">-</span><span class="n">y_pred_</span><span class="p">)</span><span class="o">/</span><span class="n">err_avg</span>
        <span class="n">density_errors</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">model_errors</span><span class="p">)</span>
        <span class="n">maxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">density_residuals</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">density_errors</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">miny</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">density_residuals</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">density_errors</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">density_errors</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Errors&quot;</span><span class="p">)</span>
        <span class="c1"># Save data to csv file</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Y True&quot;</span><span class="p">:</span> <span class="n">y_true_</span><span class="p">,</span> <span class="s2">&quot;Y Pred&quot;</span><span class="p">:</span> <span class="n">y_pred_</span><span class="p">,</span> <span class="s2">&quot;Plotted x values&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;error_bars_up&quot;</span><span class="p">:</span> <span class="n">err_up</span><span class="p">,</span>
                     <span class="s2">&quot;error_bars_down&quot;</span><span class="p">:</span> <span class="n">err_down</span><span class="p">,</span> <span class="s2">&quot;error_avg&quot;</span><span class="p">:</span> <span class="n">err_avg</span><span class="p">,</span>
                     <span class="s2">&quot;analytical gaussian (plotted y blue values)&quot;</span><span class="p">:</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span>
                     <span class="s2">&quot;model residuals&quot;</span><span class="p">:</span> <span class="n">residuals</span><span class="p">,</span>
                     <span class="s2">&quot;model normalized residuals (plotted y green values)&quot;</span><span class="p">:</span> <span class="n">density_residuals</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                     <span class="s2">&quot;model errors (plotted y purple values)&quot;</span><span class="p">:</span> <span class="n">density_errors</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Save data to csv file</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Y True&quot;</span><span class="p">:</span> <span class="n">y_true</span><span class="p">,</span> <span class="s2">&quot;Y Pred&quot;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s2">&quot;x values&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;analytical gaussian&quot;</span><span class="p">:</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span>
                    <span class="s2">&quot;model residuals&quot;</span><span class="p">:</span> <span class="n">density_residuals</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
        <span class="n">maxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">density_residuals</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)))</span>
        <span class="n">miny</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">density_residuals</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mathrm</span><span class="si">{x}</span><span class="s2">/\mathit{\sigma}$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Probability density&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">_set_tick_labels_different</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">minn</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="n">miny</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">return</span></div>

<div class="viewcode-block" id="plot_cumulative_normalized_error"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_cumulative_normalized_error">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_cumulative_normalized_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">rf_error_method</span><span class="p">,</span> <span class="n">rf_error_percentile</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">Xtrain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Xtest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to plot the cumulative normalized residual errors of a model prediction</span>

<span class="sd">    Args:</span>

<span class="sd">        y_true: (numpy array), array containing the true y data values</span>

<span class="sd">        y_pred: (numpy array), array containing the predicted y data values</span>

<span class="sd">        savepath: (str), path to save the plotted cumulative normalized error plot</span>

<span class="sd">        model: (scikit-learn model/estimator object), a scikit-learn model object</span>

<span class="sd">        X: (numpy array), array of X features</span>

<span class="sd">        avg_stats: (dict), dict of calculated average metrics over all CV splits</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Here: if model is random forest or Gaussian process, get real error bars. Else, just residuals</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">models_with_error_predictions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RandomForestRegressor&#39;</span><span class="p">,</span> <span class="s1">&#39;GaussianProcessRegressor&#39;</span><span class="p">,</span> <span class="s1">&#39;GradientBoostingRegressor&#39;</span><span class="p">,</span> <span class="s1">&#39;EnsembleRegressor&#39;</span><span class="p">]</span>
    <span class="n">has_model_errors</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">y_pred_</span> <span class="o">=</span> <span class="n">y_pred</span>
    <span class="n">y_true_</span> <span class="o">=</span> <span class="n">y_true</span>

    <span class="k">if</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">models_with_error_predictions</span><span class="p">:</span>
        <span class="n">has_model_errors</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">err_down</span><span class="p">,</span> <span class="n">err_up</span><span class="p">,</span> <span class="n">nan_indices</span><span class="p">,</span> <span class="n">indices_TF</span> <span class="o">=</span> <span class="n">prediction_intervals</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">rf_error_method</span><span class="o">=</span><span class="n">rf_error_method</span><span class="p">,</span>
                                                    <span class="n">rf_error_percentile</span><span class="o">=</span><span class="n">rf_error_percentile</span><span class="p">,</span>  <span class="n">Xtrain</span><span class="o">=</span><span class="n">Xtrain</span><span class="p">,</span> <span class="n">Xtest</span><span class="o">=</span><span class="n">Xtest</span><span class="p">)</span>

        <span class="c1"># Need to amend which y_true and y_pred we are considering by removing values from indices_to_ignore to make sure</span>
        <span class="c1"># length of these arrays and err_avg matches</span>
        <span class="n">y_true_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">y_true_</span><span class="p">,</span> <span class="n">nan_indices</span><span class="p">)</span>
        <span class="n">y_pred_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">y_pred_</span><span class="p">,</span> <span class="n">nan_indices</span><span class="p">)</span>
        <span class="n">err_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">err_down</span><span class="p">)[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_pred_</span><span class="p">)]</span>
        <span class="n">err_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">err_up</span><span class="p">)[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_pred_</span><span class="p">)]</span>

    <span class="c1">#Need to remove NaN&#39;s before plotting. These will be present when doing validation runs. Note NaN&#39;s only show up in y_pred_</span>
    <span class="c1"># Correct for nan indices being present</span>
    <span class="k">if</span> <span class="n">has_model_errors</span><span class="p">:</span>
        <span class="n">y_pred_</span> <span class="o">=</span> <span class="n">y_pred_</span><span class="p">[</span><span class="n">indices_TF</span><span class="p">]</span>
        <span class="n">y_true_</span> <span class="o">=</span> <span class="n">y_true_</span><span class="p">[</span><span class="n">indices_TF</span><span class="p">]</span>

    <span class="n">y_true_</span> <span class="o">=</span> <span class="n">y_true_</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_pred_</span><span class="p">)]</span>
    <span class="n">y_pred_</span> <span class="o">=</span> <span class="n">y_pred_</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_pred_</span><span class="p">)]</span>

    <span class="n">x_align</span> <span class="o">=</span> <span class="mf">0.64</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">)</span>

    <span class="n">analytic_gau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="n">analytic_gau</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">analytic_gau</span><span class="p">)</span>
    <span class="n">n_analytic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">analytic_gau</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">analytic_gau</span><span class="p">))</span>
    <span class="n">X_analytic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">analytic_gau</span><span class="p">)</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">y_true_</span><span class="o">-</span><span class="n">y_pred_</span>
    <span class="n">normalized_residuals</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">y_true_</span><span class="o">-</span><span class="n">y_pred_</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_true_</span><span class="o">-</span><span class="n">y_pred_</span><span class="p">))</span>
    <span class="n">n_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">normalized_residuals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">normalized_residuals</span><span class="p">))</span>
    <span class="n">X_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">normalized_residuals</span><span class="p">)</span> <span class="c1">#r&quot;$\mathrm{Predicted \/ Value}, \mathit{eV}$&quot;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mathrm</span><span class="si">{x}</span><span class="s2">/\mathit{\sigma}$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Fraction&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">X_residuals</span><span class="p">,</span> <span class="n">n_residuals</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Residuals&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">X_analytic</span><span class="p">,</span> <span class="n">n_analytic</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Analytical Gaussian&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">has_model_errors</span><span class="p">:</span>
        <span class="n">err_avg</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">abs</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">e2</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> <span class="k">for</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">err_up</span><span class="p">,</span> <span class="n">err_down</span><span class="p">)]</span>
        <span class="n">err_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">err_avg</span><span class="p">)</span>
        <span class="n">err_avg</span><span class="p">[</span><span class="n">err_avg</span><span class="o">==</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0001</span>
        <span class="n">err_avg</span> <span class="o">=</span> <span class="n">err_avg</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">model_errors</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">y_true_</span><span class="o">-</span><span class="n">y_pred_</span><span class="p">)</span><span class="o">/</span><span class="n">err_avg</span><span class="p">)</span>
        <span class="n">n_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_errors</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_errors</span><span class="p">))</span>
        <span class="n">X_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">model_errors</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">X_errors</span><span class="p">,</span> <span class="n">n_errors</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Errors&quot;</span><span class="p">)</span>
        <span class="c1"># Save data to csv file</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Y True&quot;</span><span class="p">:</span> <span class="n">y_true</span><span class="p">,</span> <span class="s2">&quot;Y Pred&quot;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s2">&quot;Analytical Gaussian values&quot;</span><span class="p">:</span> <span class="n">analytic_gau</span><span class="p">,</span> <span class="s2">&quot;Analytical Gaussian (sorted, blue data)&quot;</span><span class="p">:</span> <span class="n">X_analytic</span><span class="p">,</span>
                     <span class="s2">&quot;model residuals&quot;</span><span class="p">:</span> <span class="n">residuals</span><span class="p">,</span>
                     <span class="s2">&quot;Model normalized residuals&quot;</span><span class="p">:</span> <span class="n">normalized_residuals</span><span class="p">,</span> <span class="s2">&quot;Model Residuals (sorted, green data)&quot;</span><span class="p">:</span> <span class="n">X_residuals</span><span class="p">,</span>
                     <span class="s2">&quot;error_bars_up&quot;</span><span class="p">:</span> <span class="n">err_up</span><span class="p">,</span> <span class="s2">&quot;error_bars_down&quot;</span><span class="p">:</span> <span class="n">err_down</span><span class="p">,</span>
                     <span class="s2">&quot;Model error values (r value: (ytrue-ypred)/(model error avg))&quot;</span><span class="p">:</span> <span class="n">model_errors</span><span class="p">,</span>
                     <span class="s2">&quot;Model errors (sorted, purple values)&quot;</span><span class="p">:</span> <span class="n">X_errors</span><span class="p">}</span>
        <span class="c1"># Save this way to avoid issue with different array sizes in data_dict</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Save data to csv file</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Y True&quot;</span><span class="p">:</span> <span class="n">y_true</span><span class="p">,</span> <span class="s2">&quot;Y Pred&quot;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s2">&quot;x analytical&quot;</span><span class="p">:</span> <span class="n">X_analytic</span><span class="p">,</span> <span class="s2">&quot;analytical gaussian&quot;</span><span class="p">:</span> <span class="n">n_analytic</span><span class="p">,</span> <span class="s2">&quot;x residuals&quot;</span><span class="p">:</span> <span class="n">X_residuals</span><span class="p">,</span>
                     <span class="s2">&quot;model residuals&quot;</span><span class="p">:</span> <span class="n">n_residuals</span><span class="p">}</span>
        <span class="c1"># Save this way to avoid issue with different array sizes in data_dict</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">xlabels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">ylabels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axin</span> <span class="o">=</span> <span class="n">zoomed_inset_axes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">axin</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">X_residuals</span><span class="p">,</span> <span class="n">n_residuals</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Residuals&quot;</span><span class="p">)</span>
    <span class="n">axin</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">X_analytic</span><span class="p">,</span> <span class="n">n_analytic</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Analytical Gaussian&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">has_model_errors</span><span class="p">:</span>
        <span class="n">axin</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">X_errors</span><span class="p">,</span> <span class="n">n_errors</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Errors&quot;</span><span class="p">)</span>
    <span class="n">axin</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xlabels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">axin</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ylabels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">axin</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">axin</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.9</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">maxx</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">minn</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maxy</span> <span class="o">=</span> <span class="mf">1.1</span>
    <span class="n">miny</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_set_tick_labels_different</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">minn</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="n">miny</span><span class="p">)</span>

    <span class="n">mark_inset</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">axin</span><span class="p">,</span> <span class="n">loc1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc2</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">return</span></div>

<div class="viewcode-block" id="plot_average_cumulative_normalized_error"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_average_cumulative_normalized_error">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_average_cumulative_normalized_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">has_model_errors</span><span class="p">,</span> <span class="n">err_avg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to plot the cumulative normalized residual errors of a model prediction</span>

<span class="sd">    Args:</span>

<span class="sd">        y_true: (numpy array), array containing the true y data values</span>

<span class="sd">        y_pred: (numpy array), array containing the predicted y data values</span>

<span class="sd">        savepath: (str), path to save the plotted cumulative normalized error plot</span>

<span class="sd">        model: (scikit-learn model/estimator object), a scikit-learn model object</span>

<span class="sd">        X: (numpy array), array of X features</span>

<span class="sd">        avg_stats: (dict), dict of calculated average metrics over all CV splits</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x_align</span> <span class="o">=</span> <span class="mf">0.64</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">)</span>

    <span class="n">analytic_gau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="n">analytic_gau</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">analytic_gau</span><span class="p">)</span>
    <span class="n">n_analytic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">analytic_gau</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">analytic_gau</span><span class="p">))</span>
    <span class="n">X_analytic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">analytic_gau</span><span class="p">)</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">y_true</span><span class="o">-</span><span class="n">y_pred</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">residuals</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">residuals</span><span class="p">)]</span>
    <span class="n">normalized_residuals</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">y_true</span><span class="o">-</span><span class="n">y_pred</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_true</span><span class="o">-</span><span class="n">y_pred</span><span class="p">))</span>
    <span class="n">n_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">normalized_residuals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">normalized_residuals</span><span class="p">))</span>
    <span class="n">X_residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">normalized_residuals</span><span class="p">)</span> <span class="c1">#r&quot;$\mathrm{Predicted \/ Value}, \mathit{eV}$&quot;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mathrm</span><span class="si">{x}</span><span class="s2">/\mathit{\sigma}$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Fraction&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">X_residuals</span><span class="p">,</span> <span class="n">n_residuals</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Residuals&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">X_analytic</span><span class="p">,</span> <span class="n">n_analytic</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Analytical Gaussian&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">has_model_errors</span><span class="p">:</span>
        <span class="n">err_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">err_avg</span><span class="p">)</span>
        <span class="n">err_avg</span><span class="p">[</span><span class="n">err_avg</span><span class="o">==</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0001</span>
        <span class="n">err_avg</span> <span class="o">=</span> <span class="n">err_avg</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">model_errors</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">y_true</span><span class="o">-</span><span class="n">y_pred</span><span class="p">)</span><span class="o">/</span><span class="n">err_avg</span><span class="p">)</span>
        <span class="n">model_errors</span> <span class="o">=</span> <span class="n">model_errors</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">model_errors</span><span class="p">)]</span>
        <span class="n">n_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_errors</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_errors</span><span class="p">))</span>
        <span class="n">X_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">model_errors</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">X_errors</span><span class="p">,</span> <span class="n">n_errors</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Errors&quot;</span><span class="p">)</span>
        <span class="c1"># Save data to csv file</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Y True&quot;</span><span class="p">:</span> <span class="n">y_true</span><span class="p">,</span> <span class="s2">&quot;Y Pred&quot;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s2">&quot;Analytical Gaussian values&quot;</span><span class="p">:</span> <span class="n">analytic_gau</span><span class="p">,</span>
                     <span class="s2">&quot;Analytical Gaussian (sorted, blue data)&quot;</span><span class="p">:</span> <span class="n">X_analytic</span><span class="p">,</span>
                     <span class="s2">&quot;model residuals&quot;</span><span class="p">:</span> <span class="n">residuals</span><span class="p">,</span>
                     <span class="s2">&quot;Model normalized residuals&quot;</span><span class="p">:</span> <span class="n">normalized_residuals</span><span class="p">,</span> <span class="s2">&quot;Model Residuals (sorted, green data)&quot;</span><span class="p">:</span> <span class="n">X_residuals</span><span class="p">,</span>
                     <span class="s2">&quot;Model error values (r value: (ytrue-ypred)/(model error avg))&quot;</span><span class="p">:</span> <span class="n">model_errors</span><span class="p">,</span>
                     <span class="s2">&quot;Model errors (sorted, purple values)&quot;</span><span class="p">:</span> <span class="n">X_errors</span><span class="p">}</span>
        <span class="c1"># Save this way to avoid issue with different array sizes in data_dict</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Save data to csv file</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Y True&quot;</span><span class="p">:</span> <span class="n">y_true</span><span class="p">,</span> <span class="s2">&quot;Y Pred&quot;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s2">&quot;x analytical&quot;</span><span class="p">:</span> <span class="n">X_analytic</span><span class="p">,</span> <span class="s2">&quot;analytical gaussian&quot;</span><span class="p">:</span> <span class="n">n_analytic</span><span class="p">,</span>
                     <span class="s2">&quot;x residuals&quot;</span><span class="p">:</span> <span class="n">X_residuals</span><span class="p">,</span> <span class="s2">&quot;model residuals&quot;</span><span class="p">:</span> <span class="n">n_residuals</span><span class="p">}</span>
        <span class="c1"># Save this way to avoid issue with different array sizes in data_dict</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">xlabels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">ylabels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">axin</span> <span class="o">=</span> <span class="n">zoomed_inset_axes</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">axin</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">X_residuals</span><span class="p">,</span> <span class="n">n_residuals</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Residuals&quot;</span><span class="p">)</span>
    <span class="n">axin</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">X_analytic</span><span class="p">,</span> <span class="n">n_analytic</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Analytical Gaussian&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">has_model_errors</span><span class="p">:</span>
        <span class="n">axin</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">X_errors</span><span class="p">,</span> <span class="n">n_errors</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Errors&quot;</span><span class="p">)</span>
    <span class="n">axin</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">xlabels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">axin</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ylabels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">axin</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">axin</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.9</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">maxx</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">minn</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maxy</span> <span class="o">=</span> <span class="mf">1.1</span>
    <span class="n">miny</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_set_tick_labels_different</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">minn</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="n">miny</span><span class="p">)</span>

    <span class="n">mark_inset</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">axin</span><span class="p">,</span> <span class="n">loc1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc2</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">return</span></div>

<div class="viewcode-block" id="plot_average_normalized_error"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_average_normalized_error">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_average_normalized_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">has_model_errors</span><span class="p">,</span> <span class="n">err_avg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to plot the normalized residual errors of a model prediction</span>

<span class="sd">    Args:</span>

<span class="sd">        y_true: (numpy array), array containing the true y data values</span>

<span class="sd">        y_pred: (numpy array), array containing the predicted y data values</span>

<span class="sd">        savepath: (str), path to save the plotted normalized error plot</span>

<span class="sd">        model: (scikit-learn model/estimator object), a scikit-learn model object</span>

<span class="sd">        X: (numpy array), array of X features</span>

<span class="sd">        avg_stats: (dict), dict of calculated average metrics over all CV splits</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">x_align</span> <span class="o">=</span> <span class="mf">0.64</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">x_align</span><span class="o">=</span><span class="n">x_align</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">residuals</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">residuals</span><span class="p">)]</span>
    <span class="n">normalized_residuals</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_true</span><span class="o">-</span><span class="n">y_pred</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_true</span><span class="o">-</span><span class="n">y_pred</span><span class="p">)</span>
    <span class="n">density_residuals</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">normalized_residuals</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">mu</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">y_true</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Analytical Gaussian&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">density_residuals</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Residuals&quot;</span><span class="p">)</span>
    <span class="n">maxx</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">minn</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>

    <span class="k">if</span> <span class="n">has_model_errors</span><span class="p">:</span>
        <span class="n">nans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">err_avg</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">nans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">nans</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nans</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">err_avg</span><span class="p">[</span><span class="n">nans</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">err_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">err_avg</span><span class="p">)</span>
        <span class="n">err_avg</span><span class="p">[</span><span class="n">err_avg</span><span class="o">==</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0001</span>
        <span class="n">err_avg</span> <span class="o">=</span> <span class="n">err_avg</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">model_errors</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_true</span><span class="o">-</span><span class="n">y_pred</span><span class="p">)</span><span class="o">/</span><span class="n">err_avg</span>
        <span class="n">model_errors</span> <span class="o">=</span> <span class="n">model_errors</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">model_errors</span><span class="p">)]</span>
        <span class="n">density_errors</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">model_errors</span><span class="p">)</span>
        <span class="n">maxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">density_residuals</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">density_errors</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">miny</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">density_residuals</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">density_errors</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">density_errors</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Model Errors&quot;</span><span class="p">)</span>
        <span class="c1"># Save data to csv file</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Y True&quot;</span><span class="p">:</span> <span class="n">y_true</span><span class="p">,</span> <span class="s2">&quot;Y Pred&quot;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s2">&quot;Plotted x values&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;Model errors&quot;</span><span class="p">:</span> <span class="n">err_avg</span><span class="p">,</span>
                     <span class="s2">&quot;analytical gaussian (plotted y blue values)&quot;</span><span class="p">:</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span>
                     <span class="s2">&quot;model residuals&quot;</span><span class="p">:</span> <span class="n">residuals</span><span class="p">,</span>
                     <span class="s2">&quot;model normalized residuals (plotted y green values)&quot;</span><span class="p">:</span> <span class="n">density_residuals</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                     <span class="s2">&quot;model errors (plotted y purple values)&quot;</span><span class="p">:</span> <span class="n">density_errors</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Save data to csv file</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Y True&quot;</span><span class="p">:</span> <span class="n">y_true</span><span class="p">,</span> <span class="s2">&quot;Y Pred&quot;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s2">&quot;x values&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;analytical gaussian&quot;</span><span class="p">:</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span>
                    <span class="s2">&quot;model residuals&quot;</span><span class="p">:</span> <span class="n">density_residuals</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
        <span class="n">maxy</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">density_residuals</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="nb">max</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)))</span>
        <span class="n">miny</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">density_residuals</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="nb">min</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\mathrm</span><span class="si">{x}</span><span class="s2">/\mathit{\sigma}$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Probability density&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">_set_tick_labels_different</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">minn</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="n">miny</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">return</span></div>

<span class="k">def</span> <span class="nf">plot_real_vs_predicted_error</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">data_test_type</span><span class="p">):</span>

    <span class="n">bin_values</span><span class="p">,</span> <span class="n">rms_residual_values</span><span class="p">,</span> <span class="n">num_values_per_bin</span> <span class="o">=</span> <span class="n">parse_error_data</span><span class="p">(</span><span class="n">dataset_stdev</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_true</span><span class="p">),</span>
                                                                          <span class="n">path_to_test</span><span class="o">=</span><span class="n">savepath</span><span class="p">,</span>
                                                                           <span class="n">data_test_type</span><span class="o">=</span><span class="n">data_test_type</span><span class="p">)</span>

    <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">if</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;RandomForestRegressor&#39;</span><span class="p">:</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;RF&#39;</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;GradientBoostingRegressor&#39;</span><span class="p">:</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;GBR&#39;</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;ExtraTreesRegressor&#39;</span><span class="p">:</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;ET&#39;</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;GaussianProcessRegressor&#39;</span><span class="p">:</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;GPR&#39;</span>
    <span class="k">elif</span> <span class="n">model_name</span> <span class="o">==</span> <span class="s1">&#39;EnsembleRegressor&#39;</span><span class="p">:</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="s1">&#39;ER&#39;</span>

    <span class="k">if</span> <span class="n">data_test_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;validation&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: data_test_type must be one of &quot;test&quot; or &quot;validation&quot;&#39;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span>

    <span class="c1"># Make RF error plot</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">(</span><span class="n">aspect_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="mf">0.65</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bin_values</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">],</span> <span class="n">rms_residual_values</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bin_values</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="n">rms_residual_values</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">model_type</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; model errors / dataset stdev&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;RMS Absolute residuals</span><span class="se">\n</span><span class="s1"> / dataset stdev&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="n">linear_int</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">linear</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">fit_intercept</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Fit just blue circle data</span>
    <span class="c1"># Find nan entries</span>
    <span class="n">nans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rms_residual_values</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># use nans (which are indices) to delete relevant parts of bin_values and </span>
    <span class="c1"># rms_residual_values as they can&#39;t be used to fit anyway</span>
    <span class="n">bin_values_copy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">bin_values</span><span class="p">)</span>
    <span class="n">bin_values_copy</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">bin_values</span>
    <span class="n">rms_residual_values_copy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">rms_residual_values</span><span class="p">)</span>
    <span class="n">rms_residual_values_copy</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">rms_residual_values</span>
    <span class="n">bin_values_copy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">bin_values_copy</span><span class="p">,</span> <span class="n">nans</span><span class="p">)</span>
    <span class="n">rms_residual_values_copy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rms_residual_values_copy</span><span class="p">,</span> <span class="n">nans</span><span class="p">)</span>

    <span class="c1"># BEGIN OLD CODE</span>
    <span class="c1"># --------------</span>
    <span class="c1">#lowval = 0</span>
    <span class="c1">#if len(nans) &gt; 0:</span>
    <span class="c1">#    if nans[0][0] == 0:</span>
    <span class="c1">#        nans = nans[1:]</span>
    <span class="c1">#        lowval = 1</span>
    <span class="c1">#        if len(nans) &gt; 0:</span>
    <span class="c1">#            if nans[0][0] == 1:</span>
    <span class="c1">#                nans = nans[1:]</span>
    <span class="c1">#                lowval = 2</span>
    <span class="c1">#                if len(nans) &gt; 0:</span>
    <span class="c1">#                    if nans[0][0] == 2:</span>
    <span class="c1">#                        nans = nans[1:]</span>
    <span class="c1">#                        lowval = 3</span>
    <span class="c1">#                        if len(nans) &gt; 0:</span>
    <span class="c1">#                            if nans[0][0] == 3:</span>
    <span class="c1">#                                nans = nans[1:]</span>
    <span class="c1">#                                lowval = 4</span>

    <span class="c1">#try:</span>
    <span class="c1">#    val = min(nans)[0]</span>
    <span class="c1">#except ValueError:</span>
    <span class="c1">#    val = 10</span>
    <span class="c1">#if val &gt; 10:</span>
    <span class="c1">#    val = 10</span>

    <span class="c1">#linear.fit(np.array(bin_values[lowval:val]).reshape(-1, 1), rms_residual_values[lowval:val])</span>

    <span class="c1">#yfit = linear.predict(np.array(bin_values[lowval:val]).reshape(-1, 1))</span>
    <span class="c1">#ax.plot(bin_values[lowval:val], yfit, &#39;k--&#39;, linewidth=2)</span>
    <span class="c1">#slope = linear.coef_</span>
    <span class="c1">#r2 = r2_score(rms_residual_values[lowval:val], yfit)</span>
    <span class="c1"># --------------</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">rms_residual_values_copy</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---WARNING: ALL ERRORS TOO LARGE FOR PLOTTING---&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">linear_int</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bin_values_copy</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">rms_residual_values_copy</span><span class="p">)</span>
        <span class="n">linear</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bin_values_copy</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">rms_residual_values_copy</span><span class="p">)</span>

        <span class="n">yfit_int</span> <span class="o">=</span> <span class="n">linear_int</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bin_values_copy</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">yfit</span> <span class="o">=</span> <span class="n">linear</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bin_values_copy</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_values_copy</span><span class="p">,</span> <span class="n">yfit_int</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bin_values_copy</span><span class="p">,</span> <span class="n">yfit</span><span class="p">,</span> <span class="s1">&#39;k--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">slope_int</span> <span class="o">=</span> <span class="n">linear_int</span><span class="o">.</span><span class="n">coef_</span>
        <span class="n">r2_int</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">rms_residual_values_copy</span><span class="p">,</span> <span class="n">yfit_int</span><span class="p">)</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">linear</span><span class="o">.</span><span class="n">coef_</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">rms_residual_values_copy</span><span class="p">,</span> <span class="n">yfit</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="s1">&#39;intercept slope = </span><span class="si">%3.2f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">slope_int</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;r&#39;</span><span class="p">})</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="s1">&#39;intercept R$^2$ = </span><span class="si">%3.2f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">r2_int</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;r&#39;</span><span class="p">})</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;slope = </span><span class="si">%3.2f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">slope</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">})</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="s1">&#39;R$^2$ = </span><span class="si">%3.2f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">r2</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">})</span>

    <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">axbarx</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

    <span class="n">axbarx</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">bin_values</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">num_values_per_bin</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.05276488</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
               <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">axbarx</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>
    <span class="n">axbarx</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
    <span class="n">axbarx</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="n">total_samples</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">num_values_per_bin</span><span class="p">)</span>
    <span class="n">axbarx</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="mf">0.67</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">num_values_per_bin</span><span class="p">)),</span> <span class="s1">&#39;Total counts = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">total_samples</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mf">1.3</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">rms_residual_values</span><span class="p">)))</span>
    <span class="n">axbarx</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">num_values_per_bin</span><span class="p">)</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">bin_values_copy</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">))</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_type</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_residuals_vs_modelerror_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_test_type</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span><span class="p">),</span>
        <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

    <span class="k">return</span>

<span class="k">def</span> <span class="nf">parse_error_data</span><span class="p">(</span><span class="n">dataset_stdev</span><span class="p">,</span> <span class="n">path_to_test</span><span class="p">,</span> <span class="n">data_test_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">data_test_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;validation&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error: data_test_type must be one of &quot;test&quot; or &quot;validation&quot;&#39;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">()</span>
    <span class="n">dfs_ytrue</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">dfs_ypred</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">dfs_erroravg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">dfs_modelresiduals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">files_to_parse</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">folder</span><span class="p">,</span> <span class="n">subfolders</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path_to_test</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;split&#39;</span> <span class="ow">in</span> <span class="n">folder</span><span class="p">:</span>
            <span class="n">splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">splits</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_test_type</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_normalized_error.csv&#39;</span><span class="p">)):</span>
            <span class="n">files_to_parse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_test_type</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_normalized_error.csv&#39;</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files_to_parse</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">dfs_ytrue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Y True&#39;</span><span class="p">]))</span>
        <span class="n">dfs_ypred</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Y Pred&#39;</span><span class="p">]))</span>
        <span class="n">dfs_erroravg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;error_avg&#39;</span><span class="p">]))</span>
        <span class="n">dfs_modelresiduals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;model residuals&#39;</span><span class="p">]))</span>

    <span class="n">ytrue_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dfs_ytrue</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">ypred_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dfs_ypred</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="n">erroravg_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dfs_erroravg</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">modelresiduals_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dfs_modelresiduals</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">absmodelresiduals_all</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">modelresiduals_all</span><span class="p">]</span>
    <span class="n">squaredmodelresiduals_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">absmodelresiduals_all</span><span class="p">]</span>

    <span class="n">erroravg_all_reduced</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">dataset_stdev</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">erroravg_all</span><span class="p">]</span>
    <span class="c1"># Need to square the dataset_stdev here since these are squared residuals</span>
    <span class="n">squaredmodelresiduals_all_reduced</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">dataset_stdev</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">squaredmodelresiduals_all</span><span class="p">]</span>

    <span class="n">erroravg_reduced_sorted</span><span class="p">,</span> <span class="n">squaredresiduals_reduced_sorted</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">erroravg_all_reduced</span><span class="p">,</span> <span class="n">squaredmodelresiduals_all_reduced</span><span class="p">))))</span>

    <span class="n">bin_values</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="mf">1.15</span><span class="p">,</span> <span class="mf">1.25</span><span class="p">,</span> <span class="mf">1.35</span><span class="p">,</span> <span class="mf">1.45</span><span class="p">,</span> <span class="mf">1.55</span><span class="p">]</span>
    <span class="n">bin_delta</span> <span class="o">=</span> <span class="mf">0.05</span>

    <span class="n">over_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">over_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">erroravg_reduced_sorted</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">bin_values</span><span class="p">)</span> <span class="o">+</span> <span class="n">bin_delta</span><span class="p">):</span>
            <span class="n">over_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">over_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">over_vals</span><span class="p">):</span>
        <span class="n">med_over_val</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">over_vals</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">med_over_val</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bin_values</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="c1"># just add another bin and put everthing in there</span>
            <span class="n">bin_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.65</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># extend histogram</span>
            <span class="n">max_over_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">over_vals</span><span class="p">)</span>
            <span class="n">extra_bin_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.65</span><span class="p">,</span> <span class="n">max_over_val</span><span class="o">+</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
            <span class="n">bin_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">bin_values</span><span class="p">,</span> <span class="n">extra_bin_values</span><span class="p">])</span>

    <span class="n">rms_residual_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">num_values_per_bin</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">bin_value</span> <span class="ow">in</span> <span class="n">bin_values</span><span class="p">:</span>
        <span class="n">bin_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">bin_residuals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">erroravg_reduced_sorted</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">bin_value</span><span class="o">-</span><span class="n">bin_delta</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bin_value</span> <span class="o">==</span> <span class="n">bin_values</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">bin_values</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">bin_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">bin_value</span><span class="o">+</span><span class="n">bin_delta</span><span class="p">:</span>
                        <span class="n">bin_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bin_indices</span><span class="p">:</span>
            <span class="n">bin_residuals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">squaredresiduals_reduced_sorted</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">rms_residual_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">bin_residuals</span><span class="p">)))</span>
        <span class="n">num_values_per_bin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bin_indices</span><span class="p">))</span>

    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Y True&quot;</span><span class="p">:</span> <span class="n">ytrue_all</span><span class="p">,</span>
                 <span class="s2">&quot;Y Pred&quot;</span><span class="p">:</span> <span class="n">ypred_all</span><span class="p">,</span>
                 <span class="s2">&quot;Model Residuals&quot;</span><span class="p">:</span> <span class="n">modelresiduals_all</span><span class="p">,</span>
                 <span class="s2">&quot;Abs Model Residuals&quot;</span><span class="p">:</span> <span class="n">absmodelresiduals_all</span><span class="p">,</span>
                 <span class="s2">&quot;Squared Model Resiuals&quot;</span><span class="p">:</span> <span class="n">squaredmodelresiduals_all</span><span class="p">,</span>
                 <span class="s2">&quot;Squared Model Residuals / dataset stdev&quot;</span><span class="p">:</span> <span class="n">squaredmodelresiduals_all_reduced</span><span class="p">,</span>
                 <span class="s2">&quot;Model errors&quot;</span><span class="p">:</span> <span class="n">erroravg_all</span><span class="p">,</span>
                 <span class="s2">&quot;Model errors / dataset stdev&quot;</span><span class="p">:</span> <span class="n">erroravg_all_reduced</span><span class="p">,</span>
                 <span class="s2">&quot;Model errors / dataset stdev (sorted)&quot;</span><span class="p">:</span> <span class="n">erroravg_reduced_sorted</span><span class="p">,</span>
                 <span class="s2">&quot;Squared Model Residuals / dataset stdev (sorted)&quot;</span><span class="p">:</span> <span class="n">squaredresiduals_reduced_sorted</span><span class="p">,</span>
                 <span class="s2">&quot;Bin values (Model errors / dataset stdev)&quot;</span><span class="p">:</span> <span class="n">bin_values</span><span class="p">,</span>
                 <span class="s2">&quot;Model RMS absolute residuals in each bin&quot;</span><span class="p">:</span> <span class="n">rms_residual_values</span><span class="p">,</span>
                 <span class="s2">&quot;Number of values in each bin&quot;</span><span class="p">:</span> <span class="n">num_values_per_bin</span><span class="p">}</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_test</span><span class="p">,</span> <span class="s1">&#39;ModelErrorAnalysis_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">data_test_type</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.xlsx&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">bin_values</span><span class="p">,</span> <span class="n">rms_residual_values</span><span class="p">,</span> <span class="n">num_values_per_bin</span>

<div class="viewcode-block" id="plot_1d_heatmap"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_1d_heatmap">[docs]</a><span class="k">def</span> <span class="nf">plot_1d_heatmap</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">heats</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">heatlabel</span><span class="o">=</span><span class="s1">&#39;heats&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to plot a heatmap for values of a single variable; used for plotting GridSearch results in hyperparameter optimization.</span>

<span class="sd">    Args:</span>

<span class="sd">        xs: (numpy array), array of first variable values to plot heatmap against</span>

<span class="sd">        heats: (numpy array), array of heat values to plot</span>

<span class="sd">        savepath: (str), path to save the 1D heatmap to</span>

<span class="sd">        xlabel: (str), the x-axis label</span>

<span class="sd">        heatlabel: (str), the heat value axis label</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#TODO have more general solution</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">heats</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">heatlabel</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="c1"># Escape from error of passing tuples when optimizing neural net</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="plot_2d_heatmap"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_2d_heatmap">[docs]</a><span class="k">def</span> <span class="nf">plot_2d_heatmap</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">heats</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span>
                    <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">heatlabel</span><span class="o">=</span><span class="s1">&#39;heat&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to plot a heatmap for values of two variables; used for plotting GridSearch results in hyperparameter optimization.</span>

<span class="sd">    Args:</span>

<span class="sd">        xs: (numpy array), array of first variable values to plot heatmap against</span>

<span class="sd">        ys: (numpy array), array of second variable values to plot heatmap against</span>

<span class="sd">        heats: (numpy array), array of heat values to plot</span>

<span class="sd">        savepath: (str), path to save the 2D heatmap to</span>

<span class="sd">        xlabel: (str), the x-axis label</span>

<span class="sd">        ylabel: (str), the y-axis label</span>

<span class="sd">        heatlabel: (str), the heat value axis label</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#TODO have more general solution</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">make_fig_ax</span><span class="p">()</span>
        <span class="n">scat</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">heats</span><span class="p">)</span> <span class="c1"># marker=&#39;o&#39;, lw=0, s=20, cmap=cm.plasma</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scat</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">heatlabel</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="c1"># Escape from error of passing tuples when optimizing neural net</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="plot_3d_heatmap"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_3d_heatmap">[docs]</a><span class="k">def</span> <span class="nf">plot_3d_heatmap</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">zs</span><span class="p">,</span> <span class="n">heats</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span>
                    <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">zlabel</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">heatlabel</span><span class="o">=</span><span class="s1">&#39;heat&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to plot a heatmap for values of three variables; used for plotting GridSearch results in hyperparameter optimization.</span>

<span class="sd">    Args:</span>

<span class="sd">        xs: (numpy array), array of first variable values to plot heatmap against</span>

<span class="sd">        ys: (numpy array), array of second variable values to plot heatmap against</span>

<span class="sd">        zs: (numpy array), array of third variable values to plot heatmap against</span>

<span class="sd">        heats: (numpy array), array of heat values to plot</span>

<span class="sd">        savepath: (str), path to save the 2D heatmap to</span>

<span class="sd">        xlabel: (str), the x-axis label</span>

<span class="sd">        ylabel: (str), the y-axis label</span>

<span class="sd">        zlabel: (str), the z-axis label</span>

<span class="sd">        heatlabel: (str), the heat value axis label</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Escape from error of passing tuples when optimzing neural net</span>
    <span class="c1"># TODO have more general solution</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># this import has side effects, needed for 3d plots:</span>
        <span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="k">import</span> <span class="n">Axes3D</span>
        <span class="c1"># Set image aspect ratio:</span>
        <span class="c1"># (eeds to be wide enough or plot will shrink really skinny)</span>
        <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">figaspect</span><span class="p">(</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">))</span>
        <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span> <span class="c1"># modifies fig in place</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>

        <span class="n">scat</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">zs</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">heats</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="n">zlabel</span><span class="p">)</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scat</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">heatlabel</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">azim</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">fig</span><span class="p">]</span>
    <span class="n">anim</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#anim.save(savepath+&#39;.mp4&#39;, fps=5, extra_args=[&#39;-vcodec&#39;, &#39;libx264&#39;])</span>
    <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">savepath</span><span class="o">+</span><span class="s1">&#39;.gif&#39;</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">writer</span><span class="o">=</span><span class="s1">&#39;imagemagick&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_learning_curve"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_learning_curve">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_learning_curve</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">,</span> <span class="n">train_mean</span><span class="p">,</span> <span class="n">test_mean</span><span class="p">,</span> <span class="n">train_stdev</span><span class="p">,</span> <span class="n">test_stdev</span><span class="p">,</span> <span class="n">score_name</span><span class="p">,</span> <span class="n">learning_curve_type</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="s1">&#39;data_learning_curve&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method used to plot both data and feature learning curves</span>

<span class="sd">    Args:</span>

<span class="sd">        train_sizes: (numpy array), array of x-axis values, such as fraction of data used or number of features</span>

<span class="sd">        train_mean: (numpy array), array of training data mean values, averaged over some type/number of CV splits</span>

<span class="sd">        test_mean: (numpy array), array of test data mean values, averaged over some type/number of CV splits</span>

<span class="sd">        train_stdev: (numpy array), array of training data standard deviation values, from some type/number of CV splits</span>

<span class="sd">        test_stdev: (numpy array), array of test data standard deviation values, from some type/number of CV splits</span>

<span class="sd">        score_name: (str), type of score metric for learning curve plotting; used in y-axis label</span>

<span class="sd">        learning_curve_type: (str), type of learning curve employed: &#39;sample_learning_curve&#39; or &#39;feature_learning_curve&#39;</span>

<span class="sd">        savepath: (str), path to save the plotted learning curve to</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set image aspect ratio (do custom for learning curve):</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">figaspect</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">))</span>
    <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:])</span>

    <span class="n">max_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">)</span>
    <span class="n">min_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">)</span>

    <span class="n">max_y</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">=</span> <span class="n">recursive_max_and_min</span><span class="p">([</span>
        <span class="n">train_mean</span><span class="p">,</span>
        <span class="n">train_mean</span> <span class="o">+</span> <span class="n">train_stdev</span><span class="p">,</span>
        <span class="n">train_mean</span> <span class="o">-</span> <span class="n">train_stdev</span><span class="p">,</span>
        <span class="n">test_mean</span><span class="p">,</span>
        <span class="n">test_mean</span> <span class="o">+</span> <span class="n">test_stdev</span><span class="p">,</span>
        <span class="n">test_mean</span> <span class="o">-</span> <span class="n">test_stdev</span><span class="p">,</span>
        <span class="p">])</span>

    <span class="n">max_x</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">max_x</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">max_x</span><span class="o">-</span><span class="n">min_x</span><span class="p">))</span>
    <span class="n">min_x</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">min_x</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">max_x</span><span class="o">-</span><span class="n">min_x</span><span class="p">))</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">max_y</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">max_y</span><span class="o">-</span><span class="n">min_y</span><span class="p">))</span>
    <span class="n">min_y</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">min_y</span><span class="p">),</span> <span class="n">rounder</span><span class="p">(</span><span class="n">max_y</span><span class="o">-</span><span class="n">min_y</span><span class="p">))</span>
    <span class="n">_set_tick_labels_different</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">min_y</span><span class="p">)</span>

    <span class="c1"># plot and collect handles h1 and h2 for making legend</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">,</span> <span class="n">train_mean</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">,</span> <span class="n">train_mean</span><span class="o">-</span><span class="n">train_stdev</span><span class="p">,</span> <span class="n">train_mean</span><span class="o">+</span><span class="n">train_stdev</span><span class="p">,</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    <span class="n">h2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">,</span> <span class="n">test_mean</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">,</span> <span class="n">test_mean</span><span class="o">-</span><span class="n">test_stdev</span><span class="p">,</span> <span class="n">test_mean</span><span class="o">+</span><span class="n">test_stdev</span><span class="p">,</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;train score&#39;</span><span class="p">,</span> <span class="s1">&#39;validation score&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">learning_curve_type</span> <span class="o">==</span> <span class="s1">&#39;sample_learning_curve&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Number of training data points&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">learning_curve_type</span> <span class="o">==</span> <span class="s1">&#39;feature_learning_curve&#39;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Number of features selected&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The param &quot;learning_curve_type&quot; must be either &quot;sample_learning_curve&quot; or &quot;feature_learning_curve&quot;&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">score_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

    <span class="c1"># Save output data to spreadsheet</span>
    <span class="n">df_concat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">train_mean</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">train_stdev</span><span class="p">),</span>
                           <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">test_mean</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">test_stdev</span><span class="p">)],</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">df_concat</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;train_sizes&#39;</span><span class="p">,</span> <span class="s1">&#39;train_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;train_stdev&#39;</span><span class="p">,</span> <span class="s1">&#39;test_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;test_stdev&#39;</span><span class="p">]</span>
    <span class="n">df_concat</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath</span><span class="o">+</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plot_learning_curve_convergence</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">,</span> <span class="n">test_mean</span><span class="p">,</span> <span class="n">score_name</span><span class="p">,</span> <span class="n">learning_curve_type</span><span class="p">,</span> <span class="n">savepath</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;MASTML encountered an error while trying to plot the learning curve convergences plots, likely due to &#39;</span>
                  <span class="s1">&#39;insufficient data&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="plot_learning_curve_convergence"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_learning_curve_convergence">[docs]</a><span class="nd">@ipynb_maker</span>
<span class="k">def</span> <span class="nf">plot_learning_curve_convergence</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">,</span> <span class="n">test_mean</span><span class="p">,</span> <span class="n">score_name</span><span class="p">,</span> <span class="n">learning_curve_type</span><span class="p">,</span> <span class="n">savepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method used to plot both the convergence of data and feature learning curves as a function of amount of data or features</span>

<span class="sd">    used, respectively.</span>

<span class="sd">    Args:</span>

<span class="sd">        train_sizes: (numpy array), array of x-axis values, such as fraction of data used or number of features</span>

<span class="sd">        test_mean: (numpy array), array of test data mean values, averaged over some type/number of CV splits</span>

<span class="sd">        score_name: (str), type of score metric for learning curve plotting; used in y-axis label</span>

<span class="sd">        learning_curve_type: (str), type of learning curve employed: &#39;sample_learning_curve&#39; or &#39;feature_learning_curve&#39;</span>

<span class="sd">        savepath: (str), path to save the plotted convergence learning curve to</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Function to examine the minimization of error in learning curve CV scores as function of amount of data or number</span>
    <span class="c1"># of features used.</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">train_sizes</span><span class="p">))]</span>
    <span class="n">test_mean</span> <span class="o">=</span> <span class="n">test_mean</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">slopes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">step</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)),</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_mean</span><span class="p">))):</span>
        <span class="k">if</span> <span class="n">step</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
            <span class="n">slopes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">test_mean</span><span class="p">[</span><span class="n">val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">test_mean</span><span class="p">[</span><span class="n">val</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">steps</span><span class="p">[</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">steps</span><span class="p">[</span><span class="n">step</span><span class="p">]))</span>

    <span class="c1"># Remove first entry to steps for plotting</span>
    <span class="k">del</span> <span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Get moving average of slopes to generate smoother curve</span>
    <span class="n">window_size</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">test_mean</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">steps_moving_average</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">slopes_moving_average</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">window_size</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1">#### Plotting</span>
    <span class="c1"># Set image aspect ratio (do custom for learning curve):</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">figaspect</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">))</span>
    <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:])</span>

    <span class="n">max_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
    <span class="n">min_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span>
    <span class="n">min_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">slopes</span><span class="p">)</span>
    <span class="n">_set_tick_labels_different</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">min_y</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">slopes</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">steps_moving_average</span><span class="p">,</span> <span class="n">slopes_moving_average</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;score slope&#39;</span><span class="p">,</span> <span class="s1">&#39;smoothed score slope&#39;</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Learning curve step&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Change in &#39;</span><span class="o">+</span><span class="n">score_name</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="o">+</span><span class="s1">&#39;_convergence&#39;</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPI</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

    <span class="n">datadict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Steps&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span> <span class="s2">&quot;Slopes&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slopes</span><span class="p">),</span>
                <span class="s2">&quot;Steps moving average&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">steps_moving_average</span><span class="p">)),</span>
                <span class="s2">&quot;Slopes moving average&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slopes_moving_average</span><span class="p">))}</span>

    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">datadict</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">savepath</span><span class="o">+</span><span class="s1">&#39;_convergence.csv&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">learning_curve_type</span> <span class="o">==</span> <span class="s1">&#39;feature_learning_curve&#39;</span><span class="p">:</span>
        <span class="c1"># First, set number optimal features to all features in case stopping criteria not met</span>
        <span class="n">n_features_optimal</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_mean</span><span class="p">)</span>
        <span class="c1"># Determine what the optimal number of features are to use</span>
        <span class="c1"># TODO: have user set stopping criteria. Have default by 0.005 (0.5%)</span>
        <span class="n">stopping_criteria</span> <span class="o">=</span> <span class="mf">0.005</span>
        <span class="n">slopes_moving_average_list</span> <span class="o">=</span> <span class="n">slopes_moving_average</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">slope</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">slopes_moving_average_list</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">delta</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">slopes_moving_average_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">slopes_moving_average_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="n">slopes_moving_average_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="n">stopping_criteria</span><span class="p">:</span>
                    <span class="n">n_features_optimal</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Write optimal number of features to text file</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">savepath</span><span class="o">+</span><span class="s1">&#39;_optimalfeaturenumber.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n_features_optimal</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">### Helpers:</span>

<div class="viewcode-block" id="trim_array"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.trim_array">[docs]</a><span class="k">def</span> <span class="nf">trim_array</span><span class="p">(</span><span class="n">arr_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method used to trim a set of arrays to make all arrays the same shape</span>

<span class="sd">    Args:</span>

<span class="sd">        arr_list: (list), list of numpy arrays, where arrays are different sizes</span>

<span class="sd">    Returns:</span>

<span class="sd">        arr_list: (), list of trimmed numpy arrays, where arrays are same size</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO: a better way to handle arrays with very different shapes? Otherwise average only uses # of points of smallest array</span>
    <span class="c1"># Need to make arrays all same shapes if they aren&#39;t</span>
    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">arr_list</span><span class="p">]</span>
    <span class="n">size_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sizes</span><span class="p">)</span>
    <span class="n">arr_list_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arr_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">size_min</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">size_min</span><span class="p">:</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">arr_list_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">arr_list</span> <span class="o">=</span> <span class="n">arr_list_</span>
    <span class="k">return</span> <span class="n">arr_list</span></div>

<div class="viewcode-block" id="rounder"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.rounder">[docs]</a><span class="k">def</span> <span class="nf">rounder</span><span class="p">(</span><span class="n">delta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to obtain number of decimal places to report on plots</span>

<span class="sd">    Args:</span>

<span class="sd">        delta: (float), a float representing the change in two y values on a plot, used to obtain the plot axis spacing size</span>

<span class="sd">    Return:</span>

<span class="sd">        (int), an integer denoting the number of decimal places to use</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="mf">0.001</span> <span class="o">&lt;=</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="mf">0.01</span> <span class="o">&lt;=</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="mf">0.1</span> <span class="o">&lt;=</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="get_histogram_bins"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.get_histogram_bins">[docs]</a><span class="k">def</span> <span class="nf">get_histogram_bins</span><span class="p">(</span><span class="n">y_df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to obtain the number of bins to use when plotting a histogram</span>

<span class="sd">    Args:</span>

<span class="sd">        y_df: (pandas Series or numpy array), array of y data used to construct histogram</span>

<span class="sd">    Returns:</span>

<span class="sd">        num_bins: (int), the number of bins to use when plotting a histogram</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bin_dividers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">y_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bin_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">divider</span> <span class="ow">in</span> <span class="n">bin_dividers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">divider</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">divider</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bins</span> <span class="o">&lt;</span> <span class="n">y_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">bin_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">num_bins</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">num_bins</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bin_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">num_bins</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">return</span> <span class="n">num_bins</span></div>

<div class="viewcode-block" id="stat_to_string"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.stat_to_string">[docs]</a><span class="k">def</span> <span class="nf">stat_to_string</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">nice_names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method that converts a metric object into a string for displaying on a plot</span>

<span class="sd">    Args:</span>

<span class="sd">        name: (str), long name of a stat metric or quantity</span>

<span class="sd">        value: (float), value of the metric or quantity</span>

<span class="sd">    Return:</span>

<span class="sd">        (str), a string of the metric name, adjusted to look nicer for inclusion on a plot</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="s2">&quot; Stringifies the name value pair for display within a plot &quot;</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nice_names</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">nice_names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="c1"># has a name only</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span>
    <span class="c1"># has a mean and std</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1">:&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{mean:.3f}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$\pm$&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{std:.3f}</span><span class="s1">&#39;</span>
    <span class="c1"># has a name and value only</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">%</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1">: {int(value)}&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1">: </span><span class="si">{value:.3f}</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1">: </span><span class="si">{value}</span><span class="s1">&#39;</span> <span class="c1"># probably a string</span></div>

<div class="viewcode-block" id="plot_stats"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.plot_stats">[docs]</a><span class="k">def</span> <span class="nf">plot_stats</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="mf">0.65</span><span class="p">,</span> <span class="n">y_align</span><span class="o">=</span><span class="mf">0.90</span><span class="p">,</span> <span class="n">font_dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method that prints stats onto the plot. Goes off screen if they are too long or too many in number.</span>

<span class="sd">    Args:</span>

<span class="sd">        fig: (matplotlib figure object), a matplotlib figure object</span>

<span class="sd">        stats: (dict), dict of statistics to be included with a plot</span>

<span class="sd">        x_align: (float), float denoting x position of where to align display of stats on a plot</span>

<span class="sd">        y_align: (float), float denoting y position of where to align display of stats on a plot</span>

<span class="sd">        font_dict: (dict), dict of matplotlib font options to alter display of stats on plot</span>

<span class="sd">        fontsize: (int), the fontsize of stats to display on plot</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">stat_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stat_to_string</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">nice_names</span><span class="o">=</span><span class="n">nice_names</span><span class="p">())</span>
                           <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x_align</span><span class="p">,</span> <span class="n">y_align</span><span class="p">,</span> <span class="n">stat_str</span><span class="p">,</span>
             <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">font_dict</span><span class="p">,</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">FontProperties</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">))</span></div>

<div class="viewcode-block" id="make_fig_ax"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.make_fig_ax">[docs]</a><span class="k">def</span> <span class="nf">make_fig_ax</span><span class="p">(</span><span class="n">aspect_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">x_align</span><span class="o">=</span><span class="mf">0.65</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="mf">0.10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to make matplotlib figure and axes objects. Using Object Oriented interface from https://matplotlib.org/gallery/api/agg_oo_sgskip.html</span>

<span class="sd">    Args:</span>

<span class="sd">        aspect_ratio: (float), aspect ratio for figure and axes creation</span>

<span class="sd">        x_align: (float), x position to draw edge of figure. Needed so can display stats alongside plot</span>

<span class="sd">        left: (float), the leftmost position to draw edge of figure</span>

<span class="sd">    Returns:</span>

<span class="sd">        fig: (matplotlib fig object), a matplotlib figure object with the specified aspect ratio</span>

<span class="sd">        ax: (matplotlib ax object), a matplotlib axes object with the specified aspect ratio</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set image aspect ratio:</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">figaspect</span><span class="p">(</span><span class="n">aspect_ratio</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">))</span>
    <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="c1"># Set custom positioning, see this guide for more details:</span>
    <span class="c1"># https://python4astronomers.github.io/plotting/advanced.html</span>
    <span class="c1">#left   = 0.10</span>
    <span class="n">bottom</span> <span class="o">=</span> <span class="mf">0.15</span>
    <span class="n">right</span>  <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">top</span>    <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">x_align</span> <span class="o">-</span> <span class="n">left</span> <span class="o">-</span> <span class="n">right</span>
    <span class="n">height</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">bottom</span> <span class="o">-</span> <span class="n">top</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">((</span><span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_tight_layout</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="make_fig_ax_square"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.make_fig_ax_square">[docs]</a><span class="k">def</span> <span class="nf">make_fig_ax_square</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">aspect_ratio</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to make square shaped matplotlib figure and axes objects. Using Object Oriented interface from</span>

<span class="sd">    https://matplotlib.org/gallery/api/agg_oo_sgskip.html</span>

<span class="sd">    Args:</span>

<span class="sd">        aspect: (str), &#39;equal&#39; denotes x and y aspect will be equal (i.e. square)</span>

<span class="sd">        aspect_ratio: (float), aspect ratio for figure and axes creation</span>

<span class="sd">    Returns:</span>

<span class="sd">        fig: (matplotlib fig object), a matplotlib figure object with the specified aspect ratio</span>

<span class="sd">        ax: (matplotlib ax object), a matplotlib axes object with the specified aspect ratio</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set image aspect ratio:</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">figaspect</span><span class="p">(</span><span class="n">aspect_ratio</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">))</span>
    <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="n">aspect</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="make_axis_same"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.make_axis_same">[docs]</a><span class="k">def</span> <span class="nf">make_axis_same</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">max1</span><span class="p">,</span> <span class="n">min1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to make the x and y ticks for each axis the same. Useful for parity plots</span>

<span class="sd">    Args:</span>

<span class="sd">        ax: (matplotlib axis object), a matplotlib axes object</span>

<span class="sd">        max1: (float), the maximum value of a particular axis</span>

<span class="sd">        min1: (float), the minimum value of a particular axis</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">max1</span> <span class="o">-</span> <span class="n">min1</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">min1</span><span class="p">))</span> <span class="o">//</span> <span class="mi">3</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">min1</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">max1</span><span class="p">)</span><span class="o">+</span><span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min1</span><span class="p">,</span> <span class="n">max1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span></div>

<div class="viewcode-block" id="nice_mean"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.nice_mean">[docs]</a><span class="k">def</span> <span class="nf">nice_mean</span><span class="p">(</span><span class="n">ls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to return mean of a list or equivalent array with NaN values</span>

<span class="sd">    Args:</span>

<span class="sd">        ls: (list), list of values</span>

<span class="sd">    Returns:</span>

<span class="sd">        (numpy array), array containing mean of list of values or NaN if list has no values</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>

<div class="viewcode-block" id="nice_std"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.nice_std">[docs]</a><span class="k">def</span> <span class="nf">nice_std</span><span class="p">(</span><span class="n">ls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to return standard deviation of a list or equivalent array with NaN values</span>

<span class="sd">    Args:</span>

<span class="sd">        ls: (list), list of values</span>

<span class="sd">    Returns:</span>

<span class="sd">        (numpy array), array containing standard deviation of list of values or NaN if list has no values</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>

<div class="viewcode-block" id="round_down"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.round_down">[docs]</a><span class="k">def</span> <span class="nf">round_down</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">divisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to return a rounded down number</span>

<span class="sd">    Args:</span>

<span class="sd">        num: (float), a number to round down</span>

<span class="sd">        divisor: (int), divisor to denote how to round down</span>

<span class="sd">    Returns:</span>

<span class="sd">        (float), the rounded-down number</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">num</span> <span class="o">-</span> <span class="p">(</span><span class="n">num</span><span class="o">%</span><span class="n">divisor</span><span class="p">)</span></div>

<div class="viewcode-block" id="round_up"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.round_up">[docs]</a><span class="k">def</span> <span class="nf">round_up</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">divisor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to return a rounded up number</span>

<span class="sd">    Args:</span>

<span class="sd">        num: (float), a number to round up</span>

<span class="sd">        divisor: (int), divisor to denote how to round up</span>

<span class="sd">    Returns:</span>

<span class="sd">        (float), the rounded-up number</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">divisor</span><span class="p">))</span> <span class="o">*</span> <span class="n">divisor</span></div>

<div class="viewcode-block" id="get_divisor"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.get_divisor">[docs]</a><span class="k">def</span> <span class="nf">get_divisor</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to obtain a sensible divisor based on range of two values</span>

<span class="sd">    Args:</span>

<span class="sd">        high: (float), a max data value</span>

<span class="sd">        low: (float), a min data value</span>

<span class="sd">    Returns:</span>

<span class="sd">        divisor: (float), a number used to make sensible axis ticks</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">high</span><span class="o">-</span><span class="n">low</span>
    <span class="n">divisor</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">divisor</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">divisor</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">divisor</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">divisor</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
                        <span class="n">divisor</span> <span class="o">=</span> <span class="mf">0.001</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">divisor</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="k">return</span> <span class="n">divisor</span></div>

<div class="viewcode-block" id="recursive_max"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.recursive_max">[docs]</a><span class="k">def</span> <span class="nf">recursive_max</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to recursively find the max value of an array of iterables.</span>

<span class="sd">    Credit: https://www.linkedin.com/pulse/ask-recursion-during-coding-interviews-identify-good-talent-veteanu/</span>

<span class="sd">    Args:</span>

<span class="sd">        arr: (numpy array), an array of values or iterables</span>

<span class="sd">    Returns:</span>

<span class="sd">        (float), max value in arr</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span>
        <span class="n">recursive_max</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="k">else</span> <span class="n">e</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">arr</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="recursive_min"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.recursive_min">[docs]</a><span class="k">def</span> <span class="nf">recursive_min</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to recursively find the min value of an array of iterables.</span>

<span class="sd">    Credit: https://www.linkedin.com/pulse/ask-recursion-during-coding-interviews-identify-good-talent-veteanu/</span>

<span class="sd">    Args:</span>

<span class="sd">        arr: (numpy array), an array of values or iterables</span>

<span class="sd">    Returns:</span>

<span class="sd">        (float), min value in arr</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span>
        <span class="n">recursive_min</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="k">else</span> <span class="n">e</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">arr</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="recursive_max_and_min"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.recursive_max_and_min">[docs]</a><span class="k">def</span> <span class="nf">recursive_max_and_min</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to recursively return max and min of values or iterables in array</span>

<span class="sd">    Args:</span>

<span class="sd">        arr: (numpy array), an array of values or iterables</span>

<span class="sd">    Returns:</span>

<span class="sd">        (tuple), tuple containing max and min of arr</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">recursive_max</span><span class="p">(</span><span class="n">arr</span><span class="p">),</span> <span class="n">recursive_min</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span></div>

<div class="viewcode-block" id="_set_tick_labels"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper._set_tick_labels">[docs]</a><span class="k">def</span> <span class="nf">_set_tick_labels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">minn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method that sets the x and y ticks to be in the same range</span>

<span class="sd">    Args:</span>

<span class="sd">        ax: (matplotlib axes object), a matplotlib axes object</span>

<span class="sd">        maxx: (float), a maximum value</span>

<span class="sd">        minn: (float), a minimum value</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_set_tick_labels_different</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">minn</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">minn</span><span class="p">)</span> <span class="c1"># I love it when this happens</span></div>

<div class="viewcode-block" id="_set_tick_labels_different"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper._set_tick_labels_different">[docs]</a><span class="k">def</span> <span class="nf">_set_tick_labels_different</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">max_tick_x</span><span class="p">,</span> <span class="n">min_tick_x</span><span class="p">,</span> <span class="n">max_tick_y</span><span class="p">,</span> <span class="n">min_tick_y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method that sets the x and y ticks, when the axes have different ranges</span>

<span class="sd">    Args:</span>

<span class="sd">        ax: (matplotlib axes object), a matplotlib axes object</span>

<span class="sd">        max_tick_x: (float), the maximum tick value for the x axis</span>

<span class="sd">        min_tick_x: (float), the minimum tick value for the x axis</span>

<span class="sd">        max_tick_y: (float), the maximum tick value for the y axis</span>

<span class="sd">        min_tick_y: (float), the minimum tick value for the y axis</span>

<span class="sd">    Returns:</span>

<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tickvals_x</span> <span class="o">=</span> <span class="n">nice_range</span><span class="p">(</span><span class="n">min_tick_x</span><span class="p">,</span> <span class="n">max_tick_x</span><span class="p">)</span>
    <span class="n">tickvals_y</span> <span class="o">=</span> <span class="n">nice_range</span><span class="p">(</span><span class="n">min_tick_y</span><span class="p">,</span> <span class="n">max_tick_y</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tickvals_x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">tickvals_x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tickvals_x</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tickvals_x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tickvals_x</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">tickvals_x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tickvals_x</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">]:</span>
        <span class="n">tickvals_x</span> <span class="o">=</span> <span class="n">tickvals_x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">tickvals_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">tickvals_y</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tickvals_y</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tickvals_y</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tickvals_y</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">tickvals_y</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tickvals_y</span><span class="p">)</span><span class="o">-</span><span class="mi">4</span><span class="p">]:</span>
        <span class="n">tickvals_y</span> <span class="o">=</span> <span class="n">tickvals_y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1">#tickvals_x = _clean_tick_labels(tickvals=tickvals_x, delta=max_tick_x-min_tick_x)</span>
    <span class="c1">#tickvals_y = _clean_tick_labels(tickvals=tickvals_y, delta=max_tick_y - min_tick_y)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">tickvals_x</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">tickvals_y</span><span class="p">)</span>

    <span class="n">ticklabels_x</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">tickvals_x</span><span class="p">]</span>
    <span class="n">ticklabels_y</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">tickvals_y</span><span class="p">]</span>

    <span class="n">rotation</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Look at length of x tick labels to see if may be possibly crowded. If so, rotate labels</span>
    <span class="n">tick_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tickvals_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">tick_length</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="mi">45</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">ticklabels_x</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">rotation</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">ticklabels_y</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span></div>

<div class="viewcode-block" id="_clean_tick_labels"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper._clean_tick_labels">[docs]</a><span class="k">def</span> <span class="nf">_clean_tick_labels</span><span class="p">(</span><span class="n">tickvals</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to attempt to clean up axis tick values so they don&#39;t overlap from being too dense</span>

<span class="sd">    Args:</span>

<span class="sd">        tickvals: (list), a list containing the initial axis tick values</span>

<span class="sd">        delta: (float), number representing the numerical difference of two ticks</span>

<span class="sd">    Returns:</span>

<span class="sd">        tickvals_clean: (list), a list containing the updated axis tick values</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tickvals_clean</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tickvals</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tickvals</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tickvals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">tickvals</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">tickvals_clean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tickvals_clean</span> <span class="o">=</span> <span class="n">tickvals</span>
    <span class="k">return</span> <span class="n">tickvals_clean</span></div>

<span class="c1">## Math utilities to aid plot_helper to make ranges</span>

<div class="viewcode-block" id="nice_range"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper.nice_range">[docs]</a><span class="k">def</span> <span class="nf">nice_range</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to create a range of values, including the specified start and end points, with nicely spaced intervals</span>

<span class="sd">    Args:</span>

<span class="sd">        lower: (float or int), lower bound of range to create</span>

<span class="sd">        upper: (float or int), upper bound of range to create</span>

<span class="sd">    Returns:</span>

<span class="sd">        (list), list of numerical values in established range</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">flipped</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># set to -1 for inverted</span>

    <span class="c1"># Case for validation where nan is passed in</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">lower</span><span class="p">):</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">upper</span><span class="p">):</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="k">if</span> <span class="n">upper</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">:</span>
        <span class="n">upper</span><span class="p">,</span> <span class="n">lower</span> <span class="o">=</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span>
        <span class="n">flipped</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">_int_if_int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_nice_range_helper</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)][::</span><span class="n">flipped</span><span class="p">]</span></div>

<div class="viewcode-block" id="_nice_range_helper"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper._nice_range_helper">[docs]</a><span class="k">def</span> <span class="nf">_nice_range_helper</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to help make a better range of axis ticks</span>

<span class="sd">    Args:</span>

<span class="sd">        lower: (float), lower value of axis ticks</span>

<span class="sd">        upper: (float), upper value of axis ticks</span>

<span class="sd">    Returns:</span>

<span class="sd">        upper: (float), modified upper tick value fixed based on set of axis ticks</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lower</span> <span class="o">-</span> <span class="n">upper</span><span class="p">)</span>

    <span class="c1"># special case where lower and upper are the same</span>
    <span class="k">if</span> <span class="n">diff</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">lower</span><span class="p">,]</span>

    <span class="c1"># the exact step needed</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">/</span> <span class="n">steps</span>

    <span class="c1"># a rough estimate of best step</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">_nearest_pow_ten</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="c1"># whole decimal increments</span>

    <span class="c1"># tune in one the best step size</span>
    <span class="n">factors</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>

    <span class="c1"># use this to minimize how far we are from ideal step size</span>
    <span class="k">def</span> <span class="nf">best_one</span><span class="p">(</span><span class="n">steps_factor</span><span class="p">):</span>
        <span class="n">steps_count</span><span class="p">,</span> <span class="n">factor</span> <span class="o">=</span> <span class="n">steps_factor</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">steps_count</span> <span class="o">-</span> <span class="n">steps</span><span class="p">)</span>
    <span class="n">n_steps</span><span class="p">,</span> <span class="n">best_factor</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([(</span><span class="n">diff</span> <span class="o">/</span> <span class="p">(</span><span class="n">step</span> <span class="o">*</span> <span class="n">f</span><span class="p">),</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">factors</span><span class="p">],</span> <span class="n">key</span> <span class="o">=</span> <span class="n">best_one</span><span class="p">)</span>

    <span class="c1">#print(&#39;should see n steps&#39;, ceil(n_steps + 2))</span>
    <span class="c1"># multiply in the optimal factor for getting as close to ten steps as we can</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">step</span> <span class="o">*</span> <span class="n">best_factor</span>

    <span class="c1"># make the bounds look nice</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">_three_sigfigs</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">_three_sigfigs</span><span class="p">(</span><span class="n">upper</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">_round_up</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

    <span class="c1"># prepare for iteration</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">start</span> <span class="c1"># pointless init</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># itereate until we reach upper</span>
    <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">upper</span> <span class="o">-</span> <span class="n">step</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">step</span>
        <span class="k">yield</span> <span class="n">_three_sigfigs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="c1"># using sigfigs because of floating point error</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># finish off with ending bound</span>
    <span class="k">yield</span> <span class="n">upper</span></div>

<div class="viewcode-block" id="_three_sigfigs"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper._three_sigfigs">[docs]</a><span class="k">def</span> <span class="nf">_three_sigfigs</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method invoking special case of _n_sigfigs to return 3 sig figs</span>

<span class="sd">    Args:</span>

<span class="sd">        x: (float), an axis tick number</span>

<span class="sd">    Returns:</span>

<span class="sd">        (float), number of sig figs (always 3)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_n_sigfigs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span></div>

<div class="viewcode-block" id="_n_sigfigs"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper._n_sigfigs">[docs]</a><span class="k">def</span> <span class="nf">_n_sigfigs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to return number of sig figs to use for axis ticks</span>

<span class="sd">    Args:</span>

<span class="sd">        x: (float), an axis tick number</span>

<span class="sd">    Returns:</span>

<span class="sd">        (float), number of sig figs</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># case for negatives</span>
        <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="nb">round</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">round</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">sign</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span></div>

<div class="viewcode-block" id="_nearest_pow_ten"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper._nearest_pow_ten">[docs]</a><span class="k">def</span> <span class="nf">_nearest_pow_ten</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to return the nearest power of ten for an axis tick value</span>

<span class="sd">    Args:</span>

<span class="sd">        x: (float), an axis tick number</span>

<span class="sd">    Returns:</span>

<span class="sd">        (float), nearest power of ten of x</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># case for negatives</span>
        <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="n">sign</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">ceil</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span></div>

<div class="viewcode-block" id="_int_if_int"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper._int_if_int">[docs]</a><span class="k">def</span> <span class="nf">_int_if_int</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to return integer mapped value of x</span>

<span class="sd">    Args:</span>

<span class="sd">        x: (float or int), a number</span>

<span class="sd">    Returns:</span>

<span class="sd">        x: (float), value of x mapped as integer</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">x</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="_round_up"><a class="viewcode-back" href="../12_plot_helper.html#plot_helper._round_up">[docs]</a><span class="k">def</span> <span class="nf">_round_up</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">inc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Method to round up the value of x</span>

<span class="sd">    Args:</span>

<span class="sd">        x: (float or int), a number</span>

<span class="sd">        inc: (float), an increment for axis ticks</span>

<span class="sd">    Returns:</span>

<span class="sd">        (float), value of x rounded up</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># case for negative</span>
        <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">inc</span> <span class="o">*</span> <span class="n">ceil</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">inc</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">nice_names</span><span class="p">():</span>
    <span class="n">nice_names</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># classification:</span>
    <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span>
    <span class="s1">&#39;f1_binary&#39;</span><span class="p">:</span> <span class="s1">&#39;$F_1$&#39;</span><span class="p">,</span>
    <span class="s1">&#39;f1_macro&#39;</span><span class="p">:</span> <span class="s1">&#39;f1_macro&#39;</span><span class="p">,</span>
    <span class="s1">&#39;f1_micro&#39;</span><span class="p">:</span> <span class="s1">&#39;f1_micro&#39;</span><span class="p">,</span>
    <span class="s1">&#39;f1_samples&#39;</span><span class="p">:</span> <span class="s1">&#39;f1_samples&#39;</span><span class="p">,</span>
    <span class="s1">&#39;f1_weighted&#39;</span><span class="p">:</span> <span class="s1">&#39;f1_weighted&#39;</span><span class="p">,</span>
    <span class="s1">&#39;log_loss&#39;</span><span class="p">:</span> <span class="s1">&#39;log_loss&#39;</span><span class="p">,</span>
    <span class="s1">&#39;precision_binary&#39;</span><span class="p">:</span> <span class="s1">&#39;Precision&#39;</span><span class="p">,</span>
    <span class="s1">&#39;precision_macro&#39;</span><span class="p">:</span> <span class="s1">&#39;prec_macro&#39;</span><span class="p">,</span>
    <span class="s1">&#39;precision_micro&#39;</span><span class="p">:</span> <span class="s1">&#39;prec_micro&#39;</span><span class="p">,</span>
    <span class="s1">&#39;precision_samples&#39;</span><span class="p">:</span> <span class="s1">&#39;prec_samples&#39;</span><span class="p">,</span>
    <span class="s1">&#39;precision_weighted&#39;</span><span class="p">:</span> <span class="s1">&#39;prec_weighted&#39;</span><span class="p">,</span>
    <span class="s1">&#39;recall_binary&#39;</span><span class="p">:</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span>
    <span class="s1">&#39;recall_macro&#39;</span><span class="p">:</span> <span class="s1">&#39;rcl_macro&#39;</span><span class="p">,</span>
    <span class="s1">&#39;recall_micro&#39;</span><span class="p">:</span> <span class="s1">&#39;rcl_micro&#39;</span><span class="p">,</span>
    <span class="s1">&#39;recall_samples&#39;</span><span class="p">:</span> <span class="s1">&#39;rcl_samples&#39;</span><span class="p">,</span>
    <span class="s1">&#39;recall_weighted&#39;</span><span class="p">:</span> <span class="s1">&#39;rcl_weighted&#39;</span><span class="p">,</span>
    <span class="s1">&#39;roc_auc&#39;</span><span class="p">:</span> <span class="s1">&#39;ROC_AUC&#39;</span><span class="p">,</span>
    <span class="c1"># regression:</span>
    <span class="s1">&#39;explained_variance&#39;</span><span class="p">:</span> <span class="s1">&#39;expl_var&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mean_absolute_error&#39;</span><span class="p">:</span> <span class="s1">&#39;MAE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mean_squared_error&#39;</span><span class="p">:</span> <span class="s1">&#39;MSE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mean_squared_log_error&#39;</span><span class="p">:</span> <span class="s1">&#39;MSLE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;median_absolute_error&#39;</span><span class="p">:</span> <span class="s1">&#39;MedAE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;root_mean_squared_error&#39;</span><span class="p">:</span> <span class="s1">&#39;RMSE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rmse_over_stdev&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;RMSE/$\sigma_y$&#39;</span><span class="p">,</span>
    <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="s1">&#39;$R^2$&#39;</span><span class="p">,</span>
    <span class="s1">&#39;R2_noint&#39;</span><span class="p">:</span> <span class="s1">&#39;$R^2_</span><span class="si">{noint}</span><span class="s1">$&#39;</span><span class="p">,</span>
    <span class="s1">&#39;R2_adjusted&#39;</span><span class="p">:</span> <span class="s1">&#39;$R^2_</span><span class="si">{adjusted}</span><span class="s1">$&#39;</span><span class="p">,</span>
    <span class="s1">&#39;R2_fitted&#39;</span><span class="p">:</span> <span class="s1">&#39;$R^2_</span><span class="si">{fitted}</span><span class="s1">$&#39;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">nice_names</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, University of Wisconsin-Madison Computational Materials Group

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>